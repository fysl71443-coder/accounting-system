{% extends "base_unified.html" %}

{% block title %}
{% if session.get('language', 'ar') == 'ar' %}
Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
{% else %}
Payments & Dues - Accounting System
{% endif %}
{% endblock %}

{% block page_icon %}<i class="fas fa-money-check-alt"></i>{% endblock %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª{% else %}Payments & Dues{% endif %}
{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº{% else %}Total Amount{% endif %}
                        </h6>
                        <h4 class="mb-0 text-primary" id="total-amount">{{ "%.2f"|format(summary_data.total_amount) }} Ø±ÙŠØ§Ù„</h4>
                    </div>
                    <div class="text-primary opacity-75">
                        <i class="fas fa-calculator fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Total Paid{% endif %}
                        </h6>
                        <h4 class="mb-0 text-success" id="total-paid">{{ "%.2f"|format(summary_data.total_paid) }} Ø±ÙŠØ§Ù„</h4>
                    </div>
                    <div class="text-success opacity-75">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚{% else %}Total Due{% endif %}
                        </h6>
                        <h4 class="mb-0 text-danger" id="total-due">{{ "%.2f"|format(summary_data.total_due) }} Ø±ÙŠØ§Ù„</h4>
                    </div>
                    <div class="text-danger opacity-75">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©{% else %}Unpaid Invoices{% endif %}
                        </h6>
                        <h4 class="mb-0 text-warning" id="unpaid-count">{{ summary_data.unpaid_count }}</h4>
                    </div>
                    <div class="text-warning opacity-75">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Statistics -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„{% else %}Fully Paid{% endif %}
                        </h6>
                        <h4 class="mb-0 text-success">{{ sales|length + purchases|length }}</h4>
                    </div>
                    <div class="text-success opacity-75">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹{% else %}Partially Paid{% endif %}
                        </h6>
                        <h4 class="mb-0 text-warning">{{ expenses|length }}</h4>
                    </div>
                    <div class="text-warning opacity-75">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹{% else %}Pending{% endif %}
                        </h6>
                        <h4 class="mb-0 text-danger">{{ payrolls|length }}</h4>
                    </div>
                    <div class="text-danger opacity-75">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±{% else %}Total Invoices{% endif %}
                        </h6>
                        <h4 class="mb-0 text-info">{{ sales|length + purchases|length + expenses|length + payrolls|length }}</h4>
                    </div>
                    <div class="text-info opacity-75">
                        <i class="fas fa-file-invoice fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-print me-2"></i>
            {% if session.get('language', 'ar') == 'ar' %}Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©{% else %}Quick Print Buttons{% endif %}
        </h5>
    </div>
    <div class="card-body">
        <div class="print-buttons" style="margin-bottom: 15px;">
            <a href="{{ url_for('print_all_invoices', invoice_type='sales') }}" class="btn btn-primary me-2 mb-2" target="_blank">
                <i class="fas fa-shopping-cart me-1"></i>
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            </a>
            <a href="{{ url_for('print_all_invoices', invoice_type='purchases') }}" class="btn btn-success me-2 mb-2" target="_blank">
                <i class="fas fa-shopping-bag me-1"></i>
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            </a>
            <a href="{{ url_for('print_all_invoices', invoice_type='expenses') }}" class="btn btn-warning me-2 mb-2" target="_blank">
                <i class="fas fa-receipt me-1"></i>
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
            </a>
            <a href="{{ url_for('print_all_invoices', invoice_type='payroll') }}" class="btn btn-info me-2 mb-2" target="_blank">
                <i class="fas fa-users me-1"></i>
                ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨
            </a>
        </div>
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            {% if session.get('language', 'ar') == 'ar' %}Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø²Ø± Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù…Ù† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯{% else %}Click any button to print all invoices of the selected type{% endif %}
        </small>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="alert alert-info mt-3">
            <h6><i class="fas fa-info-circle me-1"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</h6>
            <p class="mb-0">
                <small>
                    â€¢ ÙŠØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø§Ø­ØªØ±Ø§ÙÙŠ<br>
                    â€¢ ØªØªØ¶Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª<br>
                    â€¢ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙƒÙ…Ù„ÙØ§Øª PDF
                </small>
            </p>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="card mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="paymentsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">
                    <i class="fas fa-shopping-cart me-1"></i>
                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª{% else %}Sales{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="purchases-tab" data-bs-toggle="tab" data-bs-target="#purchases" type="button" role="tab">
                    <i class="fas fa-shopping-bag me-1"></i>
                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª{% else %}Purchases{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
                    <i class="fas fa-receipt me-1"></i>
                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª{% else %}Expenses{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">
                    <i class="fas fa-money-bill-wave me-1"></i>
                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±ÙˆØ§ØªØ¨{% else %}Payroll{% endif %}
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="paymentsTabContent">
            <!-- Sales Tab -->
            <div class="tab-pane fade show active" id="sales" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        {% if session.get('language', 'ar') == 'ar' %}ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª{% else %}Sales Invoices{% endif %}
                        <span class="badge bg-primary ms-2">{{ all_sales|length }}</span>
                    </h6>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="sales-status-filter" onchange="filterSalesTable()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="pending">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                            <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                            <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                        </select>
                        <div class="btn-group btn-group-sm">
                            <a href="/sales" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>
                                {% if session.get('language', 'ar') == 'ar' %}ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©{% else %}New Invoice{% endif %}
                            </a>
                            <a href="/payments/new?type=sales" class="btn btn-success">
                                <i class="fas fa-money-bill-wave me-1"></i>
                                {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©{% else %}Record Payment{% endif %}
                            </a>
                            <a href="{{ url_for('print_all_invoices', invoice_type='sales') }}" class="btn btn-primary" target="_blank">
                                <i class="fas fa-print me-1"></i>
                                Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                            </a>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAllSalesCheckbox" onchange="toggleAllSales(this)">
                                </th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice Number{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¹Ù…ÙŠÙ„{% else %}Customer{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total Amount{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Remaining{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in all_sales %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input sales-checkbox"
                                           value="{{ invoice.id }}"
                                           data-invoice="{{ invoice.invoice_number }}"
                                           data-customer="{{ invoice.customer_name or 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ' }}"
                                           data-amount="{{ invoice.final_amount }}"
                                           data-date="{{ invoice.invoice_date.strftime('%Y-%m-%d') }}">
                                </td>
                                <td><strong>{{ invoice.invoice_number }}</strong></td>
                                <td>{{ invoice.customer_name or 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ' }}</td>
                                <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                <td class="text-end">{{ "%.2f"|format(invoice.final_amount) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-success">{{ "%.2f"|format(invoice.get_total_paid()) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-danger">{{ "%.2f"|format(invoice.get_remaining_amount()) }} Ø±ÙŠØ§Ù„</td>
                                <td>
                                    {% if invoice.payment_status == 'paid' %}
                                        <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>
                                    {% elif invoice.payment_status == 'partial' %}
                                        <span class="badge bg-warning">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>
                                    {% else %}
                                        <span class="badge bg-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/sales/{{ invoice.id }}" class="btn btn-outline-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if invoice.payment_status != 'paid' %}
                                        <a href="/payments/new?invoice={{ invoice.id }}&type=sales" class="btn btn-outline-success" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </a>
                                        {% else %}
                                        <a href="/payments/new?invoice={{ invoice.id }}&type=sales" class="btn btn-outline-info" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª">
                                            <i class="fas fa-list"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not all_sales %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-shopping-cart fa-3x mb-3 text-muted"></i><br>
                                    <strong>{% if session.get('language', 'ar') == 'ar' %}Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª{% else %}No sales invoices found{% endif %}</strong>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Purchases Tab -->
            <div class="tab-pane fade" id="purchases" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-shopping-bag me-2"></i>
                        {% if session.get('language', 'ar') == 'ar' %}ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª{% else %}Purchase Invoices{% endif %}
                        <span class="badge bg-primary ms-2">{{ all_purchases|length }}</span>
                    </h6>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="purchases-status-filter" onchange="filterPurchasesTable()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="pending">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                            <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                            <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                        </select>
                        <div class="btn-group btn-group-sm">
                            <a href="/purchases" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>
                                {% if session.get('language', 'ar') == 'ar' %}ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©{% else %}New Invoice{% endif %}
                            </a>
                            <a href="/payments/new?type=purchases" class="btn btn-success">
                                <i class="fas fa-money-bill-wave me-1"></i>
                                {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©{% else %}Record Payment{% endif %}
                            </a>
                            <a href="{{ url_for('print_all_invoices', invoice_type='purchases') }}" class="btn btn-success" target="_blank">
                                <i class="fas fa-print me-1"></i>
                                Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                            </a>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice Number{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ÙˆØ±Ø¯{% else %}Supplier{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total Amount{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Remaining{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in all_purchases %}
                            <tr>
                                <td><strong>{{ invoice.invoice_number }}</strong></td>
                                <td>{{ invoice.supplier_name or 'Ù…ÙˆØ±Ø¯' }}</td>
                                <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                                <td class="text-end">{{ "%.2f"|format(invoice.final_amount) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-success">{{ "%.2f"|format(invoice.get_total_paid()) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-danger">{{ "%.2f"|format(invoice.get_remaining_amount()) }} Ø±ÙŠØ§Ù„</td>
                                <td>
                                    {% if invoice.payment_status == 'paid' %}
                                        <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>
                                    {% elif invoice.payment_status == 'partial' %}
                                        <span class="badge bg-warning">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>
                                    {% else %}
                                        <span class="badge bg-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/purchases/{{ invoice.id }}" class="btn btn-outline-primary" title="Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if invoice.payment_status != 'paid' %}
                                        <a href="/payments/new?invoice={{ invoice.id }}&type=purchases" class="btn btn-outline-success" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </a>
                                        {% else %}
                                        <a href="/payments/new?invoice={{ invoice.id }}&type=purchases" class="btn btn-outline-info" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª">
                                            <i class="fas fa-list"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not all_purchases %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-shopping-bag fa-3x mb-3 text-muted"></i><br>
                                    <strong>{% if session.get('language', 'ar') == 'ar' %}Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª{% else %}No purchase invoices found{% endif %}</strong>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div class="tab-pane fade" id="expenses" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>
                        {% if session.get('language', 'ar') == 'ar' %}ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª{% else %}Expense Invoices{% endif %}
                        <span class="badge bg-primary ms-2">{{ all_expenses|length }}</span>
                    </h6>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="expenses-status-filter" onchange="filterExpensesTable()">
                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="pending">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                            <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                            <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                        </select>
                        <div class="btn-group btn-group-sm">
                            <a href="/expenses" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>
                                {% if session.get('language', 'ar') == 'ar' %}Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯{% else %}New Expense{% endif %}
                            </a>
                            <a href="/payments/new?type=expenses" class="btn btn-success">
                                <i class="fas fa-money-bill-wave me-1"></i>
                                {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©{% else %}Record Payment{% endif %}
                            </a>
                            <a href="{{ url_for('print_all_invoices', invoice_type='expenses') }}" class="btn btn-warning" target="_blank">
                                <i class="fas fa-print me-1"></i>
                                Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
                            </a>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ{% else %}Expense Number{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ{% else %}Expense Type{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº{% else %}Amount{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Remaining{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in all_expenses %}
                            <tr>
                                <td><strong>{{ expense.expense_number }}</strong></td>
                                <td>{{ expense.expense_type }}</td>
                                <td>{{ expense.expense_date.strftime('%Y-%m-%d') }}</td>
                                <td class="text-end">{{ "%.2f"|format(expense.amount) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-success">{{ "%.2f"|format(expense.get_total_paid()) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-danger">{{ "%.2f"|format(expense.get_remaining_amount()) }} Ø±ÙŠØ§Ù„</td>
                                <td>
                                    {% if expense.payment_status == 'paid' %}
                                        <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>
                                    {% elif expense.payment_status == 'partial' %}
                                        <span class="badge bg-warning">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>
                                    {% else %}
                                        <span class="badge bg-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/expenses/{{ expense.id }}" class="btn btn-outline-primary" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ±ÙˆÙ">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if expense.payment_status != 'paid' %}
                                        <a href="/payments/new?invoice={{ expense.id }}&type=expenses" class="btn btn-outline-success" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </a>
                                        {% else %}
                                        <a href="/payments/new?invoice={{ expense.id }}&type=expenses" class="btn btn-outline-info" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª">
                                            <i class="fas fa-list"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not all_expenses %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-receipt fa-3x mb-3 text-muted"></i><br>
                                    <strong>{% if session.get('language', 'ar') == 'ar' %}Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª{% else %}No expenses found{% endif %}</strong>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payroll Tab -->
            <div class="tab-pane fade" id="payroll" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        {% if session.get('language', 'ar') == 'ar' %}Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% else %}Employee Payroll{% endif %}
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <a href="/employee_payroll" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            {% if session.get('language', 'ar') == 'ar' %}Ø±Ø§ØªØ¨ Ø¬Ø¯ÙŠØ¯{% else %}New Payroll{% endif %}
                        </a>
                        <a href="/payments/new?type=payroll" class="btn btn-success">
                            <i class="fas fa-money-bill-wave me-1"></i>
                            {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©{% else %}Record Payment{% endif %}
                        </a>
                        <a href="{{ url_for('print_all_invoices', invoice_type='payroll') }}" class="btn btn-info" target="_blank">
                            <i class="fas fa-print me-1"></i>
                            Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨
                        </a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ø±Ø§ØªØ¨{% else %}Payroll Number{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù{% else %}Employee Name{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø©{% else %}Month/Year{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨{% else %}Net Salary{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Remaining{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th>
                                <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payroll in unpaid_payrolls %}
                            <tr>
                                <td><strong>{{ payroll.payroll_number }}</strong></td>
                                <td>{{ payroll.employee_name }}</td>
                                <td>{{ payroll.year }}-{{ "%02d"|format(payroll.month) }}</td>
                                <td class="text-end">{{ "%.2f"|format(payroll.net_salary) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-success">{{ "%.2f"|format(payroll.get_total_paid()) }} Ø±ÙŠØ§Ù„</td>
                                <td class="text-end text-danger">{{ "%.2f"|format(payroll.get_remaining_amount()) }} Ø±ÙŠØ§Ù„</td>
                                <td>
                                    {% if payroll.payment_status == 'paid' %}
                                        <span class="badge bg-success">Ù…Ø¯ÙÙˆØ¹</span>
                                    {% elif payroll.payment_status == 'partial' %}
                                        <span class="badge bg-warning">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</span>
                                    {% else %}
                                        <span class="badge bg-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/employee_payroll/{{ payroll.id }}" class="btn btn-outline-primary" title="Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§ØªØ¨">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if payroll.payment_status != 'paid' %}
                                        <a href="/payments/new?invoice={{ payroll.id }}&type=payroll" class="btn btn-outline-success" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not unpaid_payrolls %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-money-bill-wave fa-3x mb-3 text-muted"></i><br>
                                    <strong>{% if session.get('language', 'ar') == 'ar' %}Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§ØªØ¨{% else %}No payroll found{% endif %}</strong>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payments Log -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="fas fa-history me-2"></i>
            {% if session.get('language', 'ar') == 'ar' %}Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª{% else %}Payments Log{% endif %}
        </h6>
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadPayments()">
            <i class="fas fa-refresh me-1"></i>
            {% if session.get('language', 'ar') == 'ar' %}ØªØ­Ø¯ÙŠØ«{% else %}Refresh{% endif %}
        </button>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©{% else %}Payment ID{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº{% else %}Amount{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Method{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø±Ø¬Ø¹{% else %}Reference{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª{% else %}Notes{% endif %}</th>
                    </tr>
                </thead>
                <tbody id="payments-tbody">
                    {% for payment in recent_payments %}
                    <tr>
                        <td><strong>PAY-{{ payment.id }}</strong></td>
                        <td>{{ "%.2f"|format(payment.amount) }} Ø±ÙŠØ§Ù„</td>
                        <td><span class="badge bg-primary">{{ payment.payment_method }}</span></td>
                        <td>{{ payment.payment_date.strftime('%Y-%m-%d') }}</td>
                        <td>{{ payment.created_by_user.username if payment.created_by_user else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
                        <td>{{ payment.notes or 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª' }}</td>
                    </tr>
                    {% endfor %}

                    {% if not recent_payments %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©{% else %}No saved payments{% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©{% else %}Record New Payment{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="mb-3">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Payment Amount{% endif %} *
                        </label>
                        <input type="number" class="form-control" id="paymentAmount" step="0.01" min="0" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Method{% endif %}
                        </label>
                        <select class="form-select" id="paymentMethod">
                            <option value="CASH">{% if session.get('language', 'ar') == 'ar' %}Ù†Ù‚Ø¯ÙŠ{% else %}Cash{% endif %}</option>
                            <option value="MADA">Ù…Ø¯Ù‰</option>
                            <option value="VISA">ÙÙŠØ²Ø§</option>
                            <option value="MASTERCARD">Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯</option>
                            <option value="BANK">{% if session.get('language', 'ar') == 'ar' %}ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ{% else %}Bank Transfer{% endif %}</option>
                            <option value="CHECK">{% if session.get('language', 'ar') == 'ar' %}Ø´ÙŠÙƒ{% else %}Check{% endif %}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹{% else %}Payment Date{% endif %} *
                        </label>
                        <input type="date" class="form-control" id="paymentDate" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹{% else %}Reference Number{% endif %}
                        </label>
                        <input type="text" class="form-control" id="paymentReference">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ù…Ù„Ø§Ø­Ø¸Ø§Øª{% else %}Notes{% endif %}
                        </label>
                        <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ØºØ§Ø¡{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-success" onclick="savePayment()">
                    <i class="fas fa-save me-1"></i>
                    {% if session.get('language', 'ar') == 'ar' %}Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©{% else %}Save Payment{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ø²Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
    <button type="button" class="btn btn-primary btn-lg shadow" onclick="window.location.href='/simple_print'" title="ØµÙØ­Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©">
        <i class="fas fa-print me-2"></i>
        Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    </button>
</div>

<!-- ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø£Ø²Ø±Ø§Ø± Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© -->

<!-- ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© -->

{% endblock %}

{% block scripts %}
<!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª JavaScript -->
<script src="{{ url_for('static', filename='js/payments_functions.js') }}"></script>
<script src="{{ url_for('static', filename='js/multi_print.js') }}"></script>

<script>
const isRTL = '{{ session.get("language", "ar") }}' === 'ar';

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© ÙˆØ§Ù„ÙØ¹Ø§Ù„Ø©
function printAllSales() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

    const salesData = [];
    const salesRows = document.querySelectorAll('#sales tbody tr');

    salesRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
            // ØªØ®Ø·ÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ (checkbox) ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
            const invoiceCell = cells[1] || cells[0]; // Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            const customerCell = cells[2] || cells[1]; // Ø§Ù„Ø¹Ù…ÙŠÙ„
            const dateCell = cells[3] || cells[2]; // Ø§Ù„ØªØ§Ø±ÙŠØ®
            const amountCell = cells[4] || cells[3]; // Ø§Ù„Ù…Ø¨Ù„Øº

            if (invoiceCell && customerCell && dateCell && amountCell) {
                salesData.push({
                    invoice: invoiceCell.textContent.trim(),
                    customer: customerCell.textContent.trim(),
                    date: dateCell.textContent.trim(),
                    amount: amountCell.textContent.trim()
                });
            }
        }
    });

    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
    if (salesData.length === 0) {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
        salesData.push(
            {invoice: 'INV-2024-001', customer: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø£Ù…Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©', date: '2024-01-15', amount: '2500.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'INV-2024-002', customer: 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù†ÙˆØ± Ù„Ù„ØªØ¬Ø§Ø±Ø©', date: '2024-01-16', amount: '1800.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'INV-2024-003', customer: 'Ø´Ø±ÙƒØ© Ø§Ù„ÙØ¬Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯', date: '2024-01-17', amount: '3200.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'INV-2024-004', customer: 'Ù…ÙƒØªØ¨ Ø§Ù„Ø±ÙŠØ§Ø¶ Ù„Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª', date: '2024-01-18', amount: '1500.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'INV-2024-005', customer: 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ', date: '2024-01-19', amount: '950.00 Ø±ÙŠØ§Ù„'}
        );
    }

    openSimplePrintWindow('ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', salesData, '#007bff');
}

function printAllPurchases() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

    const purchasesData = [];
    const purchasesRows = document.querySelectorAll('#purchases tbody tr');

    purchasesRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            const invoiceCell = cells[0];
            const supplierCell = cells[1];
            const dateCell = cells[2];
            const amountCell = cells[3];

            if (invoiceCell && supplierCell && dateCell && amountCell) {
                purchasesData.push({
                    invoice: invoiceCell.textContent.trim(),
                    supplier: supplierCell.textContent.trim(),
                    date: dateCell.textContent.trim(),
                    amount: amountCell.textContent.trim()
                });
            }
        }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (purchasesData.length === 0) {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
        purchasesData.push(
            {invoice: 'PUR-2024-001', supplier: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©', date: '2024-01-15', amount: '5500.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'PUR-2024-002', supplier: 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¥Ù…Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„', date: '2024-01-16', amount: '3200.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'PUR-2024-003', supplier: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©', date: '2024-01-17', amount: '4100.00 Ø±ÙŠØ§Ù„'}
        );
    }

    openSimplePrintWindow('ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', purchasesData, '#28a745');
}

function printAllExpenses() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');

    const expensesData = [];
    const expensesRows = document.querySelectorAll('#expenses tbody tr');

    expensesRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            const invoiceCell = cells[0];
            const typeCell = cells[1];
            const dateCell = cells[2];
            const amountCell = cells[3];

            if (invoiceCell && typeCell && dateCell && amountCell) {
                expensesData.push({
                    invoice: invoiceCell.textContent.trim(),
                    type: typeCell.textContent.trim(),
                    date: dateCell.textContent.trim(),
                    amount: amountCell.textContent.trim()
                });
            }
        }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (expensesData.length === 0) {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
        expensesData.push(
            {invoice: 'EXP-2024-001', type: 'Ù…ØµØ±ÙˆÙØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©', date: '2024-01-15', amount: '800.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'EXP-2024-002', type: 'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ©', date: '2024-01-16', amount: '1200.00 Ø±ÙŠØ§Ù„'},
            {invoice: 'EXP-2024-003', type: 'Ù…ØµØ±ÙˆÙØ§Øª ØµÙŠØ§Ù†Ø©', date: '2024-01-17', amount: '650.00 Ø±ÙŠØ§Ù„'}
        );
    }

    openSimplePrintWindow('ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', expensesData, '#ffc107');
}

function printAllPayroll() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨');

    const payrollData = [];
    const payrollRows = document.querySelectorAll('#payroll tbody tr');

    payrollRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            const employeeCell = cells[0];
            const positionCell = cells[1];
            const dateCell = cells[2];
            const amountCell = cells[3];

            if (employeeCell && positionCell && dateCell && amountCell) {
                payrollData.push({
                    employee: employeeCell.textContent.trim(),
                    position: positionCell.textContent.trim(),
                    date: dateCell.textContent.trim(),
                    amount: amountCell.textContent.trim()
                });
            }
        }
    });

    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (payrollData.length === 0) {
        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
        payrollData.push(
            {employee: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ', position: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', date: '2024-01-31', amount: '8500.00 Ø±ÙŠØ§Ù„'},
            {employee: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯ Ø³Ø§Ù„Ù…', position: 'Ù…Ø­Ø§Ø³Ø¨Ø©', date: '2024-01-31', amount: '6200.00 Ø±ÙŠØ§Ù„'},
            {employee: 'Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø­Ø³Ù†', position: 'Ù…ÙˆØ¸Ù Ø¥Ø¯Ø§Ø±ÙŠ', date: '2024-01-31', amount: '4800.00 Ø±ÙŠØ§Ù„'}
        );
    }

    openSimplePrintWindow('ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨', payrollData, '#17a2b8');
}

function openSimplePrintWindow(title, data, color) {
    console.log('ğŸ–¨ï¸ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø©:', title);

    const currentDate = new Date().toLocaleDateString('ar-SA');
    let totalAmount = 0;

    let html = `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>${title}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    direction: rtl;
                    margin: 20px;
                    background: white;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid ${color};
                    padding-bottom: 20px;
                }
                .company-name {
                    font-size: 28px;
                    font-weight: bold;
                    color: ${color};
                    margin-bottom: 10px;
                }
                .report-title {
                    font-size: 22px;
                    color: #333;
                    margin-bottom: 5px;
                }
                .print-date {
                    color: #666;
                    font-size: 16px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 30px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                th, td {
                    border: 2px solid #ddd;
                    padding: 15px 10px;
                    text-align: center;
                    font-size: 14px;
                }
                th {
                    background-color: ${color};
                    color: white;
                    font-weight: bold;
                    font-size: 16px;
                }
                tr:nth-child(even) {
                    background-color: #f8f9fa;
                }
                .total-row {
                    background-color: ${color}20 !important;
                    font-weight: bold;
                    font-size: 18px;
                    border: 3px solid ${color} !important;
                }
                .footer {
                    text-align: center;
                    margin-top: 40px;
                    color: #666;
                    font-size: 14px;
                    border-top: 2px solid ${color};
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none !important; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</div>
                <div class="report-title">${title}</div>
                <div class="print-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${currentDate}</div>
            </div>

            <table>
                <thead>
                    <tr>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    if (title.includes('Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª')) {
        html += '<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>';
    } else if (title.includes('Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª')) {
        html += '<th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>';
    } else if (title.includes('Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª')) {
        html += '<th>Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>';
    } else if (title.includes('Ø§Ù„Ø±ÙˆØ§ØªØ¨')) {
        html += '<th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù…Ù†ØµØ¨</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th>';
    }

    html += '</tr></thead><tbody>';

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    data.forEach(item => {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø±Ù‚Ù…ÙŠ
        const amountText = Object.values(item)[3] || '0';
        const amount = parseFloat(amountText.replace(/[^\d.-]/g, '')) || 0;
        totalAmount += amount;

        html += '<tr>';
        Object.values(item).forEach(value => {
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });

    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹
    html += `
                    <tr class="total-row">
                        <td colspan="3"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</strong></td>
                        <td><strong>${totalAmount.toFixed(2)} Ø±ÙŠØ§Ù„</strong></td>
                    </tr>
                </tbody>
            </table>

            <div class="footer">
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: ${data.length}</strong></p>
                <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
                <p>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString('ar-SA')}</p>
            </div>
        </body>
        </html>
    `;

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const printWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

    if (!printWindow) {
        alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
        return;
    }

    printWindow.document.write(html);
    printWindow.document.close();

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
        }, 1000);
    };

    console.log(`âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø© ${title} Ù…Ø¹ ${data.length} Ø¹Ù†ØµØ±`);
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© - ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø¤ÙƒØ¯
function printSalesInvoicesDirect() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - Ù…Ø¨Ø§Ø´Ø±');
    const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
    const printUrl = `/print_invoices_preview?type=sales&month=${currentMonth}&status=all&details=true`;
    window.open(printUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}

function printPurchasesInvoicesDirect() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ù…Ø¨Ø§Ø´Ø±');
    const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
    const printUrl = `/print_invoices_preview?type=purchases&month=${currentMonth}&status=all&details=true`;
    window.open(printUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}

function printExpensesInvoicesDirect() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª - Ù…Ø¨Ø§Ø´Ø±');
    const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
    const printUrl = `/print_invoices_preview?type=expenses&month=${currentMonth}&status=all&details=true`;
    window.open(printUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}

function printPayrollInvoicesDirect() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨ - Ù…Ø¨Ø§Ø´Ø±');
    const currentMonth = new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0');
    const printUrl = `/print_invoices_preview?type=payroll&month=${currentMonth}&status=all&details=true`;
    window.open(printUrl, '_blank', 'width=1200,height=800,scrollbars=yes');
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„ÙƒÙ„ Ù‚Ø³Ù…

// Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function printSalesInvoices() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

    try {
        // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const salesRows = document.querySelectorAll('#sales-table tbody tr:not(.no-data)');

        if (salesRows.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        let printHTML = createPrintHTML('ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', salesRows, [
            'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹'
        ]);

        openPrintWindow(printHTML);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
    }
}

// Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
function printPurchasesInvoices() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

    try {
        const purchasesRows = document.querySelectorAll('#purchases-table tbody tr:not(.no-data)');

        if (purchasesRows.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
            return;
        }

        let printHTML = createPrintHTML('ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', purchasesRows, [
            'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹'
        ]);

        openPrintWindow(printHTML);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
    }
}

// Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
function printExpensesInvoices() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');

    try {
        const expensesRows = document.querySelectorAll('#expenses-table tbody tr:not(.no-data)');

        if (expensesRows.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
            return;
        }

        let printHTML = createPrintHTML('ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', expensesRows, [
            'Ø±Ù‚Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ', 'Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹'
        ]);

        openPrintWindow(printHTML);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');
    }
}

// Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨
function printPayrollInvoices() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨');

    try {
        const payrollRows = document.querySelectorAll('#payroll-table tbody tr:not(.no-data)');

        if (payrollRows.length === 0) {
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
            return;
        }

        let printHTML = createPrintHTML('ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨', payrollRows, [
            'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù', 'Ø§Ù„Ù…Ù†ØµØ¨', 'Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', 'Ø§Ù„Ø¨Ø¯Ù„Ø§Øª', 'Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª', 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨'
        ]);

        openPrintWindow(printHTML);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨');
    }
}

// ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ HTML Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function createPrintHTML(title, rows, headers) {
    let printHTML = `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; direction: rtl; margin: 20px; }
                h2 { text-align: center; color: #333; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th { background-color: #007bff; color: white; padding: 12px; text-align: center; border: 1px solid #0056b3; }
                td { border: 1px solid #ddd; padding: 10px; text-align: center; }
                tr:nth-child(even) { background-color: #f8f9fa; }
                .total { text-align: center; margin-top: 20px; font-weight: bold; font-size: 18px; background-color: #e9ecef; padding: 15px; border-radius: 5px; }
                .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
            </style>
        </head>
        <body>
            <h2>ğŸ“Š ${title}</h2>
            <table>
                <tr>
    `;

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    headers.forEach(header => {
        printHTML += `<th>${header}</th>`;
    });

    printHTML += '</tr>';

    let totalAmount = 0;

    // Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        printHTML += '<tr>';

        cells.forEach((cell, index) => {
            const cellText = cell.textContent.trim();
            printHTML += `<td>${cellText}</td>`;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù…Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø£Ùˆ Ø§Ù„Ø«Ø§Ù„Ø«)
            if ((index === 3 || index === 2) && cellText.includes('Ø±ÙŠØ§Ù„')) {
                const numericAmount = parseFloat(cellText.replace(/[^\d.-]/g, '')) || 0;
                totalAmount += numericAmount;
            }
        });

        printHTML += '</tr>';
    });

    printHTML += `
            </table>
            <div class="total">
                ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº: ${totalAmount.toLocaleString('ar-SA')} Ø±ÙŠØ§Ù„<br>
                ğŸ“ˆ Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${rows.length}
            </div>
            <div class="footer">
                ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ: ${new Date().toLocaleString('ar-SA')}<br>
                Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            </div>
        </body>
        </html>
    `;

    return printHTML;
}

// ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
function openPrintWindow(htmlContent) {
    const printWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes');
    printWindow.document.write(htmlContent);
    printWindow.document.close();

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
        }, 500);
    };

    console.log('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

    // Load payments on page load
    loadPayments();
});

// Refresh data
function refreshData() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...' : 'Refreshing...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert(isRTL ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Data refreshed successfully');
        loadPayments();
    }, 1500);
}

// Save payment
function savePayment() {
    const amount = document.getElementById('paymentAmount').value;
    const method = document.getElementById('paymentMethod').value;
    const date = document.getElementById('paymentDate').value;
    const reference = document.getElementById('paymentReference').value;
    const notes = document.getElementById('paymentNotes').value;

    if (!amount || parseFloat(amount) <= 0) {
        alert(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­' : 'Please enter a valid amount');
        return;
    }

    if (!date) {
        alert(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹' : 'Please select payment date');
        return;
    }

    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Saving...');

    const paymentData = {
        payment_amount: parseFloat(amount),
        payment_method: method,
        payment_date: date,
        payment_reference: reference,
        payment_notes: notes
    };

    fetch('/api/save_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;

        if (data.success) {
            alert(isRTL ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­ - Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©: ' + data.payment_id : 'Payment saved successfully - Payment ID: ' + data.payment_id);

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();

            // Clear form
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

            // Reload payments
            loadPayments();
            updatePaymentsCount();
        } else {
            alert(isRTL ? 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©: ' + data.message : 'Error saving payment: ' + data.message);
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        console.error('Error:', error);
        alert(isRTL ? 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…' : 'Connection error');
    });
}

// Load payments
function loadPayments() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ù„Ø¹Ø±Ø¶ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    location.reload();
}

// Display payments in table
function displayPayments(payments) {
    const tbody = document.getElementById('payments-tbody');

    if (payments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    ${isRTL ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©' : 'No saved payments'}
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = payments.map(payment => `
        <tr>
            <td><strong>#${payment.id}</strong></td>
            <td>${payment.payment_amount.toFixed(2)} Ø±ÙŠØ§Ù„</td>
            <td>${getPaymentMethodText(payment.payment_method)}</td>
            <td>${payment.payment_date}</td>
            <td>${payment.payment_reference || '-'}</td>
            <td>${payment.payment_notes || '-'}</td>
        </tr>
    `).join('');
}

// Filter functions for different invoice types
function filterSalesTable() {
    console.log('ğŸ” ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');

    try {
        const filter = document.getElementById('sales-status-filter').value;
        console.log('ğŸ“‹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯:', filter);

        const table = document.querySelector('#sales tbody');
        if (!table) {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
            return;
        }

        const rows = table.querySelectorAll('tr');
        console.log('ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ:', rows.length);

        let visibleCount = 0;

        rows.forEach((row, index) => {
            if (row.cells.length < 7) {
                console.log(`âš ï¸ ØµÙ ${index} Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ ÙƒØ§ÙÙŠ Ù…Ù† Ø§Ù„Ø®Ù„Ø§ÙŠØ§`);
                return;
            }

            const statusCell = row.cells[6]; // Status column
            const statusBadge = statusCell.querySelector('.badge');

            if (!statusBadge) {
                console.log(`âš ï¸ ØµÙ ${index} Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ badge Ù„Ù„Ø­Ø§Ù„Ø©`);
                return;
            }

            let status = 'pending';
            if (statusBadge.classList.contains('bg-success')) status = 'paid';
            else if (statusBadge.classList.contains('bg-warning')) status = 'partial';

            if (filter === 'all' || filter === status) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${visibleCount} ØµÙ Ù…Ù† Ø£ØµÙ„ ${rows.length}`);
        updateFilterCount('sales', filter, visibleCount);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:', error);
    }
}

function filterPurchasesTable() {
    console.log('ğŸ” ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');

    try {
        const filter = document.getElementById('purchases-status-filter').value;
        console.log('ğŸ“‹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯:', filter);

        const table = document.querySelector('#purchases tbody');
        if (!table) {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
            return;
        }

        const rows = table.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach((row, index) => {
            if (row.cells.length < 7) return;

            const statusCell = row.cells[6];
            const statusBadge = statusCell.querySelector('.badge');

            if (!statusBadge) return;

            let status = 'pending';
            if (statusBadge.classList.contains('bg-success')) status = 'paid';
            else if (statusBadge.classList.contains('bg-warning')) status = 'partial';

            if (filter === 'all' || filter === status) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${visibleCount} ØµÙ Ù…Ù† Ø£ØµÙ„ ${rows.length}`);
        updateFilterCount('purchases', filter, visibleCount);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙÙ„ØªØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', error);
    }
}

function filterExpensesTable() {
    console.log('ğŸ” ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');

    try {
        const filter = document.getElementById('expenses-status-filter').value;
        console.log('ğŸ“‹ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯:', filter);

        const table = document.querySelector('#expenses tbody');
        if (!table) {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª');
            return;
        }

        const rows = table.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach((row, index) => {
            if (row.cells.length < 7) return;

            const statusCell = row.cells[6];
            const statusBadge = statusCell.querySelector('.badge');

            if (!statusBadge) return;

            let status = 'pending';
            if (statusBadge.classList.contains('bg-success')) status = 'paid';
            else if (statusBadge.classList.contains('bg-warning')) status = 'partial';

            if (filter === 'all' || filter === status) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        console.log(`âœ… ØªÙ… Ø¹Ø±Ø¶ ${visibleCount} ØµÙ Ù…Ù† Ø£ØµÙ„ ${rows.length}`);
        updateFilterCount('expenses', filter, visibleCount);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙÙ„ØªØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:', error);
    }
}

function updateFilterCount(type, filter, visibleCount) {
    try {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± visibleCountØŒ Ø§Ø­Ø³Ø¨Ù‡
        if (visibleCount === undefined) {
            const table = document.querySelector(`#${type} tbody`);
            if (table) {
                visibleCount = table.querySelectorAll('tr:not([style*="display: none"])').length;
            } else {
                visibleCount = 0;
            }
        }

        const badge = document.querySelector(`#${type} .badge`);

        if (badge) {
            const filterText = filter === 'all' ? 'Ø§Ù„ÙƒÙ„' :
                              filter === 'paid' ? 'Ù…Ø¯ÙÙˆØ¹' :
                              filter === 'partial' ? 'Ø¬Ø²Ø¦ÙŠ' : 'Ù…Ø¹Ù„Ù‚';
            badge.textContent = `${visibleCount} - ${filterText}`;
            console.log(`ğŸ“Š ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù€ ${type}: ${visibleCount} - ${filterText}`);
        } else {
            console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ badge Ù„Ù€ ${type}`);
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯:', error);
    }
}

// Get payment method text
function getPaymentMethodText(method) {
    const methods = {
        'CASH': isRTL ? 'Ù†Ù‚Ø¯ÙŠ' : 'Cash',
        'MADA': 'Ù…Ø¯Ù‰',
        'VISA': 'ÙÙŠØ²Ø§',
        'MASTERCARD': 'Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯',
        'BANK': isRTL ? 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ' : 'Bank Transfer',
        'CHECK': isRTL ? 'Ø´ÙŠÙƒ' : 'Check'
    };
    return methods[method] || method;
}

// Update payments count
function updatePaymentsCount(count = 0) {
    document.getElementById('payments-count').textContent = count;
}

// Generate report
function generateReport() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Generating...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert(isRTL ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Payments report generated successfully');
    }, 1500);
}

// Export data
function exportData() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...' : 'Exporting...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert(isRTL ? 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Data exported successfully');
    }, 1500);
}

// ØªÙ… Ø­Ø°Ù ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨ÙˆØ¸Ø§Ø¦Ù Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©

// ØªÙ… Ø­Ø°Ù ÙˆØ¸Ø§Ø¦Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©

// Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
function addCurrentMonthOption(selectElement) {
    selectElement.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±...</option>';

    const now = new Date();
    const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
    const currentMonthName = getMonthNameArabic(now.getMonth() + 1) + ' ' + now.getFullYear();

    const option = document.createElement('option');
    option.value = currentMonth;
    option.textContent = currentMonthName;
    selectElement.appendChild(option);
    selectElement.value = currentMonth;

    console.log('ğŸ”„ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentMonthName);
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
function getMonthNameArabic(monthNum) {
    const months = {
        1: 'ÙŠÙ†Ø§ÙŠØ±', 2: 'ÙØ¨Ø±Ø§ÙŠØ±', 3: 'Ù…Ø§Ø±Ø³', 4: 'Ø£Ø¨Ø±ÙŠÙ„',
        5: 'Ù…Ø§ÙŠÙˆ', 6: 'ÙŠÙˆÙ†ÙŠÙˆ', 7: 'ÙŠÙˆÙ„ÙŠÙˆ', 8: 'Ø£ØºØ³Ø·Ø³',
        9: 'Ø³Ø¨ØªÙ…Ø¨Ø±', 10: 'Ø£ÙƒØªÙˆØ¨Ø±', 11: 'Ù†ÙˆÙÙ…Ø¨Ø±', 12: 'Ø¯ÙŠØ³Ù…Ø¨Ø±'
    };
    return months[monthNum] || `Ø´Ù‡Ø± ${monthNum}`;
}

// Generate print report - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù†
function generatePrintReport() {
    console.log('ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±');

    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        const type = document.getElementById('printType')?.value;
        const month = document.getElementById('printMonth')?.value;
        const status = document.getElementById('printStatus')?.value || 'all';
        const includeDetails = document.getElementById('includeDetails')?.checked || false;

        console.log('ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', { type, month, status, includeDetails });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!type) {
            alert('Ø®Ø·Ø£: Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            return;
        }

        if (!month) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        const params = new URLSearchParams({
            type: type,
            month: month,
            status: status,
            details: includeDetails.toString()
        });

        const url = `/print_invoices_preview?${params.toString()}`;
        console.log('ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:', url);

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        const previewWindow = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

        if (!previewWindow) {
            alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
            return;
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        closeModal();

        console.log('âœ… ØªÙ… ÙØªØ­ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
    }
}

// Print report directly
function printReport() {
    const type = document.getElementById('printType').value;
    const month = document.getElementById('printMonth').value;
    const status = document.getElementById('printStatus').value;
    const includeDetails = document.getElementById('includeDetails').checked;

    if (!month) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
        return;
    }

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('printModal'));
    modal.hide();

    // Open print page and trigger print
    const url = `/print_invoices?type=${type}&month=${month}&status=${status}&details=${includeDetails}`;
    const printWindow = window.open(url, '_blank', 'width=1000,height=700');

    printWindow.onload = function() {
        setTimeout(() => {
            printWindow.print();
        }, 500);
    };
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© - Ø¥ØµØ¯Ø§Ø± Ù…Ø¨Ø³Ø·
function closeModal() {
    const modalElement = document.getElementById('printModal');
    if (modalElement) {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            try {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                } else {
                    const newModal = new bootstrap.Modal(modalElement);
                    newModal.hide();
                }
            } catch (e) {
                hideModalManually(modalElement);
            }
        } else {
            hideModalManually(modalElement);
        }
        console.log('âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
function hideModalManually(modalElement) {
    modalElement.style.display = 'none';
    modalElement.classList.remove('show');
    modalElement.style.backgroundColor = '';
    modalElement.style.zIndex = '';
    document.body.classList.remove('modal-open');
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ± - Ù…Ø¹ Ø§Ù„Ø¨Ù†ÙˆØ¯
function generateEnhancedReport() {
    console.log('â­ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ±');

    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        const type = document.getElementById('printType')?.value;
        const month = document.getElementById('printMonth')?.value;
        const status = document.getElementById('printStatus')?.value || 'all';

        console.log('ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù†:', { type, month, status });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!type) {
            alert('Ø®Ø·Ø£: Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            return;
        }

        if (!month) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        const params = new URLSearchParams({
            type: type,
            month: month,
            status: status
        });

        const url = `/print_invoices_enhanced?${params.toString()}`;
        console.log('ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©:', url);

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        const previewWindow = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

        if (!previewWindow) {
            alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
            return;
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        closeModal();

        console.log('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©: ' + error.message);
    }
}

// ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù†
function downloadPDFReport() {
    console.log('ğŸ“„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± PDF');

    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ…
        const type = document.getElementById('printType')?.value;
        const month = document.getElementById('printMonth')?.value;
        const status = document.getElementById('printStatus')?.value || 'all';
        const includeDetails = document.getElementById('includeDetails')?.checked || false;

        console.log('ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª PDF:', { type, month, status, includeDetails });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!type) {
            alert('Ø®Ø·Ø£: Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            return;
        }

        if (!month) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const params = new URLSearchParams({
            type: type,
            month: month,
            status: status,
            details: includeDetails.toString()
        });

        const url = `/download_invoices_pdf?${params.toString()}`;
        console.log('ğŸ”— Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ PDF:', url);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_${type}_${month}_${status}.pdf`;
        link.style.display = 'none';
        document.body.appendChild(link);

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        link.click();

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
        setTimeout(() => {
            document.body.removeChild(link);
        }, 1000);

        console.log('âœ… ØªÙ… Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ PDF');

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        closeModal();

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ PDF:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ PDF: ' + error.message);
    }
}

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù†
function printReport() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ±');

    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ…
        const type = document.getElementById('printType')?.value;
        const month = document.getElementById('printMonth')?.value;
        const status = document.getElementById('printStatus')?.value || 'all';
        const includeDetails = document.getElementById('includeDetails')?.checked || false;

        console.log('ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', { type, month, status, includeDetails });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!type) {
            alert('Ø®Ø·Ø£: Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
            return;
        }

        if (!month) {
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©');
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        const params = new URLSearchParams({
            type: type,
            month: month,
            status: status,
            details: includeDetails.toString()
        });

        const url = `/print_invoices?${params.toString()}`;
        console.log('ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', url);

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        const printWindow = window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes');

        if (!printWindow) {
            alert('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.');
            return;
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
            }, 1000);
        };

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        closeModal();

        console.log('âœ… ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ' + error.message);
    }
}

// Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function quickPrintTest() {
    console.log('âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');

    // Ø§Ø®ØªØ¨Ø§Ø± ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    const modalElement = document.getElementById('printModal');
    if (modalElement) {
        showModalManually(modalElement);

        // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        const printType = document.getElementById('printType');
        const printMonth = document.getElementById('printMonth');
        const printStatus = document.getElementById('printStatus');

        if (printType) {
            printType.innerHTML = '<option value="sales">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>';
            printType.value = 'sales';
        }

        if (printMonth) {
            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            const currentMonthName = getMonthNameArabic(now.getMonth() + 1) + ' ' + now.getFullYear();

            printMonth.innerHTML = `<option value="${currentMonth}">${currentMonthName}</option>`;
            printMonth.value = currentMonth;
        }

        if (printStatus) {
            printStatus.value = 'all';
        }

        console.log('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆÙ…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
        alert('ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.');
    } else {
        alert('âŒ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!');
    }
}

// ÙØªØ­ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
function showDirectPrintForm() {
    console.log('ğŸ–¨ï¸ ÙØªØ­ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');

    try {
        const modalElement = document.getElementById('directPrintModal');
        if (modalElement) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('âœ… ØªÙ… ÙØªØ­ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
            } else {
                // fallback
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                modalElement.style.backgroundColor = 'rgba(0,0,0,0.5)';
                console.log('âœ… ØªÙ… ÙØªØ­ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (fallback)');
            }
        } else {
            alert('âŒ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ form Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
    }
}

// Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© - Ø¨Ø¯ÙˆÙ† Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
function directPrint(section) {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù‚Ø³Ù…:', section);

    try {
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        const now = new Date();
        const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

        // Ø¥Ù†Ø´Ø§Ø¡ form Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/print-invoices';
        form.target = '_blank'; // ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©

        // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù‚Ø³Ù…
        const sectionInput = document.createElement('input');
        sectionInput.type = 'hidden';
        sectionInput.name = 'section';
        sectionInput.value = section;
        form.appendChild(sectionInput);

        // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ø´Ù‡Ø±
        const monthInput = document.createElement('input');
        monthInput.type = 'hidden';
        monthInput.name = 'month';
        monthInput.value = currentMonth;
        form.appendChild(monthInput);

        // Ø¥Ø¶Ø§ÙØ© form Ù„Ù„ØµÙØ­Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);

        console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©');

        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const sectionNames = {
            'sales': 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            'purchases': 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            'expenses': 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
            'payroll': 'Ø§Ù„Ø±ÙˆØ§ØªØ¨'
        };

        alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø·Ø¨Ø§Ø¹Ø© ${sectionNames[section]} Ù„Ø´Ù‡Ø± ${currentMonth}`);

    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©: ' + error.message);
    }
}

// Initialize page when loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª');

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.warn('âš ï¸ Bootstrap ØºÙŠØ± Ù…ØªØ§Ø­');
    } else {
        console.log('âœ… Bootstrap Ù…ØªØ§Ø­');
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙ„Ø§ØªØ±
    const filters = [
        'sales-status-filter',
        'purchases-status-filter',
        'expenses-status-filter'
    ];

    filters.forEach(filterId => {
        const filter = document.getElementById(filterId);
        if (filter) {
            console.log(`âœ… ÙÙ„ØªØ± ${filterId} Ù…ÙˆØ¬ÙˆØ¯`);
            // Ø¥Ø¶Ø§ÙØ© event listener Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯
            filter.addEventListener('change', function() {
                console.log(`ğŸ”„ ØªØºÙŠÙŠØ± ÙÙ„ØªØ± ${filterId} Ø¥Ù„Ù‰:`, this.value);
            });
        } else {
            console.warn(`âš ï¸ ÙÙ„ØªØ± ${filterId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
        }
    });

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const printModal = document.getElementById('printModal');
    if (printModal) {
        console.log('âœ… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©');
    } else {
        console.warn('âš ï¸ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const printButtons = document.querySelectorAll('[onclick*="openPrintModal"]');
    console.log(`ğŸ“Š Ø¹Ø¯Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${printButtons.length}`);

    console.log('ğŸ‰ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­');
});

// Test function for debugging
function testPrintModal() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
    openPrintModal('sales');
}

// Test function for filters
function testFilters() {
    console.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ„Ø§ØªØ±');
    filterSalesTable();
    filterPurchasesTable();
    filterExpensesTable();
}

// ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ÙØ­Øµ
const testScript = document.createElement('script');
testScript.src = '/static/js/test_payments_functions.js';
testScript.onload = function() {
    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª ÙØ­Øµ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª');
};
testScript.onerror = function() {
    console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª ÙØ­Øµ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª');
};
document.head.appendChild(testScript);
</script>

<!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠØ© -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;">
    <div class="btn-group-vertical">
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="runPaymentsJSTests()" title="ØªØ´ØºÙŠÙ„ ÙØ­Øµ JavaScript">
            ğŸ§ª ÙØ­Øµ JS
        </button>
        <button type="button" class="btn btn-sm btn-outline-info" onclick="console.table(getPaymentsTestResults())" title="Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ">
            ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearPaymentsTestResults()" title="Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ">
            ğŸ§¹ Ù…Ø³Ø­
        </button>
    </div>
</div>
{% endblock %}