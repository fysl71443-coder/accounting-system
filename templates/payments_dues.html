{% extends "base_simple.html" %}

{% block title %}
    {% if session.get('language', 'ar') == 'ar' %}
        المدفوعات والمستحقات
    {% else %}
        Payments & Dues
    {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if session.get('language', 'ar') == 'ar' %}
                <i class="fas fa-money-check-alt"></i> المدفوعات والمستحقات
            {% else %}
                <i class="fas fa-money-check-alt"></i> Payments & Dues
            {% endif %}
        </h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-primary" onclick="refreshData()">
                {% if session.get('language', 'ar') == 'ar' %}
                    <i class="fas fa-sync-alt"></i> تحديث البيانات
                {% else %}
                    <i class="fas fa-sync-alt"></i> Refresh Data
                {% endif %}
            </button>
            <button type="button" class="btn btn-success" onclick="recordPayment()" id="record-payment-btn" disabled>
                {% if session.get('language', 'ar') == 'ar' %}
                    <i class="fas fa-plus"></i> تسجيل دفعة
                {% else %}
                    <i class="fas fa-plus"></i> Record Payment
                {% endif %}
            </button>
            <button type="button" class="btn btn-info" onclick="generateReport()">
                {% if session.get('language', 'ar') == 'ar' %}
                    <i class="fas fa-file-alt"></i> تقرير المدفوعات
                {% else %}
                    <i class="fas fa-file-alt"></i> Payments Report
                {% endif %}
            </button>
            <button type="button" class="btn btn-secondary" onclick="exportData()">
                {% if session.get('language', 'ar') == 'ar' %}
                    <i class="fas fa-download"></i> تصدير
                {% else %}
                    <i class="fas fa-download"></i> Export
                {% endif %}
            </button>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        {% if session.get('language', 'ar') == 'ar' %}
                            فلاتر البحث
                        {% else %}
                            Search Filters
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}نوع الحساب{% else %}Account Type{% endif %}
                            </label>
                            <select class="form-select" id="account-type" onchange="filterData()">
                                <option value="all">
                                    {% if session.get('language', 'ar') == 'ar' %}جميع الحسابات{% else %}All Accounts{% endif %}
                                </option>
                                <option value="suppliers">
                                    {% if session.get('language', 'ar') == 'ar' %}الموردين{% else %}Suppliers{% endif %}
                                </option>
                                <option value="customers">
                                    {% if session.get('language', 'ar') == 'ar' %}العملاء{% else %}Customers{% endif %}
                                </option>
                                <option value="employees">
                                    {% if session.get('language', 'ar') == 'ar' %}الموظفين{% else %}Employees{% endif %}
                                </option>
                                <option value="expenses">
                                    {% if session.get('language', 'ar') == 'ar' %}مصاريف أخرى{% else %}Other Expenses{% endif %}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}حالة السداد{% else %}Payment Status{% endif %}
                            </label>
                            <select class="form-select" id="payment-status" onchange="filterData()">
                                <option value="all">
                                    {% if session.get('language', 'ar') == 'ar' %}جميع الحالات{% else %}All Status{% endif %}
                                </option>
                                <option value="unpaid">
                                    {% if session.get('language', 'ar') == 'ar' %}غير مدفوع{% else %}Unpaid{% endif %}
                                </option>
                                <option value="partial">
                                    {% if session.get('language', 'ar') == 'ar' %}مدفوع جزئياً{% else %}Partially Paid{% endif %}
                                </option>
                                <option value="paid">
                                    {% if session.get('language', 'ar') == 'ar' %}مدفوع بالكامل{% else %}Fully Paid{% endif %}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}من تاريخ{% else %}From Date{% endif %}
                            </label>
                            <input type="date" class="form-control" id="from-date" value="2025-08-01" onchange="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}إلى تاريخ{% else %}To Date{% endif %}
                            </label>
                            <input type="date" class="form-control" id="to-date" value="2025-08-31" onchange="filterData()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}البحث بالاسم{% else %}Search by Name{% endif %}
                            </label>
                            <input type="text" class="form-control" id="search-name" placeholder="{% if session.get('language', 'ar') == 'ar' %}اسم المورد/العميل/الموظف{% else %}Supplier/Customer/Employee Name{% endif %}" onkeyup="filterData()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-primary h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-primary mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                إجمالي المبالغ
                            {% else %}
                                Total Amount
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="total-amount">0.00 ريال</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calculator fa-2x opacity-75 text-primary"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-success h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-success mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                إجمالي المدفوع
                            {% else %}
                                Total Paid
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="total-paid">0.00 ريال</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75 text-success"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-danger h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-danger mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                إجمالي المستحق
                            {% else %}
                                Total Due
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="total-due">0.00 ريال</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75 text-danger"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-warning h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-warning mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                العمليات غير المدفوعة
                            {% else %}
                                Unpaid Transactions
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="unpaid-count">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x opacity-75 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        {% if session.get('language', 'ar') == 'ar' %}
                            جدول المعاملات المالية
                        {% else %}
                            Financial Transactions Table
                        {% endif %}
                    </h5>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="select-all" onchange="toggleSelectAll()">
                        <label class="form-check-label text-white" for="select-all">
                            {% if session.get('language', 'ar') == 'ar' %}تحديد الكل{% else %}Select All{% endif %}
                        </label>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="transactions-table">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 5%">
                                        {% if session.get('language', 'ar') == 'ar' %}اختيار{% else %}Select{% endif %}
                                    </th>
                                    <th style="width: 12%">
                                        {% if session.get('language', 'ar') == 'ar' %}رقم الفاتورة{% else %}Invoice Number{% endif %}
                                    </th>
                                    <th style="width: 12%">
                                        {% if session.get('language', 'ar') == 'ar' %}نوع العملية{% else %}Operation Type{% endif %}
                                    </th>
                                    <th style="width: 15%">
                                        {% if session.get('language', 'ar') == 'ar' %}الاسم{% else %}Name{% endif %}
                                    </th>
                                    <th style="width: 10%">
                                        {% if session.get('language', 'ar') == 'ar' %}التاريخ{% else %}Date{% endif %}
                                    </th>
                                    <th style="width: 12%">
                                        {% if session.get('language', 'ar') == 'ar' %}القيمة الإجمالية{% else %}Total Value{% endif %}
                                    </th>
                                    <th style="width: 12%">
                                        {% if session.get('language', 'ar') == 'ar' %}المدفوع{% else %}Paid{% endif %}
                                    </th>
                                    <th style="width: 12%">
                                        {% if session.get('language', 'ar') == 'ar' %}المتبقي{% else %}Remaining{% endif %}
                                    </th>
                                    <th style="width: 10%">
                                        {% if session.get('language', 'ar') == 'ar' %}حالة السداد{% else %}Payment Status{% endif %}
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="transactions-tbody">
                                <!-- Transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Record Payment Modal -->
<div class="modal fade" id="recordPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}تسجيل دفعة جديدة{% else %}Record New Payment{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                {% if session.get('language', 'ar') == 'ar' %}العمليات المحددة:{% else %}Selected Transactions:{% endif %}
                            </h6>
                            <div id="selected-transactions-list"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}المبلغ المدفوع{% else %}Payment Amount{% endif %}
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="payment-amount" step="0.01" min="0" onchange="calculateChange()">
                            <span class="input-group-text">ريال</span>
                        </div>
                        <small class="text-muted" id="max-payment-hint"></small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}طريقة الدفع{% else %}Payment Method{% endif %}
                        </label>
                        <select class="form-select" id="payment-method">
                            <option value="CASH">
                                {% if session.get('language', 'ar') == 'ar' %}نقدي{% else %}Cash{% endif %}
                            </option>
                            <option value="MADA">مدى - MADA</option>
                            <option value="VISA">فيزا - VISA</option>
                            <option value="MASTERCARD">ماستركارد - MASTERCARD</option>
                            <option value="BANK">
                                {% if session.get('language', 'ar') == 'ar' %}تحويل بنكي{% else %}Bank Transfer{% endif %}
                            </option>
                            <option value="CHECK">
                                {% if session.get('language', 'ar') == 'ar' %}شيك{% else %}Check{% endif %}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}تاريخ الدفع{% else %}Payment Date{% endif %}
                        </label>
                        <input type="date" class="form-control" id="payment-date">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}رقم المرجع{% else %}Reference Number{% endif %}
                        </label>
                        <input type="text" class="form-control" id="payment-reference" placeholder="{% if session.get('language', 'ar') == 'ar' %}رقم الشيك أو المرجع{% else %}Check or Reference Number{% endif %}">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}ملاحظات{% else %}Notes{% endif %}
                        </label>
                        <textarea class="form-control" id="payment-notes" rows="3" placeholder="{% if session.get('language', 'ar') == 'ar' %}ملاحظات إضافية (اختياري){% else %}Additional notes (optional){% endif %}"></textarea>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <h6 class="text-muted">
                                            {% if session.get('language', 'ar') == 'ar' %}إجمالي المستحق{% else %}Total Due{% endif %}
                                        </h6>
                                        <h4 class="text-danger" id="modal-total-due">0.00 ريال</h4>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">
                                            {% if session.get('language', 'ar') == 'ar' %}المبلغ المدفوع{% else %}Payment Amount{% endif %}
                                        </h6>
                                        <h4 class="text-success" id="modal-payment-amount">0.00 ريال</h4>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">
                                            {% if session.get('language', 'ar') == 'ar' %}المتبقي بعد الدفع{% else %}Remaining After Payment{% endif %}
                                        </h6>
                                        <h4 class="text-warning" id="modal-remaining">0.00 ريال</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}إلغاء{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-success" onclick="savePayment()">
                    {% if session.get('language', 'ar') == 'ar' %}تسجيل الدفعة{% else %}Record Payment{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment History Modal -->
<div class="modal fade" id="paymentHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}سجل المدفوعات{% else %}Payment History{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>
                                    {% if session.get('language', 'ar') == 'ar' %}التاريخ{% else %}Date{% endif %}
                                </th>
                                <th>
                                    {% if session.get('language', 'ar') == 'ar' %}رقم الفاتورة{% else %}Invoice Number{% endif %}
                                </th>
                                <th>
                                    {% if session.get('language', 'ar') == 'ar' %}المبلغ{% else %}Amount{% endif %}
                                </th>
                                <th>
                                    {% if session.get('language', 'ar') == 'ar' %}طريقة الدفع{% else %}Payment Method{% endif %}
                                </th>
                                <th>
                                    {% if session.get('language', 'ar') == 'ar' %}رقم المرجع{% else %}Reference{% endif %}
                                </th>
                                <th>
                                    {% if session.get('language', 'ar') == 'ar' %}ملاحظات{% else %}Notes{% endif %}
                                </th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-tbody">
                            <!-- Payment history will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}إغلاق{% else %}Close{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let transactionsData = [];
let selectedTransactions = [];
let currentLanguage = '{{ session.get("language", "ar") }}';

// Initialize page
$(document).ready(function() {
    // Set today's date as default payment date
    document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];

    // Load initial data
    loadTransactionsData();
    filterData();
});

// Load sample transactions data
function loadTransactionsData() {
    transactionsData = [
        {
            id: 1,
            invoice_number: 'PUR-001',
            type: 'purchase',
            type_ar: 'فاتورة شراء',
            type_en: 'Purchase Invoice',
            name: 'شركة الخضار الطازجة',
            name_en: 'Fresh Vegetables Company',
            date: '2025-08-01',
            total_amount: 5000.00,
            paid_amount: 2000.00,
            remaining_amount: 3000.00,
            status: 'partial',
            account_type: 'suppliers'
        },
        {
            id: 2,
            invoice_number: 'SAL-001',
            type: 'salary',
            type_ar: 'راتب موظف',
            type_en: 'Employee Salary',
            name: 'أحمد محمد علي',
            name_en: 'Ahmed Mohammed Ali',
            date: '2025-08-01',
            total_amount: 4500.00,
            paid_amount: 0.00,
            remaining_amount: 4500.00,
            status: 'unpaid',
            account_type: 'employees'
        },
        {
            id: 3,
            invoice_number: 'SALE-001',
            type: 'sale',
            type_ar: 'فاتورة بيع آجلة',
            type_en: 'Credit Sale Invoice',
            name: 'مطعم الأصالة',
            name_en: 'Asala Restaurant',
            date: '2025-08-02',
            total_amount: 8000.00,
            paid_amount: 8000.00,
            remaining_amount: 0.00,
            status: 'paid',
            account_type: 'customers'
        },
        {
            id: 4,
            invoice_number: 'EXP-001',
            type: 'expense',
            type_ar: 'فاتورة إيجار',
            type_en: 'Rent Invoice',
            name: 'شركة العقارات المتحدة',
            name_en: 'United Real Estate Company',
            date: '2025-08-03',
            total_amount: 12000.00,
            paid_amount: 6000.00,
            remaining_amount: 6000.00,
            status: 'partial',
            account_type: 'expenses'
        },
        {
            id: 5,
            invoice_number: 'PUR-002',
            type: 'purchase',
            type_ar: 'فاتورة شراء',
            type_en: 'Purchase Invoice',
            name: 'مؤسسة اللحوم الطازجة',
            name_en: 'Fresh Meat Corporation',
            date: '2025-08-04',
            total_amount: 7500.00,
            paid_amount: 0.00,
            remaining_amount: 7500.00,
            status: 'unpaid',
            account_type: 'suppliers'
        },
        {
            id: 6,
            invoice_number: 'SAL-002',
            type: 'salary',
            type_ar: 'راتب موظف',
            type_en: 'Employee Salary',
            name: 'فاطمة علي حسن',
            name_en: 'Fatima Ali Hassan',
            date: '2025-08-01',
            total_amount: 4200.00,
            paid_amount: 4200.00,
            remaining_amount: 0.00,
            status: 'paid',
            account_type: 'employees'
        }
    ];
}

// Filter data based on selected criteria
function filterData() {
    const accountType = document.getElementById('account-type').value;
    const paymentStatus = document.getElementById('payment-status').value;
    const fromDate = document.getElementById('from-date').value;
    const toDate = document.getElementById('to-date').value;
    const searchName = document.getElementById('search-name').value.toLowerCase();

    let filteredData = transactionsData.filter(transaction => {
        // Account type filter
        if (accountType !== 'all' && transaction.account_type !== accountType) {
            return false;
        }

        // Payment status filter
        if (paymentStatus !== 'all' && transaction.status !== paymentStatus) {
            return false;
        }

        // Date filter
        const transactionDate = new Date(transaction.date);
        const from = new Date(fromDate);
        const to = new Date(toDate);
        if (transactionDate < from || transactionDate > to) {
            return false;
        }

        // Name search filter
        if (searchName && !transaction.name.toLowerCase().includes(searchName) &&
            !transaction.name_en.toLowerCase().includes(searchName)) {
            return false;
        }

        return true;
    });

    updateTransactionsTable(filteredData);
    updateSummaryCards(filteredData);
}

// Update transactions table
function updateTransactionsTable(data) {
    const tbody = document.getElementById('transactions-tbody');
    tbody.innerHTML = '';

    data.forEach(transaction => {
        const row = document.createElement('tr');

        const typeName = currentLanguage === 'ar' ? transaction.type_ar : transaction.type_en;
        const accountName = currentLanguage === 'ar' ? transaction.name : transaction.name_en;
        const statusText = getStatusText(transaction.status);
        const statusClass = getStatusClass(transaction.status);

        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input transaction-checkbox"
                       value="${transaction.id}" onchange="updateSelectedTransactions()">
            </td>
            <td>${transaction.invoice_number}</td>
            <td><span class="badge bg-${getTypeBadgeColor(transaction.type)}">${typeName}</span></td>
            <td>${accountName}</td>
            <td>${formatDate(transaction.date)}</td>
            <td class="text-end">${formatCurrency(transaction.total_amount)}</td>
            <td class="text-end">${formatCurrency(transaction.paid_amount)}</td>
            <td class="text-end">${formatCurrency(transaction.remaining_amount)}</td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
        `;

        // Add click event to row (except checkbox column)
        row.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                showPaymentHistory(transaction.id);
            }
        });

        tbody.appendChild(row);
    });
}

// Update summary cards
function updateSummaryCards(data) {
    let totalAmount = 0;
    let totalPaid = 0;
    let totalDue = 0;
    let unpaidCount = 0;

    data.forEach(transaction => {
        totalAmount += transaction.total_amount;
        totalPaid += transaction.paid_amount;
        totalDue += transaction.remaining_amount;

        if (transaction.status === 'unpaid' || transaction.status === 'partial') {
            unpaidCount++;
        }
    });

    document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
    document.getElementById('total-paid').textContent = formatCurrency(totalPaid);
    document.getElementById('total-due').textContent = formatCurrency(totalDue);
    document.getElementById('unpaid-count').textContent = unpaidCount;
}

// Update selected transactions
function updateSelectedTransactions() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    selectedTransactions = Array.from(checkboxes).map(cb => parseInt(cb.value));

    const recordBtn = document.getElementById('record-payment-btn');
    recordBtn.disabled = selectedTransactions.length === 0;
}

// Toggle select all
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.transaction-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });

    updateSelectedTransactions();
}

// Record payment
function recordPayment() {
    if (selectedTransactions.length === 0) {
        alert(currentLanguage === 'ar' ? 'يرجى اختيار عملية واحدة على الأقل' : 'Please select at least one transaction');
        return;
    }

    // Prepare selected transactions list
    let selectedList = '';
    let totalDue = 0;

    selectedTransactions.forEach(id => {
        const transaction = transactionsData.find(t => t.id === id);
        if (transaction) {
            const name = currentLanguage === 'ar' ? transaction.name : transaction.name_en;
            selectedList += `<div class="mb-1">
                <strong>${transaction.invoice_number}</strong> - ${name}
                <span class="text-danger">(${formatCurrency(transaction.remaining_amount)})</span>
            </div>`;
            totalDue += transaction.remaining_amount;
        }
    });

    document.getElementById('selected-transactions-list').innerHTML = selectedList;
    document.getElementById('modal-total-due').textContent = formatCurrency(totalDue);
    document.getElementById('payment-amount').max = totalDue;
    document.getElementById('max-payment-hint').textContent =
        (currentLanguage === 'ar' ? 'الحد الأقصى: ' : 'Maximum: ') + formatCurrency(totalDue);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('recordPaymentModal'));
    modal.show();
}

// Calculate change in payment modal
function calculateChange() {
    const paymentAmount = parseFloat(document.getElementById('payment-amount').value) || 0;
    const totalDue = selectedTransactions.reduce((sum, id) => {
        const transaction = transactionsData.find(t => t.id === id);
        return sum + (transaction ? transaction.remaining_amount : 0);
    }, 0);

    const remaining = Math.max(0, totalDue - paymentAmount);

    document.getElementById('modal-payment-amount').textContent = formatCurrency(paymentAmount);
    document.getElementById('modal-remaining').textContent = formatCurrency(remaining);
}

// Save payment
function savePayment() {
    const paymentAmount = parseFloat(document.getElementById('payment-amount').value);
    const paymentMethod = document.getElementById('payment-method').value;
    const paymentDate = document.getElementById('payment-date').value;
    const paymentReference = document.getElementById('payment-reference').value;
    const paymentNotes = document.getElementById('payment-notes').value;

    if (!paymentAmount || paymentAmount <= 0) {
        alert(currentLanguage === 'ar' ? 'يرجى إدخال مبلغ صحيح' : 'Please enter a valid amount');
        return;
    }

    if (!paymentDate) {
        alert(currentLanguage === 'ar' ? 'يرجى اختيار تاريخ الدفع' : 'Please select payment date');
        return;
    }

    // Process payment for selected transactions
    let remainingPayment = paymentAmount;

    selectedTransactions.forEach(id => {
        const transaction = transactionsData.find(t => t.id === id);
        if (transaction && remainingPayment > 0) {
            const paymentForThis = Math.min(remainingPayment, transaction.remaining_amount);

            transaction.paid_amount += paymentForThis;
            transaction.remaining_amount -= paymentForThis;
            remainingPayment -= paymentForThis;

            // Update status
            if (transaction.remaining_amount <= 0) {
                transaction.status = 'paid';
            } else if (transaction.paid_amount > 0) {
                transaction.status = 'partial';
            }
        }
    });

    // Clear form and close modal
    document.getElementById('payment-amount').value = '';
    document.getElementById('payment-reference').value = '';
    document.getElementById('payment-notes').value = '';

    const modal = bootstrap.Modal.getInstance(document.getElementById('recordPaymentModal'));
    modal.hide();

    // Refresh data
    filterData();

    // Clear selections
    selectedTransactions = [];
    document.getElementById('select-all').checked = false;
    document.getElementById('record-payment-btn').disabled = true;

    alert(currentLanguage === 'ar' ? 'تم تسجيل الدفعة بنجاح' : 'Payment recorded successfully');
}

// Show payment history
function showPaymentHistory(transactionId) {
    // This would load actual payment history from database
    const sampleHistory = [
        {
            date: '2025-08-01',
            invoice_number: 'PUR-001',
            amount: 2000.00,
            method: 'CASH',
            reference: 'CASH-001',
            notes: 'دفعة جزئية'
        }
    ];

    const tbody = document.getElementById('payment-history-tbody');
    tbody.innerHTML = '';

    sampleHistory.forEach(payment => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDate(payment.date)}</td>
            <td>${payment.invoice_number}</td>
            <td class="text-end">${formatCurrency(payment.amount)}</td>
            <td><span class="badge bg-info">${getPaymentMethodText(payment.method)}</span></td>
            <td>${payment.reference}</td>
            <td>${payment.notes}</td>
        `;
        tbody.appendChild(row);
    });

    const modal = new bootstrap.Modal(document.getElementById('paymentHistoryModal'));
    modal.show();
}

// Refresh data
function refreshData() {
    loadTransactionsData();
    filterData();
    alert(currentLanguage === 'ar' ? 'تم تحديث البيانات' : 'Data refreshed');
}

// Generate report
function generateReport() {
    alert(currentLanguage === 'ar' ? 'سيتم إنشاء تقرير المدفوعات' : 'Payments report will be generated');
}

// Export data
function exportData() {
    alert(currentLanguage === 'ar' ? 'سيتم تصدير البيانات' : 'Data will be exported');
}

// Helper functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-SA', {
        style: 'currency',
        currency: 'SAR',
        minimumFractionDigits: 2
    }).format(amount).replace('SAR', 'ريال');
}

function formatDate(dateString) {
    const date = new Date(dateString);
    if (currentLanguage === 'ar') {
        return date.toLocaleDateString('ar-SA');
    } else {
        return date.toLocaleDateString('en-US');
    }
}

function getStatusText(status) {
    const statuses = {
        'paid': currentLanguage === 'ar' ? 'مدفوع' : 'Paid',
        'unpaid': currentLanguage === 'ar' ? 'غير مدفوع' : 'Unpaid',
        'partial': currentLanguage === 'ar' ? 'مدفوع جزئياً' : 'Partially Paid'
    };
    return statuses[status] || status;
}

function getStatusClass(status) {
    const classes = {
        'paid': 'success',
        'unpaid': 'danger',
        'partial': 'warning'
    };
    return classes[status] || 'secondary';
}

function getTypeBadgeColor(type) {
    const colors = {
        'purchase': 'warning',
        'sale': 'success',
        'salary': 'info',
        'expense': 'danger'
    };
    return colors[type] || 'secondary';
}

function getPaymentMethodText(method) {
    const methods = {
        'CASH': currentLanguage === 'ar' ? 'نقدي' : 'Cash',
        'MADA': 'مدى',
        'VISA': 'فيزا',
        'MASTERCARD': 'ماستركارد',
        'BANK': currentLanguage === 'ar' ? 'تحويل بنكي' : 'Bank Transfer',
        'CHECK': currentLanguage === 'ar' ? 'شيك' : 'Check'
    };
    return methods[method] || method;
}
</script>
{% endblock %}
