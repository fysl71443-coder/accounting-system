{% extends "base_unified.html" %}

{% block title %}
{% if session.get('language', 'ar') == 'ar' %}
Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
{% else %}
Product Management - Accounting System
{% endif %}
{% endblock %}

{% block page_icon %}<i class="fas fa-box"></i>{% endblock %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}
    Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
{% else %}
    Product Management
{% endif %}
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-success" onclick="showAddProductModal()">
        <i class="fas fa-plus me-1"></i>
        {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯{% else %}Add New Product{% endif %}
    </button>
    <button type="button" class="btn btn-info" onclick="exportProducts()">
        <i class="fas fa-download me-1"></i>
        {% if session.get('language', 'ar') == 'ar' %}ØªØµØ¯ÙŠØ±{% else %}Export{% endif %}
    </button>
    <button type="button" class="btn btn-secondary" onclick="printProductsList()">
        <i class="fas fa-print me-1"></i>
        {% if session.get('language', 'ar') == 'ar' %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Search and Filter -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...{% else %}Search products...{% endif %}" value="{{ search }}">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter">
                    <option value="">{% if session.get('language', 'ar') == 'ar' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª{% else %}All Categories{% endif %}</option>
                    <option value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">{% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª{% else %}Electronics{% endif %}</option>
                    <option value="Ù…Ù„Ø§Ø¨Ø³">{% if session.get('language', 'ar') == 'ar' %}Ù…Ù„Ø§Ø¨Ø³{% else %}Clothing{% endif %}</option>
                    <option value="Ø£ØºØ°ÙŠØ©">{% if session.get('language', 'ar') == 'ar' %}Ø£ØºØ°ÙŠØ©{% else %}Food{% endif %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">{% if session.get('language', 'ar') == 'ar' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª{% else %}All Status{% endif %}</option>
                    <option value="active">{% if session.get('language', 'ar') == 'ar' %}Ù†Ø´Ø·{% else %}Active{% endif %}</option>
                    <option value="inactive">{% if session.get('language', 'ar') == 'ar' %}ØºÙŠØ± Ù†Ø´Ø·{% else %}Inactive{% endif %}</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-box me-2"></i>
            {% if session.get('language', 'ar') == 'ar' %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª{% else %}Products List{% endif %}
        </h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="productsTable">
                <thead>
                    <tr>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±Ù…Ø²{% else %}Code{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬{% else %}Product Name{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙØ¦Ø©{% else %}Category{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªÙƒÙ„ÙØ©{% else %}Cost{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹{% else %}Selling Price{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø®Ø²ÙˆÙ†{% else %}Stock{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr data-category="{{ product.category or '' }}" data-status="{{ 'active' if product.is_active else 'inactive' }}">
                        <td><strong>{{ product.product_code }}</strong></td>
                        <td>{{ product.product_name }}</td>
                        <td>
                            {% if product.category %}
                            <span class="badge bg-secondary">{{ product.category }}</span>
                            {% endif %}
                        </td>
                        <td>{{ "%.2f"|format(product.unit_cost) }} Ø±ÙŠØ§Ù„</td>
                        <td><strong>{{ "%.2f"|format(product.selling_price) }} Ø±ÙŠØ§Ù„</strong></td>
                        <td>
                            <span class="badge {{ 'bg-danger' if product.current_stock <= product.min_stock_level else 'bg-success' }}">
                                {{ product.current_stock }}
                            </span>
                        </td>
                        <td>
                            <span class="badge {{ 'bg-success' if product.is_active else 'bg-secondary' }}">
                                {% if product.is_active %}
                                    {% if session.get('language', 'ar') == 'ar' %}Ù†Ø´Ø·{% else %}Active{% endif %}
                                {% else %}
                                    {% if session.get('language', 'ar') == 'ar' %}ØºÙŠØ± Ù†Ø´Ø·{% else %}Inactive{% endif %}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('product_cost', product_id=product.id) }}" class="btn btn-outline-success" title="{% if session.get('language', 'ar') == 'ar' %}Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©{% else %}Calculate Cost{% endif %}">
                                    <i class="fas fa-calculator"></i>
                                </a>
                                <button type="button" class="btn btn-outline-primary" onclick="editProduct({{ product.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteProduct({{ product.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}
                        Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                    {% else %}
                        Add New Product
                    {% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCode" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬{% else %}Product Code{% endif %} *
                                </label>
                                <input type="text" class="form-control" id="productCode" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬{% else %}Product Name{% endif %} *
                                </label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙØ¦Ø©{% else %}Category{% endif %}
                                </label>
                                <select class="form-select" id="category">
                                    <option value="">{% if session.get('language', 'ar') == 'ar' %}Ø§Ø®ØªØ± ÙØ¦Ø©{% else %}Select Category{% endif %}</option>
                                    <option value="Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">{% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª{% else %}Electronics{% endif %}</option>
                                    <option value="Ù…Ù„Ø§Ø¨Ø³">{% if session.get('language', 'ar') == 'ar' %}Ù…Ù„Ø§Ø¨Ø³{% else %}Clothing{% endif %}</option>
                                    <option value="Ø£ØºØ°ÙŠØ©">{% if session.get('language', 'ar') == 'ar' %}Ø£ØºØ°ÙŠØ©{% else %}Food{% endif %}</option>
                                    <option value="Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª ØªØ¬Ù…ÙŠÙ„">{% if session.get('language', 'ar') == 'ar' %}Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª ØªØ¬Ù…ÙŠÙ„{% else %}Cosmetics{% endif %}</option>
                                    <option value="Ø£Ø®Ø±Ù‰">{% if session.get('language', 'ar') == 'ar' %}Ø£Ø®Ø±Ù‰{% else %}Other{% endif %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unitType" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³{% else %}Unit Type{% endif %}
                                </label>
                                <select class="form-select" id="unitType">
                                    <option value="Ù‚Ø·Ø¹Ø©">{% if session.get('language', 'ar') == 'ar' %}Ù‚Ø·Ø¹Ø©{% else %}Piece{% endif %}</option>
                                    <option value="ÙƒÙŠÙ„Ùˆ">{% if session.get('language', 'ar') == 'ar' %}ÙƒÙŠÙ„Ùˆ{% else %}Kg{% endif %}</option>
                                    <option value="Ù„ØªØ±">{% if session.get('language', 'ar') == 'ar' %}Ù„ØªØ±{% else %}Liter{% endif %}</option>
                                    <option value="Ù…ØªØ±">{% if session.get('language', 'ar') == 'ar' %}Ù…ØªØ±{% else %}Meter{% endif %}</option>
                                    <option value="Ø¹Ù„Ø¨Ø©">{% if session.get('language', 'ar') == 'ar' %}Ø¹Ù„Ø¨Ø©{% else %}Box{% endif %}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="unitCost" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©{% else %}Unit Cost{% endif %}
                                </label>
                                <input type="number" class="form-control" id="unitCost" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="sellingPrice" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹{% else %}Selling Price{% endif %} *
                                </label>
                                <input type="number" class="form-control" id="sellingPrice" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="minStock" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†{% else %}Minimum Stock{% endif %}
                                </label>
                                <input type="number" class="form-control" id="minStock" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="currentStock" class="form-label">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ{% else %}Current Stock{% endif %}
                                </label>
                                <input type="number" class="form-control" id="currentStock" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙˆØµÙ{% else %}Description{% endif %}
                        </label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                {% if session.get('language', 'ar') == 'ar' %}Ù…Ù†ØªØ¬ Ù†Ø´Ø·{% else %}Active Product{% endif %}
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ØºØ§Ø¡{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">
                    {% if session.get('language', 'ar') == 'ar' %}Ø­ÙØ¸{% else %}Save{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables for products screen
let currentProductId = null;
let selectedProductId = null;

// Search and filter functionality
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('categoryFilter').addEventListener('change', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    const rows = document.querySelectorAll('#productsTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const category = row.dataset.category;
        const status = row.dataset.status;

        const matchesSearch = text.includes(searchTerm);
        const matchesCategory = !categoryFilter || category === categoryFilter;
        const matchesStatus = !statusFilter || status === statusFilter;

        if (matchesSearch && matchesCategory && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Override productsHandler functions to connect with existing form
if (typeof productsHandler !== 'undefined') {
    // Override SaveRecord to use the existing modal form
    productsHandler.SaveRecord = function() {
        console.log('ğŸ”µ Products - Save Record button clicked');

        // Clear form and show modal for new product
        clearProductForm();
        currentProductId = null;

        // Update modal title
        document.querySelector('#productModal .modal-title').textContent =
            '{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯{% else %}Add New Product{% endif %}';

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    };

    // Override EditRecord to use the existing modal form
    productsHandler.EditRecord = function(recordId = null) {
        const id = recordId || selectedProductId;
        if (!id) {
            showToast('{% if session.get('language', 'ar') == 'ar' %}ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„{% else %}Please select a product to edit{% endif %}', 'warning');
            return;
        }

        console.log('ğŸ”µ Products - Edit Record button clicked for ID:', id);

        // Load product data and show modal
        editProduct(id);
    };

    // Override DeleteRecord to use the existing delete function
    productsHandler.DeleteRecord = function(recordId = null) {
        const id = recordId || selectedProductId;
        if (!id) {
            showToast('{% if session.get('language', 'ar') == 'ar' %}ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù„Ù„Ø­Ø°Ù{% else %}Please select a product to delete{% endif %}', 'warning');
            return;
        }

        console.log('ğŸ”µ Products - Delete Record button clicked for ID:', id);

        // Use existing delete function
        deleteProduct(id);
    };

    // Override SearchRecords to use the existing search
    productsHandler.SearchRecords = function() {
        console.log('ğŸ”µ Products - Search Records button clicked');

        // Focus on search input
        document.getElementById('searchInput').focus();

        // Trigger search
        filterTable();

        showToast('{% if session.get('language', 'ar') == 'ar' %}Ø§Ø³ØªØ®Ø¯Ù… Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¹Ù„Ø§Ù‡{% else %}Use the search field above{% endif %}', 'info');
    };

    // Override PrintRecord
    productsHandler.PrintRecord = function(recordId = null) {
        const id = recordId || selectedProductId;
        if (!id) {
            showToast('{% if session.get('language', 'ar') == 'ar' %}ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©{% else %}Please select a product to print{% endif %}', 'warning');
            return;
        }

        console.log('ğŸ”µ Products - Print Record button clicked for ID:', id);

        // Call API for printing
        fetch(`/api/products/print/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('{% if session.get('language', 'ar') == 'ar' %}Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©...{% else %}Preparing for print...{% endif %}', 'info');
                // Open print URL if provided
                if (data.print_url) {
                    window.open(data.print_url, '_blank');
                }
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('{% if session.get('language', 'ar') == 'ar' %}Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©{% else %}Print error{% endif %}', 'danger');
        });
    };

    // Update getFormData to use the existing form fields
    productsHandler.getFormData = function() {
        return {
            product_code: document.getElementById('productCode')?.value || '',
            product_name: document.getElementById('productName')?.value || '',
            description: document.getElementById('description')?.value || '',
            unit_cost: parseFloat(document.getElementById('unitCost')?.value || 0),
            selling_price: parseFloat(document.getElementById('sellingPrice')?.value || 0),
            category: document.getElementById('category')?.value || '',
            unit_type: document.getElementById('unitType')?.value || 'Ù‚Ø·Ø¹Ø©',
            min_stock_level: parseInt(document.getElementById('minStock')?.value || 0),
            current_stock: parseInt(document.getElementById('currentStock')?.value || 0),
            is_active: document.getElementById('isActive')?.checked || true
        };
    };
}

// Helper function to clear the product form
function clearProductForm() {
    document.getElementById('productForm').reset();
    document.getElementById('productCode').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('description').value = '';
    document.getElementById('unitCost').value = '0';
    document.getElementById('sellingPrice').value = '';
    document.getElementById('category').value = '';
    document.getElementById('unitType').value = 'Ù‚Ø·Ø¹Ø©';
    document.getElementById('minStock').value = '0';
    document.getElementById('currentStock').value = '0';
    document.getElementById('isActive').checked = true;
}

// Add row selection functionality
function selectProductRow(productId) {
    // Remove previous selection
    document.querySelectorAll('#productsTable tbody tr').forEach(row => {
        row.classList.remove('table-active');
    });

    // Add selection to clicked row
    const row = document.querySelector(`button[onclick*="${productId}"]`).closest('tr');
    if (row) {
        row.classList.add('table-active');
        selectedProductId = productId;
        console.log('ğŸ”µ Product selected:', productId);
    }
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeSearch('searchInput', 'productsTable', [1, 2]); // Search in name and category columns
    loadProducts();

    // Add click handlers to table rows for selection
    document.querySelectorAll('#productsTable tbody tr').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't select if clicking on action buttons
            if (!e.target.closest('.btn-group')) {
                const editBtn = this.querySelector('button[onclick*="editProduct"]');
                if (editBtn) {
                    const productId = editBtn.getAttribute('onclick').match(/\d+/)[0];
                    selectProductRow(parseInt(productId));
                }
            }
        });
    });
});

function loadProducts() {
    // This would normally load from server
    console.log('Loading products...');
}

function editProduct(productId) {
    console.log('ğŸ”µ Products - Edit Product function called for ID:', productId);

    currentProductId = productId;
    selectedProductId = productId;

    // Update modal title
    document.querySelector('#productModal .modal-title').textContent =
        '{% if session.get('language', 'ar') == 'ar' %}ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬{% else %}Edit Product{% endif %}';

    // Find product data from the table row
    const row = document.querySelector(`button[onclick="editProduct(${productId})"]`).closest('tr');
    if (row) {
        const cells = row.querySelectorAll('td');

        // Populate form with existing data
        document.getElementById('productCode').value = cells[0].textContent.trim();
        document.getElementById('productName').value = cells[1].textContent.trim();

        // Extract category from badge
        const categoryBadge = cells[2].querySelector('.badge');
        if (categoryBadge) {
            document.getElementById('category').value = categoryBadge.textContent.trim();
        }

        // Extract prices (remove currency)
        const costText = cells[3].textContent.replace(/[^\d.]/g, '');
        const priceText = cells[4].textContent.replace(/[^\d.]/g, '');

        document.getElementById('unitCost').value = costText;
        document.getElementById('sellingPrice').value = priceText;

        // Extract stock
        const stockBadge = cells[5].querySelector('.badge');
        if (stockBadge) {
            document.getElementById('currentStock').value = stockBadge.textContent.trim();
        }

        // Set active status
        const statusBadge = cells[6].querySelector('.badge');
        const isActive = statusBadge && statusBadge.classList.contains('bg-success');
        document.getElementById('isActive').checked = isActive;
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

function deleteProduct(productId) {
    console.log('ğŸ”µ Products - Delete Product function called for ID:', productId);

    const message = '{% if session.get('language', 'ar') == 'ar' %}Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ{% else %}Are you sure you want to delete this product?{% endif %}';

    if (confirm(message)) {
        const deleteBtn = document.querySelector(`button[onclick="deleteProduct(${productId})"]`);
        if (deleteBtn) {
            showLoading(deleteBtn);
        }

        // Call API to delete product
        fetch(`/api/products/delete/${productId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (deleteBtn) {
                hideLoading(deleteBtn);
            }

            if (data.success) {
                showToast(data.message || '{% if session.get('language', 'ar') == 'ar' %}ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­{% else %}Product deleted successfully{% endif %}', 'success');

                // Remove row from table
                if (deleteBtn) {
                    deleteBtn.closest('tr').remove();
                }

                // Clear selection if this was the selected product
                if (selectedProductId === productId) {
                    selectedProductId = null;
                }
            } else {
                showToast(data.message || '{% if session.get('language', 'ar') == 'ar' %}Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬{% else %}Error deleting product{% endif %}', 'danger');
            }
        })
        .catch(error => {
            if (deleteBtn) {
                hideLoading(deleteBtn);
            }
            console.error('Error:', error);
            showToast('{% if session.get('language', 'ar') == 'ar' %}Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…{% else %}Server connection error{% endif %}', 'danger');
        });
    }
}

function saveProduct() {
    console.log('ğŸ”µ Products - Save Product function called');

    const form = document.getElementById('productForm');

    if (!validateForm(form)) {
        showToast('{% if session.get('language', 'ar') == 'ar' %}ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©{% else %}Please fill all required fields{% endif %}', 'warning');
        return;
    }

    const saveBtn = document.querySelector('#productModal .btn-primary');
    showLoading(saveBtn);

    // Get form data
    const formData = {
        product_code: document.getElementById('productCode').value,
        product_name: document.getElementById('productName').value,
        description: document.getElementById('description').value,
        unit_cost: parseFloat(document.getElementById('unitCost').value || 0),
        selling_price: parseFloat(document.getElementById('sellingPrice').value || 0),
        category: document.getElementById('category').value,
        unit_type: document.getElementById('unitType').value,
        min_stock_level: parseInt(document.getElementById('minStock').value || 0),
        current_stock: parseInt(document.getElementById('currentStock').value || 0),
        is_active: document.getElementById('isActive').checked
    };

    // Determine if this is an edit or new product
    const isEdit = currentProductId !== null;
    const url = isEdit ? `/api/products/edit/${currentProductId}` : '/api/products/save';
    const method = isEdit ? 'PUT' : 'POST';

    // Call API
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        hideLoading(saveBtn);

        if (data.success) {
            showToast(data.message || '{% if session.get('language', 'ar') == 'ar' %}ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­{% else %}Product saved successfully{% endif %}', 'success');

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            modal.hide();

            // Reload page to show updated data
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.message || '{% if session.get('language', 'ar') == 'ar' %}Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬{% else %}Error saving product{% endif %}', 'danger');
        }
    })
    .catch(error => {
        hideLoading(saveBtn);
        console.error('Error:', error);
        showToast('{% if session.get('language', 'ar') == 'ar' %}Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…{% else %}Server connection error{% endif %}', 'danger');
    });
}

function exportProducts() {
    showToast(isRTL ? 'Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...' : 'Exporting products...', 'info');
    // Implement export functionality
}

// Reset modal when closed
document.getElementById('productModal')?.addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('productForm');
    form.reset();
    clearFormValidation(form);
    document.getElementById('productId').value = '';
});

// Refresh data
function refreshData() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...' : 'Refreshing...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showToast(isRTL ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Data refreshed successfully', 'success');
    }, 1500);
}

// Generate report
function generateReport() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Generating...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showToast(isRTL ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Products report generated successfully', 'success');
    }, 1500);
}

// Export data
function exportData() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...' : 'Exporting...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showToast(isRTL ? 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Data exported successfully', 'success');
    }, 1500);
}

// Save all data
function saveAllData() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + (isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Saving...');

    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showToast(isRTL ? 'ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'All data saved successfully', 'success');
    }, 1500);
}

// Print report
function printReport() {
    showToast(isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©...' : 'Preparing report for printing...', 'info');
    setTimeout(() => {
        window.print();
    }, 1000);
}

// Delete selected
function deleteSelected() {
    showToast(isRTL ? 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' : 'Please select at least one product', 'warning');
}

// Export products
function exportProducts() {
    showToast(isRTL ? 'Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...' : 'Exporting products...', 'info');
    // Here you would implement the actual export functionality
    setTimeout(() => {
        showToast(isRTL ? 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Products exported successfully', 'success');
    }, 1500);
}

// Print products list
function printProductsList() {
    showToast(isRTL ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©...' : 'Preparing products list for printing...', 'info');
    setTimeout(() => {
        window.print();
    }, 1000);
}
</script>
{% endblock %}
