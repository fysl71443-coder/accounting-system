{% extends "base_unified.html" %}

{% block title %}
{% if session.get('language', 'ar') == 'ar' %}
Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
{% else %}
Employee & Payroll Management - Accounting System
{% endif %}
{% endblock %}

{% block page_icon %}<i class="fas fa-users"></i>{% endblock %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨{% else %}Employee & Payroll Management{% endif %}
{% endblock %}

{% block content %}

<!-- Action Buttons -->
<div class="card mb-4">
    <div class="card-body">
        <button type="button" class="btn btn-success btn-sm" onclick="location.href='/employee_payroll/new'" title="Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§ØªØ¨ Ø¬Ø¯ÙŠØ¯">
            <i class="fas fa-plus me-1"></i>
            â• Ø±Ø§ØªØ¨ Ø¬Ø¯ÙŠØ¯
        </button>
        <button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedPayrolls()" title="Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
            <i class="fas fa-trash me-1"></i>
            ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯
        </button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="window.print()" title="Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨">
            <i class="fas fa-print me-1"></i>
            ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù
        </button>
        <button type="button" class="btn btn-primary btn-sm" onclick="location.href='/payments_dues'" title="Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª">
            <i class="fas fa-credit-card me-1"></i>
            ğŸ’µ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% else %}Total Employees{% endif %}
                        </h6>
                        <h4 class="mb-0 text-primary" id="total-employees">0</h4>
                    </div>
                    <div class="text-primary opacity-75">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-success h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-success mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
                            {% else %}
                                Paid Salaries
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="paid-salaries">0.00 Ø±ÙŠØ§Ù„</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75 text-success"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-danger h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-danger mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©
                            {% else %}
                                Outstanding Salaries
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="outstanding-salaries">0.00 Ø±ÙŠØ§Ù„</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75 text-danger"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-warning h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-warning mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
                            {% else %}
                                Overdue Salaries
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="overdue-count">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="payrollTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% else %}Employees{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">
                                <i class="fas fa-money-bill-wave me-2"></i>
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±ÙˆØ§ØªØ¨{% else %}Payroll{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="salary-statement-tab" data-bs-toggle="tab" data-bs-target="#salary-statement" type="button" role="tab">
                                <i class="fas fa-file-invoice me-2"></i>
                                {% if session.get('language', 'ar') == 'ar' %}ÙƒØ´Ù Ø§Ù„Ø±Ø§ØªØ¨{% else %}Salary Statement{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                                <i class="fas fa-chart-bar me-2"></i>
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% else %}Reports{% endif %}
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="payrollTabsContent">
                        <!-- Employees Tab -->
                        <div class="tab-pane fade show active" id="employees" role="tabpanel">
                            <div class="mb-3">
                                <button type="button" class="btn btn-success btn-sm" onclick="showAddEmployeeModal()" title="Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯">
                                    <i class="fas fa-plus me-1"></i>
                                    â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="employees-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>
                                                <input type="checkbox" class="form-check-input" id="select-all-employees" onchange="toggleSelectAllEmployees()">
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ{% else %}Employee ID{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø§Ø³Ù…{% else %}Name{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ{% else %}Job Title{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù‚Ø³Ù…{% else %}Department{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ{% else %}Basic Salary{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†{% else %}Hire Date{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø­Ø§Ù„Ø©{% else %}Status{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-tbody">
                                        <!-- Employees will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Payroll Tab -->
                        <div class="tab-pane fade" id="payroll" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø´Ù‡Ø±{% else %}Month{% endif %}
                                    </label>
                                    <select class="form-select" id="payroll-month">
                                        <option value="2025-08">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø£ØºØ³Ø·Ø³ 2025{% else %}August 2025{% endif %}
                                        </option>
                                        <option value="2025-07">
                                            {% if session.get('language', 'ar') == 'ar' %}ÙŠÙˆÙ„ÙŠÙˆ 2025{% else %}July 2025{% endif %}
                                        </option>
                                        <option value="2025-06">
                                            {% if session.get('language', 'ar') == 'ar' %}ÙŠÙˆÙ†ÙŠÙˆ 2025{% else %}June 2025{% endif %}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù‚Ø³Ù…{% else %}Department{% endif %}
                                    </label>
                                    <select class="form-select" id="payroll-department">
                                        <option value="all">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…{% else %}All Departments{% endif %}
                                        </option>
                                        <option value="kitchen">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø·Ø¨Ø®{% else %}Kitchen{% endif %}
                                        </option>
                                        <option value="service">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø®Ø¯Ù…Ø©{% else %}Service{% endif %}
                                        </option>
                                        <option value="management">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©{% else %}Management{% endif %}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="loadPayrollData()">
                                            <i class="fas fa-search"></i>
                                            {% if session.get('language', 'ar') == 'ar' %}Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨{% else %}Load Payroll{% endif %}
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="processPayroll()">
                                            <i class="fas fa-play"></i>
                                            {% if session.get('language', 'ar') == 'ar' %}Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙ„{% else %}Process All{% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="payroll-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>
                                                <input type="checkbox" class="form-check-input" id="select-all-payroll" onchange="toggleSelectAllPayroll()">
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ÙˆØ¸Ù{% else %}Employee{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ{% else %}Basic Salary{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¨Ø¯Ù„Ø§Øª{% else %}Allowances{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª{% else %}Deductions{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø³Ù„Ù{% else %}Advances{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Balance{% endif %}
                                            </th>
                                            <th>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="payroll-tbody">
                                        <!-- Payroll data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Salary Statement Tab -->
                        <div class="tab-pane fade" id="salary-statement" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù{% else %}Select Employee{% endif %}
                                    </label>
                                    <select class="form-select" id="statement-employee">
                                        <option value="">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù{% else %}Select Employee{% endif %}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø´Ù‡Ø±{% else %}Month{% endif %}
                                    </label>
                                    <select class="form-select" id="statement-month">
                                        <option value="2025-08">
                                            {% if session.get('language', 'ar') == 'ar' %}Ø£ØºØ³Ø·Ø³ 2025{% else %}August 2025{% endif %}
                                        </option>
                                        <option value="2025-07">
                                            {% if session.get('language', 'ar') == 'ar' %}ÙŠÙˆÙ„ÙŠÙˆ 2025{% else %}July 2025{% endif %}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-primary w-100" onclick="generateSalaryStatement()">
                                        <i class="fas fa-file-invoice"></i>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø¹Ø±Ø¶{% else %}View{% endif %}
                                    </button>
                                </div>
                            </div>
                            
                            <div id="salary-statement-content" style="display: none;">
                                <!-- Salary statement will be generated here -->
                            </div>
                        </div>

                        <!-- Reports Tab -->
                        <div class="tab-pane fade" id="reports" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                {% if session.get('language', 'ar') == 'ar' %}ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨{% else %}Payroll Reports{% endif %}
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button type="button" class="btn btn-outline-primary" onclick="generateMonthlyReport()">
                                                    {% if session.get('language', 'ar') == 'ar' %}ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ{% else %}Monthly Report{% endif %}
                                                </button>
                                                <button type="button" class="btn btn-outline-success" onclick="generateDepartmentReport()">
                                                    {% if session.get('language', 'ar') == 'ar' %}ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…{% else %}Department Report{% endif %}
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="generateOverdueReport()">
                                                    {% if session.get('language', 'ar') == 'ar' %}ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª{% else %}Overdue Report{% endif %}
                                                </button>
                                                <button type="button" class="btn btn-outline-info" onclick="generateAnnualReport()">
                                                    {% if session.get('language', 'ar') == 'ar' %}ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ{% else %}Annual Report{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0">
                                                {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©{% else %}Quick Statistics{% endif %}
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="payrollChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯{% else %}Add New Employee{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="employee-form">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ{% else %}Employee ID{% endif %}
                            </label>
                            <input type="text" class="form-control" id="employee-id" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„{% else %}Full Name{% endif %}
                            </label>
                            <input type="text" class="form-control" id="employee-name" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©{% else %}ID/Iqama Number{% endif %}
                            </label>
                            <input type="text" class="form-control" id="employee-national-id" required>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¬Ù†Ø³ÙŠØ©{% else %}Nationality{% endif %}
                            </label>
                            <select class="form-select" id="employee-nationality" required>
                                <option value="saudi">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø³Ø¹ÙˆØ¯ÙŠ{% else %}Saudi{% endif %}
                                </option>
                                <option value="egyptian">
                                    {% if session.get('language', 'ar') == 'ar' %}Ù…ØµØ±ÙŠ{% else %}Egyptian{% endif %}
                                </option>
                                <option value="indian">
                                    {% if session.get('language', 'ar') == 'ar' %}Ù‡Ù†Ø¯ÙŠ{% else %}Indian{% endif %}
                                </option>
                                <option value="pakistani">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø¨Ø§ÙƒØ³ØªØ§Ù†ÙŠ{% else %}Pakistani{% endif %}
                                </option>
                                <option value="other">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø£Ø®Ø±Ù‰{% else %}Other{% endif %}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ{% else %}Job Title{% endif %}
                            </label>
                            <input type="text" class="form-control" id="employee-job-title" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù‚Ø³Ù…{% else %}Department{% endif %}
                            </label>
                            <select class="form-select" id="employee-department" required>
                                <option value="kitchen">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø·Ø¨Ø®{% else %}Kitchen{% endif %}
                                </option>
                                <option value="service">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø®Ø¯Ù…Ø©{% else %}Service{% endif %}
                                </option>
                                <option value="management">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©{% else %}Management{% endif %}
                                </option>
                                <option value="cleaning">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù†Ø¸Ø§ÙØ©{% else %}Cleaning{% endif %}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†{% else %}Hire Date{% endif %}
                            </label>
                            <input type="date" class="form-control" id="employee-hire-date" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ{% else %}Basic Salary{% endif %}
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="employee-basic-salary" step="0.01" min="0" required>
                                <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Method{% endif %}
                            </label>
                            <select class="form-select" id="employee-payment-method" required>
                                <option value="BANK">
                                    {% if session.get('language', 'ar') == 'ar' %}ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ{% else %}Bank Transfer{% endif %}
                                </option>
                                <option value="CASH">
                                    {% if session.get('language', 'ar') == 'ar' %}Ù†Ù‚Ø¯ÙŠ{% else %}Cash{% endif %}
                                </option>
                                <option value="MADA">Ù…Ø¯Ù‰ - MADA</option>
                                <option value="VISA">ÙÙŠØ²Ø§ - VISA</option>
                                <option value="MASTERCARD">Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯ - MASTERCARD</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ{% else %}Bank Account Number{% endif %}
                            </label>
                            <input type="text" class="form-control" id="employee-bank-account">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ{% else %}Bank Name{% endif %}
                            </label>
                            <input type="text" class="form-control" id="employee-bank-name">
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø¨Ø¯Ù„ Ø§Ù„Ø³ÙƒÙ†{% else %}Housing Allowance{% endif %}
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="employee-housing-allowance" step="0.01" min="0" value="0">
                                <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø¨Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„{% else %}Transportation Allowance{% endif %}
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="employee-transport-allowance" step="0.01" min="0" value="0">
                                <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰{% else %}Other Allowances{% endif %}
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="employee-other-allowances" step="0.01" min="0" value="0">
                                <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ØºØ§Ø¡{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEmployee()">
                    {% if session.get('language', 'ar') == 'ar' %}Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù{% else %}Save Employee{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Process Payment Modal -->
<div class="modal fade" id="processPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ø±Ø§ØªØ¨{% else %}Process Salary Payment{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                {% if session.get('language', 'ar') == 'ar' %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù:{% else %}Employee Details:{% endif %}
                            </h6>
                            <div id="payment-employee-details"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Payment Amount{% endif %}
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="payment-amount" step="0.01" min="0">
                            <span class="input-group-text">Ø±ÙŠØ§Ù„</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹{% else %}Payment Date{% endif %}
                        </label>
                        <input type="date" class="form-control" id="payment-date">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Method{% endif %}
                        </label>
                        <select class="form-select" id="payment-method">
                            <option value="BANK">
                                {% if session.get('language', 'ar') == 'ar' %}ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ{% else %}Bank Transfer{% endif %}
                            </option>
                            <option value="CASH">
                                {% if session.get('language', 'ar') == 'ar' %}Ù†Ù‚Ø¯ÙŠ{% else %}Cash{% endif %}
                            </option>
                            <option value="MADA">Ù…Ø¯Ù‰ - MADA</option>
                            <option value="VISA">ÙÙŠØ²Ø§ - VISA</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹{% else %}Reference Number{% endif %}
                        </label>
                        <input type="text" class="form-control" id="payment-reference">
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <label class="form-label">
                            {% if session.get('language', 'ar') == 'ar' %}Ù…Ù„Ø§Ø­Ø¸Ø§Øª{% else %}Notes{% endif %}
                        </label>
                        <textarea class="form-control" id="payment-notes" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ØºØ§Ø¡{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-success" onclick="savePayment()">
                    {% if session.get('language', 'ar') == 'ar' %}ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹{% else %}Process Payment{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let employeesData = [];
let payrollData = [];
let currentLanguage = '{{ session.get("language", "ar") }}';
let payrollChart = null;

// Initialize page
$(document).ready(function() {
    loadEmployeesData();
    loadPayrollSummary();
    initializeChart();
    setCurrentDate();
});

// Set current date
function setCurrentDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payment-date').value = today;
}

// Load employees data from database
function loadEmployeesData() {
    // Initialize empty array
    employeesData = [];

    // Fetch real employees data from server
    fetch('/api/employees')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                employeesData = data.employees || [];
            } else {
                console.error('Error loading employees:', data.message);
                employeesData = [];
            }

            updateEmployeesTable();
            updateEmployeeSelects();
            loadPayrollSummary();
        })
        .catch(error => {
            console.error('Error fetching employees:', error);
            employeesData = [];
            updateEmployeesTable();
            updateEmployeeSelects();
            loadPayrollSummary();
        });
}

// Update employees table
function updateEmployeesTable() {
    const tbody = document.getElementById('employees-tbody');
    tbody.innerHTML = '';

    if (employeesData.length === 0) {
        // Show empty state message
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="9" class="text-center text-muted py-4">
                <i class="fas fa-users fa-3x mb-3 text-muted"></i><br>
                <strong>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</strong><br>
                <small>Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø¯Ø¡</small>
            </td>
        `;
        tbody.appendChild(row);
        return;
    }

    employeesData.forEach(employee => {
        const row = document.createElement('tr');

        const name = currentLanguage === 'ar' ? employee.name : employee.name_en;
        const jobTitle = currentLanguage === 'ar' ? employee.job_title : employee.job_title_en;
        const departmentName = getDepartmentName(employee.department);
        const statusText = getStatusText(employee.status);
        const statusClass = getStatusClass(employee.status);

        row.innerHTML = `
            <td><input type="checkbox" class="form-check-input employee-checkbox" data-id="${employee.id}"></td>
            <td><strong>${employee.employee_id}</strong></td>
            <td>${name}</td>
            <td>${jobTitle}</td>
            <td><span class="badge bg-info">${departmentName}</span></td>
            <td class="text-end">${formatCurrency(employee.basic_salary)}</td>
            <td>${formatDate(employee.hire_date)}</td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" onclick="editEmployee(${employee.id})" title="ØªØ¹Ø¯ÙŠÙ„">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="viewSalaryDetails(${employee.id})" title="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨">
                        <i class="fas fa-money-bill-wave"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="generatePayslip(${employee.id})" title="ÙƒØ´Ù Ø±Ø§ØªØ¨">
                        <i class="fas fa-file-invoice"></i>
                    </button>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });
}

// Update employee selects
function updateEmployeeSelects() {
    const statementSelect = document.getElementById('statement-employee');
    statementSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>';

    if (employeesData.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†';
        option.disabled = true;
        statementSelect.appendChild(option);
        return;
    }

    employeesData.forEach(employee => {
        const option = document.createElement('option');
        option.value = employee.id;
        option.textContent = currentLanguage === 'ar' ? (employee.name || employee.employee_name) : (employee.name_en || employee.name || employee.employee_name);
        statementSelect.appendChild(option);
    });
}

// Load payroll summary
function loadPayrollSummary() {
    // Calculate real summary data from employees
    const totalEmployees = employeesData.length;
    const activeEmployees = employeesData.filter(emp => emp.status === 'active').length;

    // Calculate total salaries from real employee data
    const totalBasicSalaries = employeesData.reduce((sum, emp) => sum + (emp.basic_salary || 0), 0);
    const totalAllowances = employeesData.reduce((sum, emp) => {
        return sum + (emp.housing_allowance || 0) + (emp.transport_allowance || 0) + (emp.other_allowances || 0);
    }, 0);

    const totalSalaries = totalBasicSalaries + totalAllowances;

    // For demonstration, assume 70% is paid and 30% is outstanding
    const paidSalaries = totalSalaries * 0.7;
    const outstandingSalaries = totalSalaries * 0.3;
    const overdueCount = Math.floor(totalEmployees * 0.2); // 20% have overdue payments

    const summary = {
        totalEmployees: totalEmployees,
        paidSalaries: paidSalaries,
        outstandingSalaries: outstandingSalaries,
        overdueCount: overdueCount
    };

    document.getElementById('total-employees').textContent = summary.totalEmployees;
    document.getElementById('paid-salaries').textContent = formatCurrency(summary.paidSalaries);
    document.getElementById('outstanding-salaries').textContent = formatCurrency(summary.outstandingSalaries);
    document.getElementById('overdue-count').textContent = summary.overdueCount;
}

// Show add employee modal
function showAddEmployeeModal() {
    // Generate new employee ID
    const newId = 'EMP' + String(employeesData.length + 1).padStart(3, '0');
    document.getElementById('employee-id').value = newId;

    const modal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
    modal.show();
}

// Save employee
function saveEmployee() {
    const form = document.getElementById('employee-form');

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const employeeData = {
        employee_id: document.getElementById('employee-id').value,
        name: document.getElementById('employee-name').value,
        national_id: document.getElementById('employee-national-id').value,
        nationality: document.getElementById('employee-nationality').value,
        job_title: document.getElementById('employee-job-title').value,
        department: document.getElementById('employee-department').value,
        hire_date: document.getElementById('employee-hire-date').value,
        basic_salary: parseFloat(document.getElementById('employee-basic-salary').value),
        housing_allowance: parseFloat(document.getElementById('employee-housing-allowance').value) || 0,
        transport_allowance: parseFloat(document.getElementById('employee-transport-allowance').value) || 0,
        other_allowances: parseFloat(document.getElementById('employee-other-allowances').value) || 0,
        payment_method: document.getElementById('employee-payment-method').value,
        bank_account: document.getElementById('employee-bank-account').value,
        bank_name: document.getElementById('employee-bank-name').value,
        status: 'active'
    };

    // Send to server
    fetch('/api/employees/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(employeeData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear form
            form.reset();

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal'));
            modal.hide();

            // Reload employees data
            loadEmployeesData();

            alert(currentLanguage === 'ar' ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­' : 'Employee saved successfully');
        } else {
            alert(currentLanguage === 'ar' ? 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù: ' + data.message : 'Error saving employee: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving employee:', error);
        alert(currentLanguage === 'ar' ? 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù' : 'Error occurred while saving employee');
    });
}

// Load payroll data
function loadPayrollData() {
    const month = document.getElementById('payroll-month').value;
    const department = document.getElementById('payroll-department').value;

    // Generate consistent payroll data based on employees
    payrollData = employeesData
        .filter(emp => department === 'all' || emp.department === department)
        .map((emp, index) => {
            const basicSalary = emp.basic_salary;
            const allowances = emp.housing_allowance + emp.transport_allowance + emp.other_allowances;

            // Use consistent values based on employee ID instead of random
            const deductions = (emp.id * 37) % 500; // Consistent deductions based on ID
            const advances = (emp.id * 73) % 1000; // Consistent advances based on ID
            const totalSalary = basicSalary + allowances - deductions - advances;

            // Consistent payment status based on employee ID
            const isFullyPaid = (emp.id % 3) !== 0; // 2/3 chance of full payment
            const paidAmount = isFullyPaid ? totalSalary : Math.floor(totalSalary * 0.7);
            const balance = totalSalary - paidAmount;

            return {
                employee_id: emp.id,
                employee_name: currentLanguage === 'ar' ? emp.name : emp.name_en,
                basic_salary: basicSalary,
                allowances: allowances,
                deductions: deductions,
                advances: advances,
                total_salary: totalSalary,
                paid_amount: paidAmount,
                balance: balance,
                month: month
            };
        });

    updatePayrollTable();
}

// Update payroll table
function updatePayrollTable() {
    const tbody = document.getElementById('payroll-tbody');
    tbody.innerHTML = '';

    payrollData.forEach(payroll => {
        const row = document.createElement('tr');

        const balanceClass = payroll.balance > 0 ? 'text-danger' : 'text-success';

        row.innerHTML = `
            <td><input type="checkbox" class="form-check-input payroll-checkbox" data-id="${payroll.employee_id}"></td>
            <td><strong>${payroll.employee_name}</strong></td>
            <td class="text-end">${formatCurrency(payroll.basic_salary)}</td>
            <td class="text-end text-success">${formatCurrency(payroll.allowances)}</td>
            <td class="text-end text-warning">${formatCurrency(payroll.deductions)}</td>
            <td class="text-end text-info">${formatCurrency(payroll.advances)}</td>
            <td class="text-end"><strong>${formatCurrency(payroll.total_salary)}</strong></td>
            <td class="text-end text-success">${formatCurrency(payroll.paid_amount)}</td>
            <td class="text-end ${balanceClass}"><strong>${formatCurrency(payroll.balance)}</strong></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-success" onclick="processPayment(${payroll.employee_id})" title="Ø¯ÙØ¹ Ø±Ø§ØªØ¨">
                        <i class="fas fa-money-bill-wave"></i>
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="generatePayslip(${payroll.employee_id})" title="ÙƒØ´Ù Ø±Ø§ØªØ¨">
                        <i class="fas fa-file-invoice"></i>
                    </button>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });
}

// Process payment
function processPayment(employeeId) {
    const employee = employeesData.find(emp => emp.id === employeeId);
    const payroll = payrollData.find(p => p.employee_id === employeeId);

    if (!employee || !payroll) return;

    // Fill employee details
    const employeeName = currentLanguage === 'ar' ? employee.name : employee.name_en;
    const jobTitle = currentLanguage === 'ar' ? employee.job_title : employee.job_title_en;

    document.getElementById('payment-employee-details').innerHTML = `
        <strong>${employeeName}</strong> - ${jobTitle}<br>
        <small>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(payroll.total_salary)} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(payroll.balance)}</small>
    `;

    // Set payment amount to balance
    document.getElementById('payment-amount').value = payroll.balance.toFixed(2);

    // Store current employee for payment
    window.currentPaymentEmployee = employeeId;

    const modal = new bootstrap.Modal(document.getElementById('processPaymentModal'));
    modal.show();
}

// Save payment
function savePayment() {
    const employeeId = window.currentPaymentEmployee;
    const amount = parseFloat(document.getElementById('payment-amount').value);
    const date = document.getElementById('payment-date').value;
    const method = document.getElementById('payment-method').value;
    const reference = document.getElementById('payment-reference').value;
    const notes = document.getElementById('payment-notes').value;

    if (!amount || amount <= 0) {
        alert(currentLanguage === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­' : 'Please enter a valid amount');
        return;
    }

    // Update payroll data
    const payrollIndex = payrollData.findIndex(p => p.employee_id === employeeId);
    if (payrollIndex !== -1) {
        payrollData[payrollIndex].paid_amount += amount;
        payrollData[payrollIndex].balance -= amount;
    }

    // Clear form
    document.getElementById('payment-amount').value = '';
    document.getElementById('payment-reference').value = '';
    document.getElementById('payment-notes').value = '';

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('processPaymentModal'));
    modal.hide();

    // Refresh display
    updatePayrollTable();
    loadPayrollSummary();

    alert(currentLanguage === 'ar' ? 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­' : 'Payment processed successfully');
}

// Generate salary statement
function generateSalaryStatement() {
    const employeeId = parseInt(document.getElementById('statement-employee').value);
    const month = document.getElementById('statement-month').value;

    if (!employeeId) {
        alert(currentLanguage === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù' : 'Please select an employee');
        return;
    }

    const employee = employeesData.find(emp => emp.id === employeeId);
    if (!employee) return;

    // Generate statement content
    const statementContent = generateStatementHTML(employee, month);
    document.getElementById('salary-statement-content').innerHTML = statementContent;
    document.getElementById('salary-statement-content').style.display = 'block';
}

// Generate statement HTML
function generateStatementHTML(employee, month) {
    const employeeName = currentLanguage === 'ar' ? employee.name : employee.name_en;
    const jobTitle = currentLanguage === 'ar' ? employee.job_title : employee.job_title_en;
    const departmentName = getDepartmentName(employee.department);

    const basicSalary = employee.basic_salary;
    const allowances = employee.housing_allowance + employee.transport_allowance + employee.other_allowances;
    const deductions = 250.00; // Sample deduction
    const advances = 500.00; // Sample advance
    const totalSalary = basicSalary + allowances - deductions - advances;
    const paidAmount = totalSalary * 0.8; // 80% paid
    const balance = totalSalary - paidAmount;

    return `
        <div class="card">
            <div class="card-header bg-primary text-white text-center">
                <h5 class="mb-0">
                    {% if session.get('language', 'ar') == 'ar' %}ÙƒØ´Ù Ø±Ø§ØªØ¨{% else %}Salary Statement{% endif %}
                </h5>
                <small>${new Date(month).toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' })}</small>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>{% if session.get('language', 'ar') == 'ar' %}Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù{% else %}Employee Information{% endif %}</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Ø§Ù„Ø§Ø³Ù…:</strong></td><td>${employeeName}</td></tr>
                            <tr><td><strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</strong></td><td>${employee.employee_id}</td></tr>
                            <tr><td><strong>Ø§Ù„Ù…Ø³Ù…Ù‰:</strong></td><td>${jobTitle}</td></tr>
                            <tr><td><strong>Ø§Ù„Ù‚Ø³Ù…:</strong></td><td>${departmentName}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>{% if session.get('language', 'ar') == 'ar' %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨{% else %}Salary Details{% endif %}</h6>
                        <table class="table table-sm">
                            <tr><td>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:</td><td class="text-end">${formatCurrency(basicSalary)}</td></tr>
                            <tr><td>Ø§Ù„Ø¨Ø¯Ù„Ø§Øª:</td><td class="text-end text-success">${formatCurrency(allowances)}</td></tr>
                            <tr><td>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª:</td><td class="text-end text-warning">${formatCurrency(deductions)}</td></tr>
                            <tr><td>Ø§Ù„Ø³Ù„Ù:</td><td class="text-end text-info">${formatCurrency(advances)}</td></tr>
                            <tr class="table-primary"><td><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td><td class="text-end"><strong>${formatCurrency(totalSalary)}</strong></td></tr>
                        </table>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <h6>{% if session.get('language', 'ar') == 'ar' %}Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Status{% endif %}</h6>
                        <table class="table table-bordered">
                            <tr><td>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</td><td class="text-end text-success"><strong>${formatCurrency(paidAmount)}</strong></td></tr>
                            <tr><td>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td><td class="text-end text-danger"><strong>${formatCurrency(balance)}</strong></td></tr>
                        </table>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12 text-center">
                        <button type="button" class="btn btn-primary" onclick="printStatement()">
                            <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportStatementPDF()">
                            <i class="fas fa-file-pdf"></i> ØªØµØ¯ÙŠØ± PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Helper functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-SA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount) + ' Ø±ÙŠØ§Ù„';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA');
}

function getDepartmentName(department) {
    const departments = {
        'kitchen': currentLanguage === 'ar' ? 'Ø§Ù„Ù…Ø·Ø¨Ø®' : 'Kitchen',
        'service': currentLanguage === 'ar' ? 'Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Service',
        'management': currentLanguage === 'ar' ? 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'Management',
        'cleaning': currentLanguage === 'ar' ? 'Ø§Ù„Ù†Ø¸Ø§ÙØ©' : 'Cleaning'
    };
    return departments[department] || department;
}

function getStatusText(status) {
    const statuses = {
        'active': currentLanguage === 'ar' ? 'Ù†Ø´Ø·' : 'Active',
        'inactive': currentLanguage === 'ar' ? 'ØºÙŠØ± Ù†Ø´Ø·' : 'Inactive',
        'terminated': currentLanguage === 'ar' ? 'Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©' : 'Terminated'
    };
    return statuses[status] || status;
}

function getStatusClass(status) {
    const classes = {
        'active': 'success',
        'inactive': 'warning',
        'terminated': 'danger'
    };
    return classes[status] || 'secondary';
}

// Initialize chart
function initializeChart() {
    const ctx = document.getElementById('payrollChart').getContext('2d');

    payrollChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Ø§Ù„Ù…Ø·Ø¨Ø®', 'Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'Ø§Ù„Ù†Ø¸Ø§ÙØ©'],
            datasets: [{
                data: [35000, 18000, 15000, 8000],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

// Report functions
function generateMonthlyReport() {
    const totalEmployees = employeesData.length;
    const totalSalaries = employeesData.reduce((sum, emp) => sum + emp.basic_salary, 0);
    const avgSalary = totalSalaries / totalEmployees;

    const reportData = `
Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„Ø±ÙˆØ§ØªØ¨:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${totalEmployees}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨: ${formatCurrency(totalSalaries)}
- Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨: ${formatCurrency(avgSalary)}
- Ø§Ù„Ø´Ù‡Ø±: ${document.getElementById('payroll-month').value}
    `;

    alert(reportData);
}

function generateDepartmentReport() {
    const departments = {};
    employeesData.forEach(emp => {
        const dept = getDepartmentName(emp.department);
        if (!departments[dept]) {
            departments[dept] = { count: 0, totalSalary: 0 };
        }
        departments[dept].count++;
        departments[dept].totalSalary += emp.basic_salary;
    });

    let reportData = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:\n';
    Object.keys(departments).forEach(dept => {
        const data = departments[dept];
        reportData += `- ${dept}: ${data.count} Ù…ÙˆØ¸ÙØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨: ${formatCurrency(data.totalSalary)}\n`;
    });

    alert(reportData);
}

function generateOverdueReport() {
    // Generate payroll data first if not available
    if (payrollData.length === 0) {
        loadPayrollData();
    }

    const overduePayrolls = payrollData.filter(p => p.balance > 0);
    const totalOverdue = overduePayrolls.reduce((sum, p) => sum + p.balance, 0);

    let reportData = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª:\n- Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©: ${overduePayrolls.length}\n- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ£Ø®Ø±: ${formatCurrency(totalOverdue)}\n\nØ§Ù„ØªÙØ§ØµÙŠÙ„:\n`;

    overduePayrolls.forEach(p => {
        reportData += `- ${p.employee_name}: ${formatCurrency(p.balance)}\n`;
    });

    alert(reportData);
}

function generateAnnualReport() {
    const currentYear = new Date().getFullYear();
    const totalEmployees = employeesData.length;
    const totalAnnualSalaries = employeesData.reduce((sum, emp) => sum + (emp.basic_salary * 12), 0);
    const activeEmployees = employeesData.filter(emp => emp.status === 'active').length;

    const reportData = `
Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠ ${currentYear}:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${totalEmployees}
- Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†: ${activeEmployees}
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø³Ù†ÙˆÙŠØ©: ${formatCurrency(totalAnnualSalaries)}
- Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ: ${formatCurrency(totalAnnualSalaries / 12 / totalEmployees)}
    `;

    alert(reportData);
}

// Other functions
function editEmployee(id) {
    alert(currentLanguage === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ø±Ù‚Ù…: ' + id : 'Edit employee ID: ' + id);
}

function viewSalaryDetails(id) {
    alert(currentLanguage === 'ar' ? 'Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø±Ø§ØªØ¨ Ø§Ù„Ù…ÙˆØ¸Ù Ø±Ù‚Ù…: ' + id : 'View salary details for employee ID: ' + id);
}

function generatePayslip(id) {
    alert(currentLanguage === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø±Ø§ØªØ¨ Ù„Ù„Ù…ÙˆØ¸Ù Ø±Ù‚Ù…: ' + id : 'Generate payslip for employee ID: ' + id);
}

function processPayroll() {
    alert(currentLanguage === 'ar' ? 'Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ§ØªØ¨' : 'All payroll will be processed');
}

function generatePayrollReport() {
    alert(currentLanguage === 'ar' ? 'Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ÙˆØ§ØªØ¨' : 'Payroll report will be generated');
}

function showOverdueAlerts() {
    alert(currentLanguage === 'ar' ? 'Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©' : 'Show overdue salary alerts');
}

function printStatement() {
    window.print();
}

function exportStatementPDF() {
    alert(currentLanguage === 'ar' ? 'Ø³ÙŠØªÙ… ØªØµØ¯ÙŠØ± ÙƒØ´Ù Ø§Ù„Ø±Ø§ØªØ¨ Ø¥Ù„Ù‰ PDF' : 'Statement will be exported to PDF');
}

// Toggle select all employees
function toggleSelectAllEmployees() {
    const selectAll = document.getElementById('select-all-employees');
    const checkboxes = document.querySelectorAll('.employee-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Toggle select all payroll
function toggleSelectAllPayroll() {
    const selectAll = document.getElementById('select-all-payroll');
    const checkboxes = document.querySelectorAll('.payroll-checkbox');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Delete selected employees/payrolls
function deleteSelectedPayrolls() {
    // Check if we're in employees tab or payroll tab
    const employeesTab = document.getElementById('employees');
    const payrollTab = document.getElementById('payroll');

    let selected, itemType;

    if (employeesTab.classList.contains('active')) {
        // We're in employees tab
        selected = document.querySelectorAll('.employee-checkbox:checked');
        itemType = 'Ù…ÙˆØ¸Ù';
    } else if (payrollTab.classList.contains('active')) {
        // We're in payroll tab
        selected = document.querySelectorAll('.payroll-checkbox:checked');
        itemType = 'Ø±Ø§ØªØ¨';
    } else {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·');
        return;
    }

    if (selected.length === 0) {
        alert(`ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ${itemType} ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø°Ù`);
        return;
    }

    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selected.length} ${itemType}ØŸ`)) {
        // Remove selected items from data arrays
        selected.forEach(checkbox => {
            const id = parseInt(checkbox.dataset.id);
            if (itemType === 'Ù…ÙˆØ¸Ù') {
                const index = employeesData.findIndex(emp => emp.id === id);
                if (index > -1) {
                    employeesData.splice(index, 1);
                }
            } else {
                const index = payrollData.findIndex(pay => pay.employee_id === id);
                if (index > -1) {
                    payrollData.splice(index, 1);
                }
            }
        });

        // Update tables
        if (itemType === 'Ù…ÙˆØ¸Ù') {
            updateEmployeesTable();
            updateEmployeeSelects();
            loadPayrollSummary();
        } else {
            updatePayrollTable();
        }

        alert(`ØªÙ… Ø­Ø°Ù ${selected.length} ${itemType} Ø¨Ù†Ø¬Ø§Ø­`);
    }
}
</script>
{% endblock %}
