{% extends "base_unified.html" %}

{% block title %}
{% if session.get('language', 'ar') == 'ar' %}
Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
{% else %}
Purchases Management - Accounting System
{% endif %}
{% endblock %}

{% block page_icon %}<i class="fas fa-shopping-cart"></i>{% endblock %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª{% else %}Purchases Management{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯ */
    .table tbody tr.table-active {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .table tbody tr.table-active:hover {
        background-color: #e3f2fd !important;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± radio button */
    .table tbody tr input[type="radio"] {
        transform: scale(1.2);
        margin: 0;
    }

    .stats-card {
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .table-responsive {
        border-radius: 0.375rem;
    }
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin: 0 1px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª{% else %}Total Purchases{% endif %}
                        </h6>
                        <h4 class="mb-0 text-primary" id="total-purchases">0.00 Ø±ÙŠØ§Ù„</h4>
                    </div>
                    <div class="text-primary opacity-75">
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}
                        </h6>
                        <h4 class="mb-0 text-success" id="paid-purchases">0.00 Ø±ÙŠØ§Ù„</h4>
                    </div>
                    <div class="text-success opacity-75">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1 text-muted small">
                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø³ØªØ­Ù‚{% else %}Pending{% endif %}
                        </h6>
                        <h4 class="mb-0 text-warning" id="pending-purchases">0.00 Ø±ÙŠØ§Ù„</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75 text-warning"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-start border-4 border-info h-100">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-info mb-1">
                            {% if session.get('language', 'ar') == 'ar' %}
                                Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                            {% else %}
                                Invoices Count
                            {% endif %}
                        </h6>
                        <h3 class="mb-0" id="invoices-count">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-file-invoice fa-2x opacity-75 text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª{% else %}Actions{% endif %}
                        </h6>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ -->
                    <div class="btn-group me-3 mb-2" role="group">
                        <button type="button" class="btn btn-success" id="btnPurchaseAdd" title="Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©">
                            <i class="fas fa-plus me-1"></i>
                            ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                        <button type="button" class="btn btn-outline-success" id="btnPurchaseAdvanced" title="Ù†Ù…ÙˆØ°Ø¬ Ù…ØªÙ‚Ø¯Ù…">
                            <i class="fas fa-plus-circle me-1"></i>
                            Ù†Ù…ÙˆØ°Ø¬ Ù…ØªÙ‚Ø¯Ù…
                        </button>
                    </div>

                    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
                    <div class="btn-group me-3 mb-2" role="group">
                        <button type="button" id="btnPurchasesPrint" class="btn btn-primary" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                            <i class="fas fa-print me-1"></i>
                            Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                        <button type="button" id="btnPurchasesPreview" class="btn btn-info" title="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                            <i class="fas fa-eye me-1"></i>
                            Ù…Ø¹Ø§ÙŠÙ†Ø©
                        </button>
                        <button type="button" id="btnPurchasesExport" class="btn btn-secondary" title="ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
                            <i class="fas fa-download me-1"></i>
                            ØªØµØ¯ÙŠØ±
                        </button>
                    </div>

                    <div class="btn-group me-3 mb-2" role="group">
                        <button type="button" id="btnPurchasesPayment" class="btn btn-success" title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                            <i class="fas fa-money-bill-wave me-1"></i>
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
                        </button>
                    </div>

                    <div class="btn-group me-3 mb-2" role="group">
                        <button type="button" id="btnPurchasesEdit" class="btn btn-warning" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                            <i class="fas fa-edit me-1"></i>
                            ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button type="button" id="btnPurchasesDelete" class="btn btn-danger" title="Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                            <i class="fas fa-trash me-1"></i>
                            Ø­Ø°Ù
                        </button>
                    </div>

                    <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© -->
                    <div class="btn-group mb-2" role="group">
                        <button type="button" class="btn btn-outline-primary" id="btnPurchasesPayments" title="Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª">
                            <i class="fas fa-money-check me-1"></i>
                            Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="btnPurchasesRefresh" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                            <i class="fas fa-sync me-1"></i>
                            ØªØ­Ø¯ÙŠØ«
                        </button>
                    </div>
                    <div id="purchasesButtonResults" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        {% if session.get('language', 'ar') == 'ar' %}
                            ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                        {% else %}
                            Filter Purchases
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ù…Ù† ØªØ§Ø±ÙŠØ®{% else %}From Date{% endif %}
                            </label>
                            <input type="date" class="form-control" id="from-date">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®{% else %}To Date{% endif %}
                            </label>
                            <input type="date" class="form-control" id="to-date">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ÙˆØ±Ø¯{% else %}Supplier{% endif %}
                            </label>
                            <select class="form-select" id="filter-supplier">
                                <option value="all">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†{% else %}All Suppliers{% endif %}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Status{% endif %}
                            </label>
                            <select class="form-select" id="filter-status">
                                <option value="all">
                                    {% if session.get('language', 'ar') == 'ar' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª{% else %}All Status{% endif %}
                                </option>
                                <option value="paid">
                                    {% if session.get('language', 'ar') == 'ar' %}Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}
                                </option>
                                <option value="pending">
                                    {% if session.get('language', 'ar') == 'ar' %}Ù…Ø³ØªØ­Ù‚{% else %}Pending{% endif %}
                                </option>
                                <option value="partial">
                                    {% if session.get('language', 'ar') == 'ar' %}Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹{% else %}Partially Paid{% endif %}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" onclick="filterPurchases()">
                                <i class="fas fa-search"></i>
                                {% if session.get('language', 'ar') == 'ar' %}Ø¨Ø­Ø«{% else %}Search{% endif %}
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                                {% if session.get('language', 'ar') == 'ar' %}Ù…Ø³Ø­{% else %}Clear{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchases Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">
                        {% if session.get('language', 'ar') == 'ar' %}
                            Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                        {% else %}
                            Purchase Invoices List
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 50px;">
                                        {% if session.get('language', 'ar') == 'ar' %}ØªØ­Ø¯ÙŠØ¯{% else %}Select{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice No{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ÙˆØ±Ø¯{% else %}Supplier{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ{% else %}Subtotal{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø®ØµÙ…{% else %}Discount{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Remaining{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Status{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Method{% endif %}
                                    </th>
                                    <th>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="purchases-tbody">
                                <!-- Purchase invoices will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- New Purchase Invoice Modal -->
<div class="modal fade" id="newPurchaseModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}
                        <i class="fas fa-plus"></i> ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©
                    {% else %}
                        <i class="fas fa-plus"></i> New Purchase Invoice
                    {% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="purchase-form" class="purchases-form" data-auto-save="/api/purchases/create" data-method="POST">
                    <!-- Invoice Header -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        {% if session.get('language', 'ar') == 'ar' %}Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice Information{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                {% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice Number{% endif %}
                                            </label>
                                            <input type="text" class="form-control" id="invoice-number" readonly>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}
                                            </label>
                                            <input type="date" class="form-control" id="invoice-date" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ÙˆØ±Ø¯{% else %}Supplier{% endif %}
                                            </label>
                                            <select class="form-select" id="supplier-select" required>
                                                <option value="">
                                                    {% if session.get('language', 'ar') == 'ar' %}Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯{% else %}Select Supplier{% endif %}
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                {% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Method{% endif %}
                                            </label>
                                            <select class="form-select" id="payment-method" required>
                                                <option value="CASH">
                                                    {% if session.get('language', 'ar') == 'ar' %}Ù†Ù‚Ø¯ÙŠ{% else %}Cash{% endif %}
                                                </option>
                                                <option value="MADA">Ù…Ø¯Ù‰ - MADA</option>
                                                <option value="VISA">ÙÙŠØ²Ø§ - VISA</option>
                                                <option value="MASTERCARD">Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯ - MASTERCARD</option>
                                                <option value="BANK">
                                                    {% if session.get('language', 'ar') == 'ar' %}ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ{% else %}Bank Transfer{% endif %}
                                                </option>
                                                <option value="CREDIT">
                                                    {% if session.get('language', 'ar') == 'ar' %}Ø¢Ø¬Ù„{% else %}Credit{% endif %}
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        {% if session.get('language', 'ar') == 'ar' %}Ø£ØµÙ†Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice Items{% endif %}
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-success" onclick="addProductRow()">
                                        <i class="fas fa-plus"></i>
                                        {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù{% else %}Add Item{% endif %}
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-bordered mb-0" id="products-table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30%">
                                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬{% else %}Product Name{% endif %}
                                                    </th>
                                                    <th style="width: 15%">
                                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙƒÙ…ÙŠØ©{% else %}Quantity{% endif %}
                                                    </th>
                                                    <th style="width: 15%">
                                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙˆØ­Ø¯Ø©{% else %}Unit{% endif %}
                                                    </th>
                                                    <th style="width: 15%">
                                                        {% if session.get('language', 'ar') == 'ar' %}Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©{% else %}Unit Price{% endif %}
                                                    </th>
                                                    <th style="width: 15%">
                                                        {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total{% endif %}
                                                    </th>
                                                    <th style="width: 10%">
                                                        {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ø±Ø§Ø¡{% else %}Action{% endif %}
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="products-tbody">
                                                <!-- Product rows will be added here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Totals -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        {% if session.get('language', 'ar') == 'ar' %}Ù…Ù„Ø§Ø­Ø¸Ø§Øª{% else %}Notes{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <textarea class="form-control" id="invoice-notes" rows="4" placeholder="{% if session.get('language', 'ar') == 'ar' %}Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©...{% else %}Enter any additional notes...{% endif %}"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        {% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice Totals{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <td>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:{% else %}Subtotal:{% endif %}
                                            </td>
                                            <td class="text-end" id="subtotal">0.00 Ø±ÙŠØ§Ù„</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <i class="fas fa-percentage me-1"></i>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø®ØµÙ…:{% else %}Discount:{% endif %}
                                            </td>
                                            <td class="text-end text-danger" id="discount-amount">0.00 Ø±ÙŠØ§Ù„</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (15%):{% else %}VAT (15%):{% endif %}
                                            </td>
                                            <td class="text-end" id="vat-amount">0.00 Ø±ÙŠØ§Ù„</td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>
                                                {% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:{% else %}Grand Total:{% endif %}
                                            </strong></td>
                                            <td class="text-end"><strong id="grand-total">0.00 Ø±ÙŠØ§Ù„</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„ØºØ§Ø¡{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-success" onclick="savePurchaseInvoice()">
                    {% if session.get('language', 'ar') == 'ar' %}Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Save Invoice{% endif %}
                </button>
                <button type="button" class="btn btn-primary" onclick="savePurchaseInvoice(true)">
                    {% if session.get('language', 'ar') == 'ar' %}Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø©{% else %}Save & Print{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let purchasesData = [];
let suppliersData = [];
let productsData = [];
let currentLanguage = '{{ session.get("language", "ar") }}';
let productRowCounter = 0;

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// Initialize page
$(document).ready(function() {
    loadSuppliersData();
    loadProductsData();
    loadPurchasesData();
    setCurrentDate();
    generateInvoiceNumber();
});

// Set current date
function setCurrentDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoice-date').value = today;
    document.getElementById('from-date').value = today;
    document.getElementById('to-date').value = today;
}

// Generate invoice number
function generateInvoiceNumber() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');

    const invoiceNumber = `PUR-${year}${month}${day}-${random}`;
    document.getElementById('invoice-number').value = invoiceNumber;
}

// Load suppliers data
function loadSuppliersData() {
    // Sample suppliers data
    suppliersData = [
        {
            id: 1,
            name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©',
            name_en: 'United Food Materials Company',
            contact: '0112345678',
            email: 'info@ufmc.com'
        },
        {
            id: 2,
            name: 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„ÙÙˆØ§ÙƒÙ‡',
            name_en: 'Vegetables & Fruits Est.',
            contact: '0112345679',
            email: 'sales@vfest.com'
        },
        {
            id: 3,
            name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù„Ø­ÙˆÙ… Ø§Ù„Ø·Ø§Ø²Ø¬Ø©',
            name_en: 'Fresh Meat Company',
            contact: '0112345680',
            email: 'orders@freshmeats.com'
        },
        {
            id: 4,
            name: 'Ù…ØµÙ†Ø¹ Ø§Ù„Ø£Ù„Ø¨Ø§Ù† Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©',
            name_en: 'Golden Dairy Factory',
            contact: '0112345681',
            email: 'info@goldendairy.com'
        },
        {
            id: 5,
            name: 'Ø´Ø±ÙƒØ© Ø§Ù„ØªÙˆØ§Ø¨Ù„ ÙˆØ§Ù„Ø¨Ù‡Ø§Ø±Ø§Øª',
            name_en: 'Spices & Seasonings Co.',
            contact: '0112345682',
            email: 'sales@spicescompany.com'
        }
    ];

    updateSuppliersDropdown();
}

// Update suppliers dropdown
function updateSuppliersDropdown() {
    const supplierSelect = document.getElementById('supplier-select');
    const filterSupplier = document.getElementById('filter-supplier');

    // Clear existing options (except first)
    supplierSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ±Ø¯</option>';
    filterSupplier.innerHTML = '<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</option>';

    suppliersData.forEach(supplier => {
        const supplierName = currentLanguage === 'ar' ? supplier.name : supplier.name_en;

        // Add to main dropdown
        const option1 = document.createElement('option');
        option1.value = supplier.id;
        option1.textContent = supplierName;
        supplierSelect.appendChild(option1);

        // Add to filter dropdown
        const option2 = document.createElement('option');
        option2.value = supplier.id;
        option2.textContent = supplierName;
        filterSupplier.appendChild(option2);
    });
}

// Load products data
function loadProductsData() {
    // Sample products data
    productsData = [
        {
            id: 1,
            name: 'Ø£Ø±Ø² Ø¨Ø³Ù…ØªÙŠ',
            name_en: 'Basmati Rice',
            unit: 'ÙƒÙŠØ³ 25 ÙƒÙŠÙ„Ùˆ',
            unit_en: '25kg Bag',
            cost_price: 85.00
        },
        {
            id: 2,
            name: 'Ø²ÙŠØª Ø§Ù„Ø·Ø¨Ø®',
            name_en: 'Cooking Oil',
            unit: 'Ø¬Ø§Ù„ÙˆÙ† 4 Ù„ØªØ±',
            unit_en: '4L Gallon',
            cost_price: 32.50
        },
        {
            id: 3,
            name: 'Ø¯Ø¬Ø§Ø¬ Ø·Ø§Ø²Ø¬',
            name_en: 'Fresh Chicken',
            unit: 'ÙƒÙŠÙ„Ùˆ',
            unit_en: 'Kg',
            cost_price: 18.00
        },
        {
            id: 4,
            name: 'Ø·Ù…Ø§Ø·Ù…',
            name_en: 'Tomatoes',
            unit: 'ÙƒÙŠÙ„Ùˆ',
            unit_en: 'Kg',
            cost_price: 4.50
        },
        {
            id: 5,
            name: 'Ø¨ØµÙ„',
            name_en: 'Onions',
            unit: 'ÙƒÙŠÙ„Ùˆ',
            unit_en: 'Kg',
            cost_price: 3.20
        },
        {
            id: 6,
            name: 'Ù„Ø­Ù… Ø¨Ù‚Ø±ÙŠ',
            name_en: 'Beef',
            unit: 'ÙƒÙŠÙ„Ùˆ',
            unit_en: 'Kg',
            cost_price: 45.00
        },
        {
            id: 7,
            name: 'Ø­Ù„ÙŠØ¨ Ø·Ø§Ø²Ø¬',
            name_en: 'Fresh Milk',
            unit: 'Ù„ØªØ±',
            unit_en: 'Liter',
            cost_price: 6.50
        },
        {
            id: 8,
            name: 'Ø¯Ù‚ÙŠÙ‚ Ø£Ø¨ÙŠØ¶',
            name_en: 'White Flour',
            unit: 'ÙƒÙŠØ³ 50 ÙƒÙŠÙ„Ùˆ',
            unit_en: '50kg Bag',
            cost_price: 95.00
        }
    ];
}

// Load purchases data from server
function loadPurchasesData() {
    console.log('ğŸ” Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…...');

    fetch('/api/purchases/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                purchasesData = data.data;
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.count} ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª`);
                updatePurchasesTable();
                updateSummaryCards();
            } else {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', data.message);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                loadSampleData();
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            loadSampleData();
        });
}

// Load sample data as fallback
function loadSampleData() {
    console.log('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©');
    purchasesData = [
        {
            id: 1,
            invoice_number: 'PUR-20250804-001',
            date: '2025-08-04',
            supplier_name: 'Ø´Ø±ÙƒØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©',
            subtotal: 2500.00,
            vat_amount: 375.00,
            total: 2875.00,
            payment_method: 'BANK',
            status: 'paid',
            items: [
                {product_name: 'Ø£Ø±Ø² Ø¨Ø³Ù…ØªÙŠ', quantity: 20, unit_price: 85.00, total: 1700.00},
                {product_name: 'Ø²ÙŠØª Ø§Ù„Ø·Ø¨Ø®', quantity: 25, unit_price: 32.00, total: 800.00}
            ]
        }
    ];

    updatePurchasesTable();
    updateSummaryCards();
}

// Update purchases table
function updatePurchasesTable() {
    const tbody = document.getElementById('purchases-tbody');
    tbody.innerHTML = '';

    purchasesData.forEach(purchase => {
        const row = document.createElement('tr');

        const statusText = getStatusText(purchase.status);
        const statusClass = getStatusClass(purchase.status);
        const paymentMethodText = getPaymentMethodText(purchase.payment_method);

        row.innerHTML = `
            <td class="text-center">
                <input type="radio" name="selected_purchase" value="${purchase.id}"
                       data-invoice-number="${purchase.invoice_number}"
                       class="form-check-input">
            </td>
            <td><strong>${purchase.invoice_number}</strong></td>
            <td>${formatDate(purchase.date)}</td>
            <td>${purchase.supplier_name}</td>
            <td class="text-end">${formatCurrency(purchase.subtotal)}</td>
            <td class="text-end">${formatCurrency(purchase.vat_amount)}</td>
            <td class="text-end"><strong>${formatCurrency(purchase.total)}</strong></td>
            <td><span class="badge bg-info">${paymentMethodText}</span></td>
            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            <td>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewPurchase(${purchase.id})" title="Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;

        // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        row.addEventListener('click', function(e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if (e.target.closest('button') || e.target.closest('a')) {
                return;
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
            document.querySelectorAll('.table tbody tr').forEach(r => r.classList.remove('table-active'));

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
            this.classList.add('table-active');

            // ØªØ­Ø¯ÙŠØ¯ radio button Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
            const radioButton = this.querySelector('input[name="selected_purchase"]');
            if (radioButton) {
                radioButton.checked = true;

                // ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                selectedPurchaseId = parseInt(radioButton.value);
                updatePurchaseButtonStates();

                console.log(`Selected purchase: ${selectedPurchaseId}`);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const supplierName = this.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const amount = this.cells[6]?.textContent?.trim() || '0';

                showNotification(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${radioButton.dataset.invoiceNumber || '#' + selectedPurchaseId}\nØ§Ù„Ù…ÙˆØ±Ø¯: ${supplierName} | Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}`, 'info');
            }
        });

        // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ù„Ù€ radio button
        const radioButton = row.querySelector('input[name="selected_purchase"]');
        if (radioButton) {
            radioButton.addEventListener('change', function() {
                if (this.checked) {
                    selectedPurchaseId = parseInt(this.value);
                    updatePurchaseButtonStates();

                    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
                    document.querySelectorAll('.table tbody tr').forEach(r => r.classList.remove('table-active'));

                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
                    const selectedRow = this.closest('tr');
                    if (selectedRow) {
                        selectedRow.classList.add('table-active');
                    }

                    console.log(`Selected purchase: ${selectedPurchaseId}`);

                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                    const row = this.closest('tr');
                    const supplierName = row.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const amount = row.cells[6]?.textContent?.trim() || '0';

                    showNotification(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${this.dataset.invoiceNumber || '#' + selectedPurchaseId}\nØ§Ù„Ù…ÙˆØ±Ø¯: ${supplierName} | Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}`, 'info');
                }
            });
        }

        tbody.appendChild(row);
    });

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
    updatePurchaseButtonStates();
}

// Update summary cards
function updateSummaryCards() {
    let totalPurchases = 0;
    let paidPurchases = 0;
    let pendingPurchases = 0;

    purchasesData.forEach(purchase => {
        totalPurchases += purchase.total;

        if (purchase.status === 'paid') {
            paidPurchases += purchase.total;
        } else {
            pendingPurchases += purchase.total;
        }
    });

    document.getElementById('total-purchases').textContent = formatCurrency(totalPurchases);
    document.getElementById('paid-purchases').textContent = formatCurrency(paidPurchases);
    document.getElementById('pending-purchases').textContent = formatCurrency(pendingPurchases);
    document.getElementById('invoices-count').textContent = purchasesData.length;
}

// Show new purchase modal
function showNewPurchaseModal() {
    generateInvoiceNumber();
    setCurrentDate();
    clearProductRows();
    addProductRow(); // Add first row

    const modal = new bootstrap.Modal(document.getElementById('newPurchaseModal'));
    modal.show();
}

// Add product row
function addProductRow() {
    productRowCounter++;
    const tbody = document.getElementById('products-tbody');
    const row = document.createElement('tr');
    row.id = `product-row-${productRowCounter}`;

    row.innerHTML = `
        <td>
            <select class="form-select product-select" onchange="updateProductInfo(${productRowCounter})" required>
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬</option>
                ${productsData.map(product =>
                    `<option value="${product.id}" data-price="${product.cost_price}" data-unit="${currentLanguage === 'ar' ? product.unit : product.unit_en}">
                        ${currentLanguage === 'ar' ? product.name : product.name_en}
                    </option>`
                ).join('')}
            </select>
        </td>
        <td>
            <input type="number" class="form-control quantity-input" min="1" step="0.01" onchange="calculateRowTotal(${productRowCounter})" required>
        </td>
        <td>
            <input type="text" class="form-control unit-input" readonly>
        </td>
        <td>
            <input type="number" class="form-control price-input" min="0" step="0.01" onchange="calculateRowTotal(${productRowCounter})" required>
        </td>
        <td>
            <input type="number" class="form-control total-input" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeProductRow(${productRowCounter})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(row);
}

// Update product info when product is selected
function updateProductInfo(rowId) {
    const row = document.getElementById(`product-row-${rowId}`);
    const productSelect = row.querySelector('.product-select');
    const selectedOption = productSelect.options[productSelect.selectedIndex];

    if (selectedOption.value) {
        const price = parseFloat(selectedOption.dataset.price);
        const unit = selectedOption.dataset.unit;

        row.querySelector('.price-input').value = price.toFixed(2);
        row.querySelector('.unit-input').value = unit;

        calculateRowTotal(rowId);
    }
}

// Calculate row total
function calculateRowTotal(rowId) {
    const row = document.getElementById(`product-row-${rowId}`);
    const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
    const price = parseFloat(row.querySelector('.price-input').value) || 0;
    const total = quantity * price;

    row.querySelector('.total-input').value = total.toFixed(2);

    calculateInvoiceTotals();
}

// Remove product row
function removeProductRow(rowId) {
    const row = document.getElementById(`product-row-${rowId}`);
    if (row) {
        row.remove();
        calculateInvoiceTotals();
    }
}

// Clear all product rows
function clearProductRows() {
    const tbody = document.getElementById('products-tbody');
    tbody.innerHTML = '';
    productRowCounter = 0;
}

// Calculate invoice totals
function calculateInvoiceTotals() {
    const totalInputs = document.querySelectorAll('.total-input');
    let subtotal = 0;

    totalInputs.forEach(input => {
        subtotal += parseFloat(input.value) || 0;
    });

    const vatAmount = subtotal * 0.15; // 15% VAT
    const grandTotal = subtotal + vatAmount;

    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('vat-amount').textContent = formatCurrency(vatAmount);
    document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
}

// Save purchase invoice
function savePurchaseInvoice(printAfterSave = false) {
    const form = document.getElementById('purchase-form');

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Collect form data
    const invoiceData = {
        invoice_number: document.getElementById('invoice-number').value,
        date: document.getElementById('invoice-date').value,
        supplier_id: parseInt(document.getElementById('supplier-select').value),
        payment_method: document.getElementById('payment-method').value,
        notes: document.getElementById('invoice-notes').value,
        items: []
    };

    // Collect product items
    const productRows = document.querySelectorAll('#products-tbody tr');
    productRows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const quantity = parseFloat(row.querySelector('.quantity-input').value);
        const price = parseFloat(row.querySelector('.price-input').value);
        const total = parseFloat(row.querySelector('.total-input').value);

        if (productSelect.value && quantity && price) {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            invoiceData.items.push({
                product_id: parseInt(productSelect.value),
                product_name: selectedOption.text,
                quantity: quantity,
                unit: row.querySelector('.unit-input').value,
                unit_price: price,
                total: total
            });
        }
    });

    if (invoiceData.items.length === 0) {
        showNotification(currentLanguage === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' : 'Please add at least one product', 'error');
        return;
    }

    // Calculate totals
    const subtotal = invoiceData.items.reduce((sum, item) => sum + item.total, 0);
    const vatAmount = subtotal * 0.15;
    const grandTotal = subtotal + vatAmount;

    invoiceData.subtotal = subtotal;
    invoiceData.vat_amount = vatAmount;
    invoiceData.total = grandTotal;

    // Get supplier name
    const supplierName = suppliersData.find(s => s.id === invoiceData.supplier_id);
    invoiceData.supplier_name = currentLanguage === 'ar' ? supplierName.name : supplierName.name_en;
    invoiceData.status = invoiceData.payment_method === 'CREDIT' ? 'pending' : 'paid';

    // Add to purchases data
    invoiceData.id = purchasesData.length + 1;
    purchasesData.push(invoiceData);

    // Update display
    updatePurchasesTable();
    updateSummaryCards();

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('newPurchaseModal'));
    modal.hide();

    // Clear form
    form.reset();
    clearProductRows();

    showNotification(currentLanguage === 'ar' ? 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'Invoice saved successfully', 'success');

    if (printAfterSave) {
        printPurchase(invoiceData.id);
    }

    // Reload page after short delay
    setTimeout(() => location.reload(), 1500);
}

// Helper functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('ar-SA', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount) + ' Ø±ÙŠØ§Ù„';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA');
}

function getStatusText(status) {
    const statuses = {
        'paid': currentLanguage === 'ar' ? 'Ù…Ø¯ÙÙˆØ¹' : 'Paid',
        'pending': currentLanguage === 'ar' ? 'Ù…Ø³ØªØ­Ù‚' : 'Pending',
        'partial': currentLanguage === 'ar' ? 'Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹' : 'Partially Paid'
    };
    return statuses[status] || status;
}

function getStatusClass(status) {
    const classes = {
        'paid': 'success',
        'pending': 'warning',
        'partial': 'info'
    };
    return classes[status] || 'secondary';
}

function getPaymentMethodText(method) {
    const methods = {
        'CASH': currentLanguage === 'ar' ? 'Ù†Ù‚Ø¯ÙŠ' : 'Cash',
        'MADA': 'Ù…Ø¯Ù‰',
        'VISA': 'ÙÙŠØ²Ø§',
        'MASTERCARD': 'Ù…Ø§Ø³ØªØ±ÙƒØ§Ø±Ø¯',
        'BANK': currentLanguage === 'ar' ? 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ' : 'Bank Transfer',
        'CREDIT': currentLanguage === 'ar' ? 'Ø¢Ø¬Ù„' : 'Credit'
    };
    return methods[method] || method;
}

// Action functions
function viewPurchase(id) {
    const purchase = purchasesData.find(p => p.id === id);
    if (purchase) {
        // Create detailed view modal
        const modalContent = `
            <div class="modal fade" id="viewPurchaseModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${purchase.invoice_number}
                                </div>
                                <div class="col-md-6">
                                    <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(purchase.date)}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${purchase.supplier_name}
                                </div>
                                <div class="col-md-6">
                                    <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${getPaymentMethodText(purchase.payment_method)}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
                                    <span class="badge bg-${getStatusClass(purchase.status)}">${getStatusText(purchase.status)}</span>
                                </div>
                            </div>

                            <h6>Ø£ØµÙ†Ø§Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${purchase.items.map(item => `
                                            <tr>
                                                <td>${item.product_name}</td>
                                                <td>${item.quantity}</td>
                                                <td>${item.unit}</td>
                                                <td>${formatCurrency(item.unit_price)}</td>
                                                <td>${formatCurrency(item.total)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="4"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</strong></td>
                                            <td><strong>${formatCurrency(purchase.subtotal)}</strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="4"><strong>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (15%):</strong></td>
                                            <td><strong>${formatCurrency(purchase.vat_amount)}</strong></td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td colspan="4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong></td>
                                            <td><strong>${formatCurrency(purchase.total)}</strong></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                            <button type="button" class="btn btn-primary" onclick="printPurchase(${purchase.id})">
                                <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('viewPurchaseModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalContent);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('viewPurchaseModal'));
        modal.show();
    }
}

function editPurchase(id) {
    const purchase = purchasesData.find(p => p.id === id);
    if (purchase) {
        // Show confirmation
        if (confirm(currentLanguage === 'ar' ?
            `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${purchase.invoice_number}ØŸ` :
            `Do you want to edit invoice ${purchase.invoice_number}?`)) {

            // Here you would typically open the edit modal
            // For now, we'll show a placeholder
            showToast(
                currentLanguage === 'ar' ?
                `Ø³ÙŠØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${purchase.invoice_number}` :
                `Edit window for invoice ${purchase.invoice_number} will open`,
                'info'
            );
        }
    }
}

// ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙØµÙ„Ø­Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù

// ØªÙ… Ø­Ø°Ù ÙˆØ¸ÙŠÙØ© deletePurchase - Ø§Ù„Ø­Ø°Ù ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± form Ù…Ø¨Ø§Ø´Ø±Ø©

// Generate print content
function generatePrintContent(purchase) {
    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª - ${purchase.invoice_number}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .invoice-info { margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; }
                .total-row { font-weight: bold; background-color: #f9f9f9; }
                .barcode { text-align: center; margin: 20px 0; font-family: monospace; font-size: 24px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
                <h2>Purchase Invoice</h2>
            </div>

            <div class="invoice-info">
                <p><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> ${purchase.invoice_number}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${formatDate(purchase.date)}</p>
                <p><strong>Ø§Ù„Ù…ÙˆØ±Ø¯:</strong> ${purchase.supplier_name}</p>
                <p><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${getPaymentMethodText(purchase.payment_method)}</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    ${purchase.items.map(item => `
                        <tr>
                            <td>${item.product_name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td>${formatCurrency(item.unit_price)}</td>
                            <td>${formatCurrency(item.total)}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</strong></td>
                        <td><strong>${formatCurrency(purchase.subtotal)}</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4"><strong>Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© (15%):</strong></td>
                        <td><strong>${formatCurrency(purchase.vat_amount)}</strong></td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="4"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong></td>
                        <td><strong>${formatCurrency(purchase.total)}</strong></td>
                    </tr>
                </tfoot>
            </table>

            <div class="barcode">
                <p>||||| ${purchase.invoice_number} |||||</p>
            </div>

            <div style="margin-top: 50px;">
                <p>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: ________________</p>
                <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}</p>
            </div>
        </body>
        </html>
    `;
}

// Filter and export functions
function filterPurchases() {
    const fromDate = document.getElementById('from-date').value;
    const toDate = document.getElementById('to-date').value;
    const supplier = document.getElementById('filter-supplier').value;
    const status = document.getElementById('filter-status').value;

    console.log('Filtering purchases:', { fromDate, toDate, supplier, status });

    let filteredData = [...purchasesData];

    // Filter by date
    if (fromDate) {
        filteredData = filteredData.filter(p => p.date >= fromDate);
    }
    if (toDate) {
        filteredData = filteredData.filter(p => p.date <= toDate);
    }

    // Filter by supplier
    if (supplier !== 'all') {
        filteredData = filteredData.filter(p => p.supplier_id == supplier);
    }

    // Filter by status
    if (status !== 'all') {
        filteredData = filteredData.filter(p => p.status === status);
    }

    // Update display with filtered data
    const originalData = purchasesData;
    purchasesData = filteredData;
    updatePurchasesTable();
    updateSummaryCards();
    purchasesData = originalData;

    showToast(
        currentLanguage === 'ar' ?
        `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${filteredData.length} ÙØ§ØªÙˆØ±Ø©` :
        `Found ${filteredData.length} invoices`,
        'info'
    );
}

function clearFilters() {
    document.getElementById('from-date').value = '';
    document.getElementById('to-date').value = '';
    document.getElementById('filter-supplier').value = 'all';
    document.getElementById('filter-status').value = 'all';

    // Reset display
    updatePurchasesTable();
    updateSummaryCards();

    showToast(
        currentLanguage === 'ar' ? 'ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±' : 'Filters cleared',
        'success'
    );
}

function exportPurchases() {
    if (purchasesData.length === 0) {
        alert(currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±' : 'No data to export');
        return;
    }

    // Show loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (currentLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...' : 'Exporting...');
    btn.disabled = true;

    setTimeout(() => {
        // Generate CSV data
        const csvData = generatePurchasesCSV();

        // Create download link
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `purchases_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        // Restore button
        btn.innerHTML = originalText;
        btn.disabled = false;

        showToast(
            currentLanguage === 'ar' ? 'ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­' : 'Purchases exported successfully',
            'success'
        );
    }, 1500);
}

function generatePurchaseReport() {
    if (purchasesData.length === 0) {
        alert(currentLanguage === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±' : 'No data to generate report');
        return;
    }

    // Show loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (currentLanguage === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Generating...');
    btn.disabled = true;

    setTimeout(() => {
        // Generate report
        const reportContent = generatePurchaseReportContent();

        // Open in new window
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(reportContent);
        reportWindow.document.close();

        // Restore button
        btn.innerHTML = originalText;
        btn.disabled = false;

        showToast(
            currentLanguage === 'ar' ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­' : 'Report generated successfully',
            'success'
        );
    }, 2000);
}

// Helper functions for purchases
function generatePurchasesCSV() {
    let csv = '\uFEFF'; // BOM for UTF-8
    csv += 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù…ÙˆØ±Ø¯,Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©,Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©,Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ,Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹,Ø§Ù„Ø­Ø§Ù„Ø©\n';

    purchasesData.forEach(purchase => {
        csv += `"${purchase.invoice_number}",`;
        csv += `"${formatDate(purchase.date)}",`;
        csv += `"${purchase.supplier_name}",`;
        csv += `"${purchase.subtotal}",`;
        csv += `"${purchase.vat_amount}",`;
        csv += `"${purchase.total}",`;
        csv += `"${getPaymentMethodText(purchase.payment_method)}",`;
        csv += `"${getStatusText(purchase.status)}"\n`;
    });

    return csv;
}

function generatePurchaseReportContent() {
    const totalPurchases = purchasesData.reduce((sum, p) => sum + p.total, 0);
    const paidPurchases = purchasesData.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.total, 0);
    const pendingPurchases = purchasesData.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.total, 0);

    return `
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                .summary { background: #f9f9f9; padding: 20px; margin-bottom: 30px; border-radius: 5px; }
                .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .status-paid { color: green; font-weight: bold; }
                .status-pending { color: orange; font-weight: bold; }
                .total-row { background-color: #e8f4f8; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h1>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString('ar-SA')}</p>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${purchasesData.length}</p>
            </div>

            <div class="summary">
                <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
                <div class="summary-item">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:</span>
                    <span>${formatCurrency(totalPurchases)}</span>
                </div>
                <div class="summary-item">
                    <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                    <span>${formatCurrency(paidPurchases)}</span>
                </div>
                <div class="summary-item">
                    <span>Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span>
                    <span>${formatCurrency(pendingPurchases)}</span>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                        <th>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    ${purchasesData.map(purchase => `
                        <tr>
                            <td>${purchase.invoice_number}</td>
                            <td>${formatDate(purchase.date)}</td>
                            <td>${purchase.supplier_name}</td>
                            <td>${formatCurrency(purchase.subtotal)}</td>
                            <td>${formatCurrency(purchase.vat_amount)}</td>
                            <td><strong>${formatCurrency(purchase.total)}</strong></td>
                            <td>${getPaymentMethodText(purchase.payment_method)}</td>
                            <td class="status-${purchase.status}">${getStatusText(purchase.status)}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                        <td><strong>${formatCurrency(totalPurchases)}</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </body>
        </html>
    `;
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
    toast.style.cssText = 'top: 20px; left: 20px; z-index: 9999;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', function() {
        document.body.removeChild(toast);
    });
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function openNewPurchaseModal() {
    // ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø¯ÙŠØ¯Ø©
    const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
    modal.show();
}

function exportPurchases() {
    // ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    showToast('Ø¬Ø§Ø±ÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');

    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµØ¯ÙŠØ± Ù‡Ù†Ø§
    setTimeout(() => {
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }, 1000);
}

function refreshPurchases() {
    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
    showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
    location.reload();
}

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙØ¹Ø© Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø­Ø¯Ø¯Ø©
function openPaymentModal(purchaseId) {
    // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª
    location.href = '/payments_dues';
}

// ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ÙƒØ±Ø±Ø© - Ø§Ù„Ø­Ø°Ù ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± form Ù…Ø¨Ø§Ø´Ø±Ø©

// ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - Ù…ÙØµÙ„Ø­Ø©
function printPurchase(id) {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:', id);
    window.open(`/print_purchase/${id}`, '_blank');
}

// Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function PrintPurchasesRecord() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_purchase"]:checked');
    if (!selectedRadio) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©', 'warning');
        return;
    }

    const purchaseId = selectedRadio.value;
    if (purchaseId) {
        window.open(`/print_purchase/${purchaseId}`, '_blank');
    } else {
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
    }
}

function PreviewPurchasesRecord() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_purchase"]:checked');
    if (!selectedRadio) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©', 'warning');
        return;
    }

    const purchaseId = selectedRadio.value;
    if (purchaseId) {
        window.open(`/preview_purchase/${purchaseId}`, '_blank');
    } else {
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
    }
}

function RegisterPurchasesPayment() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_purchase"]:checked');
    if (!selectedRadio) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©', 'warning');
        return;
    }

    const purchaseId = selectedRadio.value;
    if (purchaseId) {
        location.href = `/payments_dues?purchase_id=${purchaseId}`;
    } else {
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
    }
}

function EditPurchasesRecord() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_purchase"]:checked');
    if (!selectedRadio) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©', 'warning');
        return;
    }

    const purchaseId = selectedRadio.value;
    if (purchaseId) {
        window.location.href = `/purchases/edit/${purchaseId}`;
    } else {
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
    }
}

function DeletePurchasesRecord() {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_purchase"]:checked');
    if (!selectedRadio) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø­Ø°Ù Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©', 'warning');
        return;
    }

    const purchaseId = selectedRadio.value;
    const purchaseNumber = selectedRadio.dataset.invoiceNumber || `#${purchaseId}`;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ØµÙ
    const row = selectedRadio.closest('tr');
    const supplierName = row.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const amount = row.cells[6]?.textContent?.trim() || '0';

    if (!purchaseId) {
        showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${purchaseNumber}ØŸ\n\nØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:\nØ§Ù„Ù…ÙˆØ±Ø¯: ${supplierName}\nØ§Ù„Ù…Ø¨Ù„Øº: ${amount}\n\nâš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`;

    if (!confirm(confirmMessage)) {
        return;
    }
    fetch(`/api/purchases/delete/${purchaseId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showNotification(`âœ… ${data.message}`, 'success');

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const rowToRemove = selectedRadio.closest('tr');
            if (rowToRemove) {
                rowToRemove.style.transition = 'opacity 0.5s';
                rowToRemove.style.opacity = '0';
                setTimeout(() => {
                    rowToRemove.remove();
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    setTimeout(() => location.reload(), 500);
                }, 500);
            } else {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('âŒ Ø®Ø·Ø£: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
    });
}

// ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
function viewPurchase(purchaseId) {
    const row = document.querySelector(`tr[data-purchase-id="${purchaseId}"]`);
    if (row) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
        document.querySelectorAll('.table tbody tr').forEach(r => r.classList.remove('table-active'));
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
        row.classList.add('table-active');

        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§
        alert(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª #${purchaseId}`);
    }
}

// Global variables
let selectedPurchaseId = null;

// Update button states based on selection
function updatePurchaseButtonStates() {
    const hasSelection = selectedPurchaseId !== null;

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
    const editBtn = document.getElementById('btnPurchasesEdit');
    const deleteBtn = document.getElementById('btnPurchasesDelete');
    const printBtn = document.getElementById('btnPurchasesPrint');
    const previewBtn = document.getElementById('btnPurchasesPreview');
    const paymentBtn = document.getElementById('btnPurchasesPayment');

    [editBtn, deleteBtn, printBtn, previewBtn, paymentBtn].forEach(btn => {
        if (btn) {
            btn.disabled = !hasSelection;
            if (hasSelection) {
                btn.classList.remove('btn-outline-secondary');
            } else {
                btn.classList.add('btn-outline-secondary');
            }
        }
    });
}

// Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for radio button selection
    document.addEventListener('change', function(e) {
        if (e.target.name === 'selected_purchase') {
            selectedPurchaseId = parseInt(e.target.value);
            updatePurchaseButtonStates();

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
            document.querySelectorAll('.table tbody tr').forEach(r => r.classList.remove('table-active'));

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
            const selectedRow = e.target.closest('tr');
            if (selectedRow) {
                selectedRow.classList.add('table-active');
            }

            console.log(`Selected purchase: ${selectedPurchaseId}`);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            const row = e.target.closest('tr');
            const supplierName = row.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const amount = row.cells[6]?.textContent?.trim() || '0';

            showNotification(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${e.target.dataset.invoiceNumber || '#' + selectedPurchaseId}\nØ§Ù„Ù…ÙˆØ±Ø¯: ${supplierName} | Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}`, 'info');
        }
    });

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ Ø¨Ø§Ù„Ù†Ù‚Ø±
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if (e.target.closest('button') || e.target.closest('a')) {
                return;
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
            tableRows.forEach(r => r.classList.remove('table-active'));

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
            this.classList.add('table-active');

            // ØªØ­Ø¯ÙŠØ¯ radio button Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
            const radioButton = this.querySelector('input[name="selected_purchase"]');
            if (radioButton) {
                radioButton.checked = true;

                // ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                selectedPurchaseId = parseInt(radioButton.value);
                updatePurchaseButtonStates();

                console.log(`Selected purchase: ${selectedPurchaseId}`);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const supplierName = this.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const amount = this.cells[6]?.textContent?.trim() || '0';

                showNotification(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ${radioButton.dataset.invoiceNumber || '#' + selectedPurchaseId}\nØ§Ù„Ù…ÙˆØ±Ø¯: ${supplierName} | Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}`, 'info');
            }
        });
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    updatePurchaseButtonStates();

    console.log('Purchases page loaded successfully');
});

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ø§Ù„ØªÙŠ ØªØ¹Ù…Ù„
console.log('ğŸ”§ ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©...');

function addPurchase() {
    console.log('â• Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª');
    window.location.href = '/purchases/simple';
}

function addAdvancedPurchase() {
    console.log('â• Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©');
    window.location.href = '/purchases/new';
}

function editPurchase() {
    console.log('âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª');
    const selected = document.querySelector('input[name="selected_purchase"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.location.href = '/purchases/edit/' + selected.value;
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function deletePurchase() {
    console.log('ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª');
    const selected = document.querySelector('input[name="selected_purchase"]:checked');
    if (selected) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) {
            alert('âœ… Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ Ù‡Ù†Ø§
        }
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø­Ø°Ù Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function printPurchase() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª');
    const selected = document.querySelector('input[name="selected_purchase"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.open('/purchases/print/' + selected.value, '_blank');
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function previewPurchase() {
    console.log('ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª');
    const selected = document.querySelector('input[name="selected_purchase"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.open('/purchases/preview/' + selected.value, '_blank');
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function exportPurchases() {
    console.log('ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
    alert('âœ… Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠØ¹Ù…Ù„!');
    window.open('/api/purchases/export', '_blank');
}

function registerPurchasePayment() {
    console.log('ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù…Ø´ØªØ±ÙŠØ§Øª');
    const selected = document.querySelector('input[name="selected_purchase"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.location.href = '/payments/new?purchase=' + selected.value;
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function goToPayments() {
    console.log('ğŸ’³ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª');
    alert('âœ… Ø²Ø± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙŠØ¹Ù…Ù„!');
    window.location.href = '/payments_dues';
}

function refreshPurchases() {
    console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
    alert('âœ… Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØ¹Ù…Ù„!');
    location.reload();
}

// Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”— Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª...');

    const addBtn = document.getElementById('btnPurchaseAdd');
    const advancedBtn = document.getElementById('btnPurchaseAdvanced');
    const editBtn = document.getElementById('btnPurchasesEdit');
    const deleteBtn = document.getElementById('btnPurchasesDelete');
    const printBtn = document.getElementById('btnPurchasesPrint');
    const previewBtn = document.getElementById('btnPurchasesPreview');
    const exportBtn = document.getElementById('btnPurchasesExport');
    const paymentBtn = document.getElementById('btnPurchasesPayment');
    const paymentsBtn = document.getElementById('btnPurchasesPayments');
    const refreshBtn = document.getElementById('btnPurchasesRefresh');

    if (addBtn) {
        addBtn.addEventListener('click', addPurchase);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    }

    if (advancedBtn) {
        advancedBtn.addEventListener('click', addAdvancedPurchase);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…');
    }

    if (editBtn) {
        editBtn.addEventListener('click', editPurchase);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', deletePurchase);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­Ø°Ù');
    }

    if (printBtn) {
        printBtn.addEventListener('click', printPurchase);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
    }

    if (previewBtn) {
        previewBtn.addEventListener('click', previewPurchase);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
    }

    if (exportBtn) {
        exportBtn.addEventListener('click', exportPurchases);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±');
    }

    if (paymentBtn) {
        paymentBtn.addEventListener('click', registerPurchasePayment);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹');
    }

    if (paymentsBtn) {
        paymentsBtn.addEventListener('click', goToPayments);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª');
    }

    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshPurchases);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«');
    }

    console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª');
    if (document.getElementById('purchasesButtonResults')) {
        document.getElementById('purchasesButtonResults').innerHTML = '<div class="badge bg-success">âœ… ØªÙ… Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>';
    }
});

</script>
{% endblock %}
