{% extends "base_unified.html" %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}
    ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
{% else %}
    Sales Invoices
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .table-responsive {
        border-radius: 0.375rem;
    }
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin: 0 1px;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯ */
    .table tbody tr.table-active {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .table tbody tr.table-active:hover {
        background-color: #e3f2fd !important;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± radio button */
    .table tbody tr input[type="radio"] {
        transform: scale(1.2);
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙØ±Ø¹{% else %}Branch{% endif %}</label>
                <select class="form-select" id="branchFilter" onchange="filterByBranch()">
                    <option value="">{% if session.get('language', 'ar') == 'ar' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹{% else %}All Branches{% endif %}</option>
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if branch.id == selected_branch %}selected{% endif %}>{{ branch.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}Ù…Ù† ØªØ§Ø±ÙŠØ®{% else %}From Date{% endif %}</label>
                <input type="date" class="form-control" id="dateFrom">
            </div>
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®{% else %}To Date{% endif %}</label>
                <input type="date" class="form-control" id="dateTo">
            </div>
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¨Ø­Ø«{% else %}Search{% endif %}</label>
                <input type="text" class="form-control" id="searchInvoice" placeholder="{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„{% else %}Invoice # or Customer{% endif %}">
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">{{ sales|length }}</h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±{% else %}Total Invoices{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">
                    {% set total_sales = sales|sum(attribute='total') %}
                    {{ "%.2f"|format(total_sales) }} Ø±ÙŠØ§Ù„
                </h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª{% else %}Total Sales{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    {% set total_tax = sales|sum(attribute='discount') %}
                    {{ "%.2f"|format(total_tax) }} Ø±ÙŠØ§Ù„
                </h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª{% else %}Total Discounts{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    {% if sales|length > 0 %}
                        {{ "%.2f"|format(total_sales / sales|length) }} Ø±ÙŠØ§Ù„
                    {% else %}
                        0.00 Ø±ÙŠØ§Ù„
                    {% endif %}
                </h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Average Invoice{% endif %}</p>
            </div>
        </div>
    </div>
</div>

<!-- Sales Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                {% if session.get('language', 'ar') == 'ar' %}
                    Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                {% else %}
                    Sales Invoices List
                {% endif %}
            </h5>
            <!-- Sales Screen Buttons Toolbar - Fixed -->
            <div class="btn-group" role="group" aria-label="Sales Actions">
                <button type="button"
                        id="btnSalesSave"
                        class="btn btn-success btn-sm"
                        title="Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                    <i class="fas fa-plus me-1"></i>
                    Ø¥Ø¶Ø§ÙØ©
                </button>
                <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
                <div class="btn-group me-2" role="group">
                    <button type="button"
                            id="btnSalesPrint"
                            class="btn btn-primary"
                            title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                        <i class="fas fa-print me-1"></i>
                        Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button type="button"
                            id="btnSalesPreview"
                            class="btn btn-info"
                            title="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                        <i class="fas fa-eye me-1"></i>
                        Ù…Ø¹Ø§ÙŠÙ†Ø©
                    </button>
                    <button type="button"
                            id="btnSalesExport"
                            class="btn btn-secondary"
                            title="ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª">
                        <i class="fas fa-download me-1"></i>
                        ØªØµØ¯ÙŠØ±
                    </button>
                </div>

                <div class="btn-group me-2" role="group">
                    <button type="button"
                            id="btnSalesPayment"
                            class="btn btn-success"
                            title="ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                        <i class="fas fa-money-bill-wave me-1"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
                    </button>
                </div>

                <div class="btn-group" role="group">
                    <button type="button"
                            id="btnSalesEdit"
                            class="btn btn-warning"
                            title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                        <i class="fas fa-edit me-1"></i>
                        ØªØ¹Ø¯ÙŠÙ„
                    </button>
                    <button type="button"
                            id="btnSalesDelete"
                            class="btn btn-danger"
                            title="Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©">
                        <i class="fas fa-trash me-1"></i>
                        Ø­Ø°Ù
                    </button>
                </div>

            </div>
            <div id="salesButtonResults" class="mt-2"></div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="salesTable">
                <thead>
                    <tr>
                        <th width="50">ØªØ­Ø¯ÙŠØ¯</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©{% else %}Invoice #{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ØªØ§Ø±ÙŠØ®{% else %}Date{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¹Ù…ÙŠÙ„{% else %}Customer{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„ÙØ±Ø¹{% else %}Branch{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¨Ù„Øº{% else %}Amount{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©{% else %}Tax{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ{% else %}Total{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹{% else %}Paid{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ{% else %}Remaining{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Status{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹{% else %}Payment Method{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª{% else %}Actions{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr class="invoice-row" data-branch="{{ sale.branch_id }}" data-date="{{ sale.invoice_date }}" data-customer="{{ sale.customer_name or '' }}" data-invoice="{{ sale.invoice_number }}" data-invoice-id="{{ sale.id }}">
                        <td>
                            <input type="radio" name="selected_invoice" value="{{ sale.id }}" data-invoice-number="{{ sale.invoice_number }}">
                        </td>
                        <td>
                            <strong>{{ sale.invoice_number }}</strong><br>
                            <small class="text-muted">{{ sale.date.strftime('%H:%M') if sale.date else '-' }}</small>
                        </td>
                        <td>{{ sale.date.strftime('%Y-%m-%d') if sale.date else '-' }}</td>
                        <td>{{ sale.customer.name if sale.customer else 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ' }}</td>
                        <td>ØºÙŠØ± Ù…Ø­Ø¯Ø¯</td>
                        <td><strong>{{ "%.2f"|format(sale.total) }} Ø±ÙŠØ§Ù„</strong></td>
                        <td class="paid-amount">{{ "%.2f"|format(sale.paid_amount or 0) }} Ø±ÙŠØ§Ù„</td>
                        <td class="remaining-amount">{{ "%.2f"|format((sale.total or 0) - (sale.paid_amount or 0)) }} Ø±ÙŠØ§Ù„</td>
                        <td>
                            <span class="badge payment-status bg-{{ 'success' if (sale.payment_status == 'paid') else ('warning' if sale.payment_status == 'partial' else 'danger') }}">
                                {% if sale.payment_status == 'paid' %}Ù…Ø¯ÙÙˆØ¹
                                {% elif sale.payment_status == 'partial' %}Ø¬Ø²Ø¦ÙŠ
                                {% else %}ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ sale.payment_method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-success btn-sm" onclick="location.href='/sales/new'" title="Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="printInvoice({{ sale.id }})" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteInvoice({{ sale.id }})" title="Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" onclick="location.href='/payments_dues'" title="Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSaleModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø¨ÙŠØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newSaleForm" class="sales-form" data-auto-save="/api/sales/create" data-method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="saleCustomer" class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <select class="form-select" id="saleCustomer" name="customer_id">
                                    <option value="">Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="saleDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø¨ÙŠØ¹Ø©</label>
                                <input type="date" class="form-control" id="saleDate" name="date" required>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-list me-2"></i>Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSaleItem()">
                                <i class="fas fa-plus me-1"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±
                            </button>
                        </div>

                        <div id="saleItemsContainer">
                            <!-- Sale items will be added here -->
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleSubtotal" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ</label>
                                <input type="number" class="form-control" id="saleSubtotal" name="subtotal" step="0.01" min="0" max="10000000" readonly>
                                <div class="invalid-feedback">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ Ù…Ø·Ù„ÙˆØ¨ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleDiscount" class="form-label">
                                    <i class="fas fa-percentage me-1"></i>Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                                </label>
                                <input type="number" class="form-control" id="saleDiscount" name="discount" step="0.01" value="0" min="0" max="10000000" onchange="validateAndCalculate()" oninput="validateDiscount()">
                                <small class="text-muted">Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</small>
                                <div class="invalid-feedback">Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹ Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleTaxRate" class="form-label">
                                    <i class="fas fa-receipt me-1"></i>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)
                                </label>
                                <input type="number" class="form-control" id="saleTaxRate" name="tax_rate" step="0.01" value="15" min="0" max="100" onchange="validateAndCalculate()" oninput="validateTaxRate()">
                                <small class="text-muted">Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</small>
                                <div class="invalid-feedback">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0% Ùˆ 100%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleTotal" class="form-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
                                <input type="number" class="form-control" id="saleTotal" name="total" step="0.01" readonly>
                                <div class="invalid-feedback">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Summary Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="saleTaxAmount" class="form-label">Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                                <input type="number" class="form-control" id="saleTaxAmount" name="tax_amount" step="0.01" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… ÙˆÙ‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                                <input type="number" class="form-control" id="saleAfterDiscount" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="saleNotes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea class="form-control" id="saleNotes" name="notes" rows="3" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                    </div>

                    <!-- Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø®ØµÙ… -->
                    <div class="alert alert-info" id="discountSummary" style="display: none;">
                        <h6><i class="fas fa-calculator me-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ:</strong> <span id="summarySubtotal">0.00</span> Ø±ÙŠØ§Ù„
                            </div>
                            <div class="col-md-4">
                                <strong class="text-danger">Ø§Ù„Ø®ØµÙ…:</strong> <span id="summaryDiscount">0.00</span> Ø±ÙŠØ§Ù„
                            </div>
                            <div class="col-md-4">
                                <strong class="text-success">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> <span id="summaryTotal">0.00</span> Ø±ÙŠØ§Ù„
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…: <span id="discountPercentage">0%</span>
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="saveNewSale()">
                    <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Sale Modal -->
<div class="modal fade" id="editSaleModal" tabindex="-1" aria-labelledby="editSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSaleModalLabel">
                    <i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSaleForm">
                    <input type="hidden" id="editSaleId" name="sale_id">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSaleCustomer" class="form-label">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                <select class="form-select" id="editSaleCustomer" name="customer_id">
                                    <option value="">Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSaleDate" class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                <input type="date" class="form-control" id="editSaleDate" name="date" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editSaleNotes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                        <textarea class="form-control" id="editSaleNotes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleSubtotal" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ</label>
                                <input type="number" class="form-control" id="editSaleSubtotal" name="subtotal" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleDiscount" class="form-label">Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
                                <input type="number" class="form-control" id="editSaleDiscount" name="discount" step="0.01" value="0" onchange="calculateEditTotal()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleTaxRate" class="form-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (%)</label>
                                <input type="number" class="form-control" id="editSaleTaxRate" name="tax_rate" step="0.01" value="15" onchange="calculateEditTotal()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleTotal" class="form-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
                                <input type="number" class="form-control" id="editSaleTotal" name="total" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="updateSale()">
                    <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Registration Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="paymentInvoiceId" name="invoice_id">
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                        <input type="number" class="form-control" id="paymentAmount" name="amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select class="form-select" id="paymentMethod" name="payment_method" required>
                            <option value="">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</option>
                            <option value="Cash">Ù†Ù‚Ø¯ÙŠ</option>
                            <option value="Card">Ø¨Ø·Ø§Ù‚Ø©</option>
                            <option value="Bank Transfer">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</label>
                        <input type="date" class="form-control" id="paymentDate" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNotes" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea class="form-control" id="paymentNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-success" onclick="savePayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// SALES SCREEN BUTTON FUNCTIONS - Fixed Implementation
// ============================================================================

// Global variables
let selectedInvoiceId = null;

// Update button states based on selection
function updateButtonStates() {
    const hasSelection = selectedInvoiceId !== null;

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
    const editBtn = document.querySelector('button[onclick*="EditSalesRecord"]');
    const deleteBtn = document.querySelector('button[onclick*="DeleteSalesRecord"]');
    const printBtn = document.querySelector('button[onclick*="PrintSalesRecord"]');
    const previewBtn = document.querySelector('button[onclick*="PreviewSalesRecord"]');

    if (editBtn) editBtn.disabled = !hasSelection;
    if (deleteBtn) deleteBtn.disabled = !hasSelection;
    if (printBtn) printBtn.disabled = !hasSelection;
    if (previewBtn) previewBtn.disabled = !hasSelection;

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    [editBtn, deleteBtn, printBtn, previewBtn].forEach(btn => {
        if (btn) {
            if (hasSelection) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add(btn.classList.contains('btn-danger') ? 'btn-danger' :
                                 btn.classList.contains('btn-success') ? 'btn-success' : 'btn-primary');
            } else {
                btn.classList.add('btn-outline-secondary');
                btn.classList.remove('btn-danger', 'btn-success', 'btn-primary');
            }
        }
    });
}
let selectedInvoiceData = null;

// Utility functions
function getSelectedInvoiceId() {
    const selected = document.querySelector('input[name="selected_invoice"]:checked');
    return selected ? parseInt(selected.value) : null;
}

function getSelectedInvoiceNumber() {
    const selected = document.querySelector('input[name="selected_invoice"]:checked');
    return selected ? selected.dataset.invoiceNumber : null;
}

function updateButtonStates() {
    const hasSelection = getSelectedInvoiceId() !== null;

    // Enable/disable buttons based on selection
    document.getElementById('btnSalesEdit').disabled = !hasSelection;
    document.getElementById('btnSalesDelete').disabled = !hasSelection;
    document.getElementById('btnSalesPreview').disabled = !hasSelection;
    document.getElementById('btnSalesPrint').disabled = !hasSelection;
    document.getElementById('btnSalesRegisterPayment').disabled = !hasSelection;
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// ============================================================================
// REQUIRED BUTTON FUNCTIONS
// ============================================================================

// Create New Sales Record (ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©)
function SaveSalesRecord() {
    console.log("Opening new sales invoice modal");

    // Reset form and items
    document.getElementById('newSaleForm').reset();
    document.getElementById('saleItemsContainer').innerHTML = '';
    itemCounter = 0;

    // Set today's date as default
    document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];

    // Ensure products are loaded before adding items
    if (!products || products.length === 0) {
        console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
        loadProducts();

        // Wait a moment for products to load, then add first item
        setTimeout(() => {
            addSaleItem();
        }, 500);
    } else {
        // Add first item immediately if products are already loaded
        addSaleItem();
    }

    // Open new sale modal
    const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
    modal.show();

    showNotification('ğŸ“ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…', 'info');
}

// Global variables for products
let products = [];
let itemCounter = 0;

// Load products on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
});

// Load products from API
function loadProducts() {
    console.log('ğŸ“¦ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');

    fetch('/api/products/list')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                products = data.products || [];
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­`);

                if (products.length === 0) {
                    console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.', 'info');
                }
            } else {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', data.message);
                products = [];
                showNotification('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ' + data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
            products = [];
            showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹.', 'warning');
        });
}

// Add new sale item row
function addSaleItem() {
    try {
        itemCounter++;
        const container = document.getElementById('saleItemsContainer');

        // Ensure products are loaded
        if (!products || products.length === 0) {
            console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
            loadProducts();
        }

        const itemHtml = `
            <div class="sale-item border rounded p-3 mb-3" data-item-id="${itemCounter}">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                        <select class="form-select product-select" onchange="selectProduct(${itemCounter}, this.value)">
                            <option value="">Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø®ØµØµ</option>
                            ${products.map(p => `<option value="${p.id}" data-price="${p.price}" data-name="${p.name}">${p.name} - ${p.price} Ø±ÙŠØ§Ù„</option>`).join('')}
                        </select>
                        <input type="text" class="form-control mt-2 product-name" placeholder="Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" onchange="updateItemCalculation(${itemCounter})">
                    </div>
                <div class="col-md-2">
                    <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <input type="number" class="form-control quantity" value="1" min="0.01" step="0.01" onchange="updateItemCalculation(${itemCounter})">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <input type="number" class="form-control unit-price" step="0.01" onchange="updateItemCalculation(${itemCounter})">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Ø§Ù„Ø®ØµÙ…</label>
                    <input type="number" class="form-control item-discount" value="0" step="0.01" onchange="updateItemCalculation(${itemCounter})">
                </div>
                <div class="col-md-1">
                    <label class="form-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</label>
                    <input type="number" class="form-control item-total" readonly>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeSaleItem(${itemCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', itemHtml);

        // If this is the first item, calculate total
        if (itemCounter === 1) {
            calculateTotal();
        }

        console.log(`â• ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ø±Ù‚Ù… ${itemCounter}`);

    } catch (error) {
        console.error('Error in addSaleItem:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯: ' + error.message, 'error');
    }
}

// Remove sale item
function removeSaleItem(itemId) {
    try {
        const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
        if (itemDiv) {
            itemDiv.remove();
            console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø±Ù‚Ù… ${itemId}`);

            // Recalculate total after removing item
            calculateTotal();

            // Show notification if no items left
            const remainingItems = document.querySelectorAll('.sale-item');
            if (remainingItems.length === 0) {
                showNotification('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯.', 'info');
            }
        } else {
            console.error(`Item not found for removal: ${itemId}`);
        }
    } catch (error) {
        console.error('Error removing item:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±', 'error');
    }
}

// Select product from dropdown
function selectProduct(itemId, productId) {
    try {
        const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!itemDiv) {
            console.error(`Item div not found for ID: ${itemId}`);
            return;
        }

        const productSelect = itemDiv.querySelector('.product-select');
        const productNameInput = itemDiv.querySelector('.product-name');
        const unitPriceInput = itemDiv.querySelector('.unit-price');

        if (productId) {
            const selectedOption = productSelect.querySelector(`option[value="${productId}"]`);
            if (selectedOption) {
                const productName = selectedOption.getAttribute('data-name');
                const productPrice = selectedOption.getAttribute('data-price');

                productNameInput.value = productName || '';
                unitPriceInput.value = productPrice || '0';

                console.log(`ğŸ›ï¸ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬: ${productName} - Ø§Ù„Ø³Ø¹Ø±: ${productPrice}`);

                updateItemCalculation(itemId);
            } else {
                console.error(`Product option not found for ID: ${productId}`);
            }
        } else {
            // Clear fields when no product selected
            productNameInput.value = '';
            unitPriceInput.value = '';
            updateItemCalculation(itemId);
        }
    } catch (error) {
        console.error('Error in selectProduct:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    }
}

// Update item calculation
function updateItemCalculation(itemId) {
    try {
        const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!itemDiv) {
            console.error(`Item div not found for ID: ${itemId}`);
            return;
        }

        const quantity = Math.max(0, parseFloat(itemDiv.querySelector('.quantity').value) || 0);
        const unitPrice = Math.max(0, parseFloat(itemDiv.querySelector('.unit-price').value) || 0);
        const discount = Math.max(0, parseFloat(itemDiv.querySelector('.item-discount').value) || 0);

        // Calculate total ensuring it's not negative
        const subtotal = quantity * unitPrice;
        const validDiscount = Math.min(discount, subtotal);
        const total = Math.max(0, subtotal - validDiscount);

        // Update discount if it was adjusted
        if (validDiscount !== discount) {
            itemDiv.querySelector('.item-discount').value = validDiscount.toFixed(2);
        }

        itemDiv.querySelector('.item-total').value = total.toFixed(2);

        console.log(`ğŸ§® Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù†ØµØ± ${itemId}: Ø§Ù„ÙƒÙ…ÙŠØ©=${quantity}, Ø§Ù„Ø³Ø¹Ø±=${unitPrice}, Ø§Ù„Ø®ØµÙ…=${validDiscount}, Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ=${total}`);

        calculateTotal();
    } catch (error) {
        console.error('Error in updateItemCalculation:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù†ØµØ±', 'error');
    }
}

// Remove sale item
function removeSaleItem(itemId) {
    const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
    itemDiv.remove();
    calculateTotal();
}

// Comprehensive validation function
function validateSaleData(saleData, items) {
    // Check if total is negative
    if (parseFloat(saleData.total) < 0) {
        return {
            isValid: false,
            message: 'Ø®Ø·Ø£: Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ'
        };
    }

    // Check if we have items or manual subtotal
    if (items.length === 0 && (!saleData.subtotal || parseFloat(saleData.subtotal) <= 0)) {
        return {
            isValid: false,
            message: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ù„Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ÙØ±Ø¹ÙŠ'
        };
    }

    // Validate subtotal
    const subtotal = parseFloat(saleData.subtotal) || 0;
    if (subtotal < 0) {
        return {
            isValid: false,
            message: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹'
        };
    }

    // Validate discount
    const discount = parseFloat(saleData.discount) || 0;
    if (discount < 0) {
        return {
            isValid: false,
            message: 'Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹'
        };
    }

    if (discount > subtotal) {
        return {
            isValid: false,
            message: 'Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ'
        };
    }

    // Validate tax rate
    const taxRate = parseFloat(saleData.tax_rate) || 0;
    if (taxRate < 0 || taxRate > 100) {
        return {
            isValid: false,
            message: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0% Ùˆ 100%'
        };
    }

    // Validate date
    if (saleData.date) {
        const saleDate = new Date(saleData.date);
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        if (saleDate > today) {
            return {
                isValid: false,
                message: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„'
            };
        }

        if (saleDate < oneYearAgo) {
            return {
                isValid: false,
                message: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ø¯Ù… Ù…Ù† Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©'
            };
        }
    }

    // Validate items if provided
    if (items.length > 0) {
        for (let i = 0; i < items.length; i++) {
            const item = items[i];

            // Check product name
            if (!item.product_name || item.product_name.trim() === '') {
                return {
                    isValid: false,
                    message: `Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1}`
                };
            }

            // Check quantity
            if (!item.quantity || parseFloat(item.quantity) <= 0) {
                return {
                    isValid: false,
                    message: `Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ± ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1}`
                };
            }

            if (parseFloat(item.quantity) > 10000) {
                return {
                    isValid: false,
                    message: `Ø§Ù„ÙƒÙ…ÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1} (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10,000)`
                };
            }

            // Check unit price
            if (!item.unit_price || parseFloat(item.unit_price) < 0) {
                return {
                    isValid: false,
                    message: `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1}`
                };
            }

            if (parseFloat(item.unit_price) > 1000000) {
                return {
                    isValid: false,
                    message: `Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1} (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 1,000,000)`
                };
            }

            // Check item discount
            const itemDiscount = parseFloat(item.discount) || 0;
            const itemTotal = parseFloat(item.quantity) * parseFloat(item.unit_price);

            if (itemDiscount < 0) {
                return {
                    isValid: false,
                    message: `Ø®ØµÙ… Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1}`
                };
            }

            if (itemDiscount > itemTotal) {
                return {
                    isValid: false,
                    message: `Ø®ØµÙ… Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ${i + 1}`
                };
            }
        }
    }

    // Check maximum total amount
    const total = parseFloat(saleData.total) || 0;
    if (total > 10000000) {
        return {
            isValid: false,
            message: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10,000,000 Ø±ÙŠØ§Ù„)'
        };
    }

    return { isValid: true };
}

// Real-time validation functions
function validateDiscount() {
    const discountInput = document.getElementById('saleDiscount');
    const subtotalInput = document.getElementById('saleSubtotal');
    const discount = parseFloat(discountInput.value) || 0;
    const subtotal = parseFloat(subtotalInput.value) || 0;

    if (discount < 0) {
        discountInput.setCustomValidity('Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨Ø§Ù‹');
        discountInput.classList.add('is-invalid');
    } else if (discount > subtotal) {
        discountInput.setCustomValidity('Ø§Ù„Ø®ØµÙ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ');
        discountInput.classList.add('is-invalid');
    } else {
        discountInput.setCustomValidity('');
        discountInput.classList.remove('is-invalid');
        discountInput.classList.add('is-valid');
    }
}

function validateTaxRate() {
    const taxRateInput = document.getElementById('saleTaxRate');
    const taxRate = parseFloat(taxRateInput.value) || 0;

    if (taxRate < 0 || taxRate > 100) {
        taxRateInput.setCustomValidity('Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 0% Ùˆ 100%');
        taxRateInput.classList.add('is-invalid');
    } else {
        taxRateInput.setCustomValidity('');
        taxRateInput.classList.remove('is-invalid');
        taxRateInput.classList.add('is-valid');
    }
}

function validateAndCalculate() {
    validateDiscount();
    validateTaxRate();
    calculateTotal();
}

// Calculate total with discount and tax
function calculateTotal() {
    try {
        // Calculate subtotal from all items
        let subtotal = 0;
        const itemTotals = document.querySelectorAll('.item-total');
        itemTotals.forEach(input => {
            const value = parseFloat(input.value) || 0;
            if (value >= 0) {
                subtotal += value;
            }
        });

        // If no items, use manual subtotal input
        if (itemTotals.length === 0) {
            subtotal = parseFloat(document.getElementById('saleSubtotal').value) || 0;
        } else {
            document.getElementById('saleSubtotal').value = subtotal.toFixed(2);
        }

        const discount = Math.max(0, parseFloat(document.getElementById('saleDiscount').value) || 0);
        const taxRate = Math.max(0, Math.min(100, parseFloat(document.getElementById('saleTaxRate').value) || 15));

        // Ensure discount doesn't exceed subtotal
        const validDiscount = Math.min(discount, subtotal);
        if (validDiscount !== discount) {
            document.getElementById('saleDiscount').value = validDiscount.toFixed(2);
        }

        // Calculate amounts step by step
        const afterDiscount = Math.max(0, subtotal - validDiscount);
        const taxAmount = (afterDiscount * taxRate) / 100;
        const total = afterDiscount + taxAmount;

        // Update form fields
        document.getElementById('saleAfterDiscount').value = afterDiscount.toFixed(2);
        document.getElementById('saleTaxAmount').value = taxAmount.toFixed(2);
        document.getElementById('saleTotal').value = total.toFixed(2);

        // Update summary if elements exist
        const summarySubtotal = document.getElementById('summarySubtotal');
        const summaryDiscount = document.getElementById('summaryDiscount');
        const summaryTotal = document.getElementById('summaryTotal');
        const discountPercentage = document.getElementById('discountPercentage');
        const summaryDiv = document.getElementById('discountSummary');

        if (summarySubtotal) {
            summarySubtotal.textContent = subtotal.toFixed(2);
            summaryDiscount.textContent = validDiscount.toFixed(2);
            summaryTotal.textContent = total.toFixed(2);

            // Calculate discount percentage
            const discountPercent = subtotal > 0 ? ((validDiscount / subtotal) * 100).toFixed(1) : 0;
            discountPercentage.textContent = discountPercent + '%';

            // Show/hide summary
            if (subtotal > 0) {
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        console.log(`ğŸ’° Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙØ±Ø¹ÙŠ=${subtotal.toFixed(2)}, Ø§Ù„Ø®ØµÙ…=${validDiscount.toFixed(2)}, Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©=${taxAmount.toFixed(2)}, Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ=${total.toFixed(2)}`);

    } catch (error) {
        console.error('Error in calculateTotal:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + error.message, 'error');
    }
}

// Save new sale
function saveNewSale() {
    try {
        const form = document.getElementById('newSaleForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
            return;
        }

        const formData = new FormData(form);
        const saleData = Object.fromEntries(formData.entries());

        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', saleData);

    // Collect items data
    const items = [];
    const itemDivs = document.querySelectorAll('.sale-item');

    itemDivs.forEach((itemDiv, index) => {
        const productSelect = itemDiv.querySelector('.product-select');
        const productName = itemDiv.querySelector('.product-name');
        const quantity = itemDiv.querySelector('.quantity');
        const unitPrice = itemDiv.querySelector('.unit-price');
        const discount = itemDiv.querySelector('.item-discount');

        const quantityValue = parseFloat(quantity.value) || 0;
        const unitPriceValue = parseFloat(unitPrice.value) || 0;
        const discountValue = parseFloat(discount.value) || 0;

        // Get product name from select or input
        let finalProductName = '';
        if (productName.value && productName.value.trim()) {
            finalProductName = productName.value.trim();
        } else if (productSelect.selectedIndex > 0) {
            finalProductName = productSelect.options[productSelect.selectedIndex].text.split(' - ')[0];
        }

        if (finalProductName && quantityValue > 0 && unitPriceValue > 0) {
            const itemData = {
                product_id: productSelect.value || null,
                product_name: finalProductName,
                quantity: quantityValue,
                unit_price: unitPriceValue,
                discount: discountValue,
                total_price: quantityValue * unitPriceValue - discountValue
            };

            items.push(itemData);
            console.log(`âœ… Ø¹Ù†ØµØ± ${index + 1}: ${itemData.product_name} - Ø§Ù„ÙƒÙ…ÙŠØ©: ${itemData.quantity} - Ø§Ù„Ø³Ø¹Ø±: ${itemData.unit_price}`);
        } else {
            console.warn(`âš ï¸ Ø¹Ù†ØµØ± ${index + 1} ØºÙŠØ± ØµØ§Ù„Ø­: Ø§Ù„Ø§Ø³Ù…="${finalProductName}", Ø§Ù„ÙƒÙ…ÙŠØ©=${quantityValue}, Ø§Ù„Ø³Ø¹Ø±=${unitPriceValue}`);
        }
    });

        if (items.length === 0) {
            showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ Ø§Ø³Ù… ÙˆÙƒÙ…ÙŠØ© ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­ÙŠÙ†', 'warning');
            return;
        }

        // Add items to sale data
        saleData.items = items;

        console.log(`ğŸ“¦ ØªÙ… Ø¬Ù…Ø¹ ${items.length} Ø¹Ù†ØµØ± ØµØ§Ù„Ø­ Ù„Ù„ÙØ§ØªÙˆØ±Ø©`);

    // Enhanced validation
    const validationResult = validateSaleData(saleData, items);
    if (!validationResult.isValid) {
        showNotification(validationResult.message, 'error');
        return;
    }

    // Show loading indicator
    const submitBtn = document.querySelector('#newSaleModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    submitBtn.disabled = true;

    fetch('/api/sales/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const invoiceNumber = data.invoice_number || 'Ø¬Ø¯ÙŠØ¯Ø©';
            showNotification(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ${invoiceNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            const modal = bootstrap.Modal.getInstance(document.getElementById('newSaleModal'));
            if (modal) modal.hide();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            form.reset();
            document.getElementById('saleItemsContainer').innerHTML = '';
            itemCounter = 0;

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', error);
        showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
    })
    .finally(() => {
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });

    } catch (error) {
        console.error('Error in saveNewSale:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.message, 'error');
    }
}

// Edit Sales Record
function EditSalesRecord() {
    console.log("Sales Edit button clicked");

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_invoice"]:checked');
    if (!selectedRadio) {
        showNotification("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©", "warning");
        return;
    }

    const invoiceId = selectedRadio.value;
    if (invoiceId) {
        loadSaleForEdit(invoiceId);
    } else {
        showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
    }
}

// Load sale data for editing
function loadSaleForEdit(saleId) {
    fetch(`/api/sales/list`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const sale = data.sales.find(s => s.id == saleId);
                if (sale) {
                    populateEditForm(sale);
                    const modal = new bootstrap.Modal(document.getElementById('editSaleModal'));
                    modal.show();
                } else {
                    showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
                }
            } else {
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
        });
}

// Populate edit form with sale data
function populateEditForm(sale) {
    document.getElementById('editSaleId').value = sale.id;
    document.getElementById('editSaleCustomer').value = sale.customer?.id || '';
    document.getElementById('editSaleDate').value = sale.date ? sale.date.split('T')[0] : '';
    document.getElementById('editSaleNotes').value = sale.notes || '';
    document.getElementById('editSaleSubtotal').value = sale.subtotal || 0;
    document.getElementById('editSaleDiscount').value = sale.discount || 0;
    document.getElementById('editSaleTaxRate').value = sale.tax_rate || 15;
    document.getElementById('editSaleTotal').value = sale.total || 0;

    calculateEditTotal();
}

// Calculate total for edit form
function calculateEditTotal() {
    const subtotal = parseFloat(document.getElementById('editSaleSubtotal').value) || 0;
    const discount = parseFloat(document.getElementById('editSaleDiscount').value) || 0;
    const taxRate = parseFloat(document.getElementById('editSaleTaxRate').value) || 0;

    const afterDiscount = subtotal - discount;
    const taxAmount = (afterDiscount * taxRate) / 100;
    const total = afterDiscount + taxAmount;

    document.getElementById('editSaleTotal').value = total.toFixed(2);
}

// Update sale
function updateSale() {
    const form = document.getElementById('editSaleForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const saleData = Object.fromEntries(formData.entries());
    const saleId = saleData.sale_id;

    // Calculate tax amount
    const subtotal = parseFloat(saleData.subtotal) || 0;
    const discount = parseFloat(saleData.discount) || 0;
    const taxRate = parseFloat(saleData.tax_rate) || 0;
    const afterDiscount = subtotal - discount;
    saleData.tax_amount = ((afterDiscount * taxRate) / 100).toFixed(2);

    // Show loading indicator
    const submitBtn = document.querySelector('#editSaleModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    submitBtn.disabled = true;

    fetch(`/api/sales/update/${saleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSaleModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ø®Ø·Ø£: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Delete Sales Record
function DeleteSalesRecord() {
    console.log("ğŸ—‘ï¸ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„ÙŠÙ‡");

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_invoice"]:checked');
    if (!selectedRadio) {
        showNotification("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø­Ø°Ù Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ", "warning");
        console.log("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙØ§ØªÙˆØ±Ø©");
        return;
    }

    const invoiceId = selectedRadio.value;
    const invoiceNumber = selectedRadio.dataset.invoiceNumber || `INV-${invoiceId}`;

    console.log(`ğŸ” ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ID=${invoiceId}, Number=${invoiceNumber}`);

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ØµÙ
    const row = selectedRadio.closest('tr');
    const customerName = row.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const amount = row.cells[7]?.textContent?.trim() || '0'; // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ

    if (!invoiceId || invoiceId === '') {
        showNotification("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
        console.log("âŒ Ù…Ø¹Ø±Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±Øº");
        return;
    }

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    const confirmMessage = `ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber}ØŸ\n\nØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`;

    if (!confirm(confirmMessage)) {
        console.log("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        return;
    }

    console.log(`ğŸš€ Ø¨Ø¯Ø¡ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${invoiceId}`);

    // Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    fetch(`/api/sales/delete/${invoiceId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log(`ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status} ${response.statusText}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('ğŸ“¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', data);

        if (data.success) {
            showNotification(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const rowToRemove = selectedRadio.closest('tr');
            if (rowToRemove) {
                rowToRemove.style.transition = 'opacity 0.5s';
                rowToRemove.style.opacity = '0';
                setTimeout(() => {
                    rowToRemove.remove();
                    console.log('ğŸ—‘ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„');

                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    setTimeout(() => {
                        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
                        location.reload();
                    }, 500);
                }, 500);
            } else {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + (data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            console.error('âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', data.message);
        }
    })
    .catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', error);

        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';

        if (error.message.includes('404')) {
            errorMessage = 'Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
        } else if (error.message.includes('403')) {
            errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
        } else if (error.message.includes('401')) {
            errorMessage = 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹';
        } else if (error.message.includes('500')) {
            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
        } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            errorMessage = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
        } else {
            errorMessage = error.message;
        }

        showNotification(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${errorMessage}`, 'error');
    });
}

// Preview Sales Record
function PreviewSalesRecord() {
    console.log("Sales Preview button clicked");

    const selectedRow = document.querySelector('.table tbody tr.table-active');
    if (!selectedRow) {
        showNotification("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©", "warning");
        return;
    }

    const invoiceId = selectedRow.dataset.invoiceId || selectedRow.cells[0]?.textContent?.replace('#', '');
    if (invoiceId) {
        window.open(`/sales/preview/${invoiceId}`, '_blank');
    } else {
        showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
    }
}

// Register Payment
function RegisterPayment() {
    console.log("Sales Register Payment button clicked");

    const selectedRow = document.querySelector('.table tbody tr.table-active');
    if (!selectedRow) {
        showNotification("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹", "warning");
        return;
    }

    const invoiceId = selectedRow.dataset.invoiceId || selectedRow.cells[0]?.textContent?.replace('#', '');
    const invoiceNumber = selectedRow.cells[1]?.textContent || `#${invoiceId}`;

    if (invoiceId) {
        // ÙŠÙ…ÙƒÙ† ÙØªØ­ modal Ø£Ùˆ ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
        location.href = `/payments_dues?sale_id=${invoiceId}`;
    } else {
        showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
    }
}

// Print Sales Record
function PrintSalesRecord() {
    console.log("Sales Print button clicked");

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… radio button
    const selectedRadio = document.querySelector('input[name="selected_invoice"]:checked');
    if (!selectedRadio) {
        showNotification("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©", "warning");
        return;
    }

    const invoiceId = selectedRadio.value;
    if (invoiceId) {
        window.open(`/sales/print/${invoiceId}`, '_blank');
    } else {
        showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©", "error");
    }
}

// Select Sales Invoice
function SelectSalesInvoice() {
    console.log("Sales Select Invoice button clicked");

    // This function can be used to open an invoice selection dialog
    // For now, we'll just show current selection info
    const invoiceId = getSelectedInvoiceId();
    const invoiceNumber = getSelectedInvoiceNumber();

    if (invoiceId) {
        alert(`Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©: ${invoiceNumber} (ID: ${invoiceId})`);
    } else {
        alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ ÙØ§ØªÙˆØ±Ø©");
    }
}

// Register Sales Payment
function RegisterSalesPayment() {
    console.log("Sales Register Payment button clicked");

    const invoiceId = getSelectedInvoiceId();
    const invoiceNumber = getSelectedInvoiceNumber();

    if (!invoiceId) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©");
        return;
    }

    // Set invoice data in modal
    document.getElementById('paymentInvoiceId').value = invoiceId;
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

    // Update modal title
    document.getElementById('paymentModalLabel').textContent = `ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber}`;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

// Save Payment (called from modal)
function savePayment() {
    console.log("Save Payment button clicked");

    const form = document.getElementById('paymentForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const paymentData = Object.fromEntries(formData.entries());

    // Show loading indicator
    const submitBtn = document.querySelector('#paymentModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
    submitBtn.disabled = true;

    fetch('/api/sales/register_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(paymentData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
            // Reset form
            form.reset();
            // Reload page after short delay
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('Ø®Ø·Ø£: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
    })
    .finally(() => {
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// ============================================================================
// LEGACY FUNCTIONS (kept for compatibility with table buttons)
// ============================================================================

// Direct delete function for table buttons
function deleteInvoice(invoiceId) {
    console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ÙØ§ØªÙˆØ±Ø©: ${invoiceId}`);

    if (!invoiceId) {
        showNotification("âŒ Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± ØµØ­ÙŠØ­", "error");
        return;
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    const rows = document.querySelectorAll('.table tbody tr');
    let targetRow = null;
    let invoiceNumber = `INV-${invoiceId}`;
    let customerName = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    let amount = '0';

    rows.forEach(row => {
        const radioButton = row.querySelector('input[name="selected_invoice"]');
        if (radioButton && radioButton.value == invoiceId) {
            targetRow = row;
            invoiceNumber = radioButton.dataset.invoiceNumber || `INV-${invoiceId}`;
            customerName = row.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            amount = row.cells[7]?.textContent?.trim() || '0';
        }
    });

    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
    const confirmMessage = `ğŸ—‘ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber}ØŸ\n\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`;

    if (!confirm(confirmMessage)) {
        console.log("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù");
        return;
    }

    console.log(`ğŸš€ Ø¨Ø¯Ø¡ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${invoiceId}`);

    // Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    fetch(`/api/sales/delete/${invoiceId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log(`ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status} ${response.statusText}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('ğŸ“¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', data);

        if (data.success) {
            showNotification(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${invoiceNumber} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
            if (targetRow) {
                targetRow.style.transition = 'opacity 0.5s';
                targetRow.style.opacity = '0';
                setTimeout(() => {
                    targetRow.remove();
                    console.log('ğŸ—‘ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„');

                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    setTimeout(() => {
                        console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
                        location.reload();
                    }, 500);
                }, 500);
            } else {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + (data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            console.error('âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', data.message);
        }
    })
    .catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©:', error);

        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';

        if (error.message.includes('404')) {
            errorMessage = 'Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
        } else if (error.message.includes('403')) {
            errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
        } else if (error.message.includes('401')) {
            errorMessage = 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹';
        } else if (error.message.includes('500')) {
            errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
        } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            errorMessage = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
        } else {
            errorMessage = error.message;
        }

        showNotification(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${errorMessage}`, 'error');
    });
}

// Unified print function - use PrintSalesRecord instead
function printInvoice(invoiceId) {
    // Select the row first
    const rows = document.querySelectorAll('.table tbody tr');
    rows.forEach(row => {
        const firstCell = row.cells[0];
        if (firstCell && firstCell.textContent.includes(invoiceId)) {
            row.classList.add('table-active');
            row.dataset.invoiceId = invoiceId;
        }
    });

    // Call the main print function
    PrintSalesRecord();
}

// ============================================================================
// EVENT LISTENERS AND INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ¯ Sales Screen - Initializing button system...');

    // Add event listeners for radio button selection
    document.addEventListener('change', function(e) {
        if (e.target.name === 'selected_invoice') {
            selectedInvoiceId = parseInt(e.target.value);
            updateButtonStates();

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
            document.querySelectorAll('.table tbody tr').forEach(r => r.classList.remove('table-active'));

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
            const selectedRow = e.target.closest('tr');
            if (selectedRow) {
                selectedRow.classList.add('table-active');
            }

            console.log(`Selected invoice: ${selectedInvoiceId}`);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            const row = e.target.closest('tr');
            const customerName = row.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const amount = row.cells[6]?.textContent?.trim() || '0';

            showNotification(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${e.target.dataset.invoiceNumber || '#' + selectedInvoiceId}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${customerName} | Ø§Ù„Ù…Ø¨Ù„Øº: ${amount}`, 'info');
        }
    });

    // Initial button state update
    updateButtonStates();

    console.log('âœ… Sales Screen - Button system initialized successfully!');
    console.log('ğŸ”§ Available functions:');
    console.log('   - SaveSalesRecord()');
    console.log('   - EditSalesRecord()');
    console.log('   - DeleteSalesRecord()');
    console.log('   - PreviewSalesRecord()');
    console.log('   - PrintSalesRecord()');
    console.log('   - SelectSalesInvoice()');
    console.log('   - RegisterSalesPayment()');

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            if (e.target.closest('button') || e.target.closest('a')) {
                return;
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
            tableRows.forEach(r => r.classList.remove('table-active'));

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯
            this.classList.add('table-active');

            // ØªØ­Ø¯ÙŠØ¯ radio button Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„
            const radioButton = this.querySelector('input[name="selected_invoice"]');
            if (radioButton) {
                radioButton.checked = true;

                // ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                selectedInvoiceId = parseInt(radioButton.value);
                updateButtonStates();

                console.log(`Selected invoice: ${selectedInvoiceId}`);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const customerName = this.cells[3]?.textContent?.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const amount = this.cells[6]?.textContent?.trim() || '0';

                showNotification(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${radioButton.dataset.invoiceNumber || '#' + selectedInvoiceId} | Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName}`, 'info');
            }
        });
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    updateButtonStates();

    console.log('Sales page loaded successfully');
});

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ø§Ù„ØªÙŠ ØªØ¹Ù…Ù„
console.log('ğŸ”§ ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©...');

function addSale() {
    console.log('â• Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª');
    window.location.href = '/sales/new';
}

function editSale() {
    console.log('âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.location.href = '/sales/edit/' + selected.value;
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function deleteSale() {
    console.log('ğŸ—‘ï¸ Ø­Ø°Ù ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) {
            alert('âœ… Ø²Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ Ù‡Ù†Ø§
        }
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø­Ø°Ù Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function printSale() {
    console.log('ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.open('/sales/print/' + selected.value, '_blank');
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function previewSale() {
    console.log('ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.open('/sales/preview/' + selected.value, '_blank');
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹');
    }
}

function exportSales() {
    console.log('ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
    alert('âœ… Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙŠØ¹Ù…Ù„!');
    window.open('/api/sales/export', '_blank');
}

function registerPayment() {
    console.log('ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('âœ… Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ ÙŠØ¹Ù…Ù„! Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + selected.value);
        window.location.href = '/payments/new?invoice=' + selected.value;
    } else {
        alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ÙØ§ØªÙˆØ±Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ø£ÙˆÙ„Ø§Ù‹');
    }
}

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”— Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...');

    const addBtn = document.getElementById('btnSalesSave');
    const editBtn = document.getElementById('btnSalesEdit');
    const deleteBtn = document.getElementById('btnSalesDelete');
    const printBtn = document.getElementById('btnSalesPrint');
    const previewBtn = document.getElementById('btnSalesPreview');
    const exportBtn = document.getElementById('btnSalesExport');
    const paymentBtn = document.getElementById('btnSalesPayment');

    if (addBtn) {
        addBtn.addEventListener('click', addSale);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    }

    if (editBtn) {
        editBtn.addEventListener('click', editSale);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteSale);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­Ø°Ù');
    }

    if (printBtn) {
        printBtn.addEventListener('click', printSale);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');
    }

    if (previewBtn) {
        previewBtn.addEventListener('click', previewSale);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
    }

    if (exportBtn) {
        exportBtn.addEventListener('click', exportSales);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ±');
    }

    if (paymentBtn) {
        paymentBtn.addEventListener('click', registerPayment);
        console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹');
    }

    console.log('âœ… ØªÙ… Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
    if (document.getElementById('salesButtonResults')) {
        document.getElementById('salesButtonResults').innerHTML = '<div class="badge bg-success">âœ… ØªÙ… Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>';
    }
});

</script>
{% endblock %}
