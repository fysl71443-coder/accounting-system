{% extends "base_unified.html" %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}
    فواتير المبيعات
{% else %}
    Sales Invoices
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .table-responsive {
        border-radius: 0.375rem;
    }
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin: 0 1px;
    }

    /* تحسين مظهر الصف المحدد */
    .table tbody tr.table-active {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .table tbody tr.table-active:hover {
        background-color: #e3f2fd !important;
    }

    /* تحسين مظهر radio button */
    .table tbody tr input[type="radio"] {
        transform: scale(1.2);
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}الفرع{% else %}Branch{% endif %}</label>
                <select class="form-select" id="branchFilter" onchange="filterByBranch()">
                    <option value="">{% if session.get('language', 'ar') == 'ar' %}جميع الفروع{% else %}All Branches{% endif %}</option>
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if branch.id == selected_branch %}selected{% endif %}>{{ branch.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}من تاريخ{% else %}From Date{% endif %}</label>
                <input type="date" class="form-control" id="dateFrom">
            </div>
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}إلى تاريخ{% else %}To Date{% endif %}</label>
                <input type="date" class="form-control" id="dateTo">
            </div>
            <div class="col-md-3">
                <label class="form-label">{% if session.get('language', 'ar') == 'ar' %}البحث{% else %}Search{% endif %}</label>
                <input type="text" class="form-control" id="searchInvoice" placeholder="{% if session.get('language', 'ar') == 'ar' %}رقم الفاتورة أو العميل{% else %}Invoice # or Customer{% endif %}">
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">{{ sales|length }}</h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}إجمالي الفواتير{% else %}Total Invoices{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">
                    {% set total_sales = sales|sum(attribute='total') %}
                    {{ "%.2f"|format(total_sales) }} ريال
                </h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}إجمالي المبيعات{% else %}Total Sales{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    {% set total_tax = sales|sum(attribute='discount') %}
                    {{ "%.2f"|format(total_tax) }} ريال
                </h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}إجمالي الخصومات{% else %}Total Discounts{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">
                    {% if sales|length > 0 %}
                        {{ "%.2f"|format(total_sales / sales|length) }} ريال
                    {% else %}
                        0.00 ريال
                    {% endif %}
                </h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}متوسط الفاتورة{% else %}Average Invoice{% endif %}</p>
            </div>
        </div>
    </div>
</div>

<!-- Sales Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                {% if session.get('language', 'ar') == 'ar' %}
                    قائمة فواتير المبيعات
                {% else %}
                    Sales Invoices List
                {% endif %}
            </h5>
            <!-- Sales Screen Buttons Toolbar - Fixed -->
            <div class="btn-group" role="group" aria-label="Sales Actions">
                <button type="button"
                        id="btnSalesSave"
                        class="btn btn-success btn-sm"
                        title="إضافة فاتورة جديدة">
                    <i class="fas fa-plus me-1"></i>
                    إضافة
                </button>
                <!-- الأزرار الرئيسية -->
                <div class="btn-group me-2" role="group">
                    <button type="button"
                            id="btnSalesPrint"
                            class="btn btn-primary"
                            title="طباعة الفاتورة المحددة">
                        <i class="fas fa-print me-1"></i>
                        طباعة
                    </button>
                    <button type="button"
                            id="btnSalesPreview"
                            class="btn btn-info"
                            title="معاينة الفاتورة المحددة">
                        <i class="fas fa-eye me-1"></i>
                        معاينة
                    </button>
                    <button type="button"
                            id="btnSalesExport"
                            class="btn btn-secondary"
                            title="تصدير المبيعات">
                        <i class="fas fa-download me-1"></i>
                        تصدير
                    </button>
                </div>

                <div class="btn-group me-2" role="group">
                    <button type="button"
                            id="btnSalesPayment"
                            class="btn btn-success"
                            title="تسجيل دفعة للفاتورة المحددة">
                        <i class="fas fa-money-bill-wave me-1"></i>
                        تسجيل الدفع
                    </button>
                </div>

                <div class="btn-group" role="group">
                    <button type="button"
                            id="btnSalesEdit"
                            class="btn btn-warning"
                            title="تعديل الفاتورة المحددة">
                        <i class="fas fa-edit me-1"></i>
                        تعديل
                    </button>
                    <button type="button"
                            id="btnSalesDelete"
                            class="btn btn-danger"
                            title="حذف الفاتورة المحددة">
                        <i class="fas fa-trash me-1"></i>
                        حذف
                    </button>
                </div>

            </div>
            <div id="salesButtonResults" class="mt-2"></div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="salesTable">
                <thead>
                    <tr>
                        <th width="50">تحديد</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}رقم الفاتورة{% else %}Invoice #{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}التاريخ{% else %}Date{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}العميل{% else %}Customer{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}الفرع{% else %}Branch{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}المبلغ{% else %}Amount{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}الضريبة{% else %}Tax{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}الإجمالي{% else %}Total{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}المدفوع{% else %}Paid{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}المتبقي{% else %}Remaining{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}حالة الدفع{% else %}Payment Status{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}طريقة الدفع{% else %}Payment Method{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}إجراءات{% else %}Actions{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales %}
                    <tr class="invoice-row" data-branch="{{ sale.branch_id }}" data-date="{{ sale.invoice_date }}" data-customer="{{ sale.customer_name or '' }}" data-invoice="{{ sale.invoice_number }}" data-invoice-id="{{ sale.id }}">
                        <td>
                            <input type="radio" name="selected_invoice" value="{{ sale.id }}" data-invoice-number="{{ sale.invoice_number }}">
                        </td>
                        <td>
                            <strong>{{ sale.invoice_number }}</strong><br>
                            <small class="text-muted">{{ sale.date.strftime('%H:%M') if sale.date else '-' }}</small>
                        </td>
                        <td>{{ sale.date.strftime('%Y-%m-%d') if sale.date else '-' }}</td>
                        <td>{{ sale.customer.name if sale.customer else 'عميل نقدي' }}</td>
                        <td>غير محدد</td>
                        <td><strong>{{ "%.2f"|format(sale.total) }} ريال</strong></td>
                        <td class="paid-amount">{{ "%.2f"|format(sale.paid_amount or 0) }} ريال</td>
                        <td class="remaining-amount">{{ "%.2f"|format((sale.total or 0) - (sale.paid_amount or 0)) }} ريال</td>
                        <td>
                            <span class="badge payment-status bg-{{ 'success' if (sale.payment_status == 'paid') else ('warning' if sale.payment_status == 'partial' else 'danger') }}">
                                {% if sale.payment_status == 'paid' %}مدفوع
                                {% elif sale.payment_status == 'partial' %}جزئي
                                {% else %}غير مدفوع{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ sale.payment_method or 'غير محدد' }}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-success btn-sm" onclick="location.href='/sales/new'" title="إنشاء فاتورة جديدة">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="printInvoice({{ sale.id }})" title="طباعة الفاتورة">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteInvoice({{ sale.id }})" title="حذف الفاتورة">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" onclick="location.href='/payments_dues'" title="المدفوعات والمستحقات">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Sale Modal -->
<div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSaleModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>إضافة مبيعة جديدة
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newSaleForm" class="sales-form" data-auto-save="/api/sales/create" data-method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="saleCustomer" class="form-label">العميل</label>
                                <select class="form-select" id="saleCustomer" name="customer_id">
                                    <option value="">عميل نقدي</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="saleDate" class="form-label">تاريخ المبيعة</label>
                                <input type="date" class="form-control" id="saleDate" name="date" required>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-list me-2"></i>عناصر الفاتورة</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSaleItem()">
                                <i class="fas fa-plus me-1"></i>إضافة عنصر
                            </button>
                        </div>

                        <div id="saleItemsContainer">
                            <!-- Sale items will be added here -->
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleSubtotal" class="form-label">المبلغ الفرعي</label>
                                <input type="number" class="form-control" id="saleSubtotal" name="subtotal" step="0.01" min="0" max="10000000" readonly>
                                <div class="invalid-feedback">المبلغ الفرعي مطلوب ولا يمكن أن يكون سالباً</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleDiscount" class="form-label">
                                    <i class="fas fa-percentage me-1"></i>الخصم الإجمالي
                                </label>
                                <input type="number" class="form-control" id="saleDiscount" name="discount" step="0.01" value="0" min="0" max="10000000" onchange="validateAndCalculate()" oninput="validateDiscount()">
                                <small class="text-muted">خصم إضافي على إجمالي الفاتورة</small>
                                <div class="invalid-feedback">الخصم لا يمكن أن يكون سالباً أو أكبر من المبلغ الفرعي</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleTaxRate" class="form-label">
                                    <i class="fas fa-receipt me-1"></i>معدل الضريبة (%)
                                </label>
                                <input type="number" class="form-control" id="saleTaxRate" name="tax_rate" step="0.01" value="15" min="0" max="100" onchange="validateAndCalculate()" oninput="validateTaxRate()">
                                <small class="text-muted">ضريبة القيمة المضافة</small>
                                <div class="invalid-feedback">معدل الضريبة يجب أن يكون بين 0% و 100%</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="saleTotal" class="form-label">المجموع النهائي</label>
                                <input type="number" class="form-control" id="saleTotal" name="total" step="0.01" readonly>
                                <div class="invalid-feedback">إجمالي الفاتورة لا يمكن أن يكون سالباً</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tax Summary Row -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="saleTaxAmount" class="form-label">مبلغ الضريبة</label>
                                <input type="number" class="form-control" id="saleTaxAmount" name="tax_amount" step="0.01" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">المبلغ بعد الخصم وقبل الضريبة</label>
                                <input type="number" class="form-control" id="saleAfterDiscount" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="saleNotes" class="form-label">ملاحظات (اختياري)</label>
                        <textarea class="form-control" id="saleNotes" name="notes" rows="3" placeholder="أي ملاحظات إضافية..."></textarea>
                    </div>

                    <!-- عرض ملخص الخصم -->
                    <div class="alert alert-info" id="discountSummary" style="display: none;">
                        <h6><i class="fas fa-calculator me-2"></i>ملخص الحساب:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>المبلغ الفرعي:</strong> <span id="summarySubtotal">0.00</span> ريال
                            </div>
                            <div class="col-md-4">
                                <strong class="text-danger">الخصم:</strong> <span id="summaryDiscount">0.00</span> ريال
                            </div>
                            <div class="col-md-4">
                                <strong class="text-success">المجموع النهائي:</strong> <span id="summaryTotal">0.00</span> ريال
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                نسبة الخصم: <span id="discountPercentage">0%</span>
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="saveNewSale()">
                    <i class="fas fa-save me-2"></i>حفظ المبيعة
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Sale Modal -->
<div class="modal fade" id="editSaleModal" tabindex="-1" aria-labelledby="editSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSaleModalLabel">
                    <i class="fas fa-edit me-2"></i>تعديل فاتورة مبيعات
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSaleForm">
                    <input type="hidden" id="editSaleId" name="sale_id">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSaleCustomer" class="form-label">العميل</label>
                                <select class="form-select" id="editSaleCustomer" name="customer_id">
                                    <option value="">عميل نقدي</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editSaleDate" class="form-label">التاريخ</label>
                                <input type="date" class="form-control" id="editSaleDate" name="date" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editSaleNotes" class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="editSaleNotes" name="notes" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleSubtotal" class="form-label">المبلغ الفرعي</label>
                                <input type="number" class="form-control" id="editSaleSubtotal" name="subtotal" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleDiscount" class="form-label">الخصم الإجمالي</label>
                                <input type="number" class="form-control" id="editSaleDiscount" name="discount" step="0.01" value="0" onchange="calculateEditTotal()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleTaxRate" class="form-label">معدل الضريبة (%)</label>
                                <input type="number" class="form-control" id="editSaleTaxRate" name="tax_rate" step="0.01" value="15" onchange="calculateEditTotal()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="editSaleTotal" class="form-label">المجموع النهائي</label>
                                <input type="number" class="form-control" id="editSaleTotal" name="total" step="0.01" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="updateSale()">
                    <i class="fas fa-save me-2"></i>حفظ التغييرات
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Registration Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">تسجيل دفعة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <input type="hidden" id="paymentInvoiceId" name="invoice_id">
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label">المبلغ المدفوع</label>
                        <input type="number" class="form-control" id="paymentAmount" name="amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">طريقة الدفع</label>
                        <select class="form-select" id="paymentMethod" name="payment_method" required>
                            <option value="">اختر طريقة الدفع</option>
                            <option value="Cash">نقدي</option>
                            <option value="Card">بطاقة</option>
                            <option value="Bank Transfer">تحويل بنكي</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentDate" class="form-label">تاريخ الدفع</label>
                        <input type="date" class="form-control" id="paymentDate" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNotes" class="form-label">ملاحظات (اختياري)</label>
                        <textarea class="form-control" id="paymentNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" onclick="savePayment()">حفظ الدفعة</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// SALES SCREEN BUTTON FUNCTIONS - Fixed Implementation
// ============================================================================

// Global variables
let selectedInvoiceId = null;

// Update button states based on selection
function updateButtonStates() {
    const hasSelection = selectedInvoiceId !== null;

    // تحديث حالة أزرار الشريط العلوي
    const editBtn = document.querySelector('button[onclick*="EditSalesRecord"]');
    const deleteBtn = document.querySelector('button[onclick*="DeleteSalesRecord"]');
    const printBtn = document.querySelector('button[onclick*="PrintSalesRecord"]');
    const previewBtn = document.querySelector('button[onclick*="PreviewSalesRecord"]');

    if (editBtn) editBtn.disabled = !hasSelection;
    if (deleteBtn) deleteBtn.disabled = !hasSelection;
    if (printBtn) printBtn.disabled = !hasSelection;
    if (previewBtn) previewBtn.disabled = !hasSelection;

    // تحديث مظهر الأزرار
    [editBtn, deleteBtn, printBtn, previewBtn].forEach(btn => {
        if (btn) {
            if (hasSelection) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add(btn.classList.contains('btn-danger') ? 'btn-danger' :
                                 btn.classList.contains('btn-success') ? 'btn-success' : 'btn-primary');
            } else {
                btn.classList.add('btn-outline-secondary');
                btn.classList.remove('btn-danger', 'btn-success', 'btn-primary');
            }
        }
    });
}
let selectedInvoiceData = null;

// Utility functions
function getSelectedInvoiceId() {
    const selected = document.querySelector('input[name="selected_invoice"]:checked');
    return selected ? parseInt(selected.value) : null;
}

function getSelectedInvoiceNumber() {
    const selected = document.querySelector('input[name="selected_invoice"]:checked');
    return selected ? selected.dataset.invoiceNumber : null;
}

function updateButtonStates() {
    const hasSelection = getSelectedInvoiceId() !== null;

    // Enable/disable buttons based on selection
    document.getElementById('btnSalesEdit').disabled = !hasSelection;
    document.getElementById('btnSalesDelete').disabled = !hasSelection;
    document.getElementById('btnSalesPreview').disabled = !hasSelection;
    document.getElementById('btnSalesPrint').disabled = !hasSelection;
    document.getElementById('btnSalesRegisterPayment').disabled = !hasSelection;
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

// ============================================================================
// REQUIRED BUTTON FUNCTIONS
// ============================================================================

// Create New Sales Record (فتح نموذج إنشاء فاتورة جديدة)
function SaveSalesRecord() {
    console.log("Opening new sales invoice modal");

    // Reset form and items
    document.getElementById('newSaleForm').reset();
    document.getElementById('saleItemsContainer').innerHTML = '';
    itemCounter = 0;

    // Set today's date as default
    document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];

    // Ensure products are loaded before adding items
    if (!products || products.length === 0) {
        console.log('📦 تحميل المنتجات قبل فتح النموذج...');
        loadProducts();

        // Wait a moment for products to load, then add first item
        setTimeout(() => {
            addSaleItem();
        }, 500);
    } else {
        // Add first item immediately if products are already loaded
        addSaleItem();
    }

    // Open new sale modal
    const modal = new bootstrap.Modal(document.getElementById('newSaleModal'));
    modal.show();

    showNotification('📝 نموذج إنشاء فاتورة جديدة جاهز للاستخدام', 'info');
}

// Global variables for products
let products = [];
let itemCounter = 0;

// Load products on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
});

// Load products from API
function loadProducts() {
    console.log('📦 جاري تحميل المنتجات...');

    fetch('/api/products/list')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                products = data.products || [];
                console.log(`✅ تم تحميل ${products.length} منتج بنجاح`);

                if (products.length === 0) {
                    console.warn('⚠️ لا توجد منتجات في قاعدة البيانات');
                    showNotification('لا توجد منتجات متاحة. يمكنك إدخال أسماء المنتجات يدوياً.', 'info');
                }
            } else {
                console.error('❌ فشل تحميل المنتجات:', data.message);
                products = [];
                showNotification('فشل تحميل المنتجات: ' + data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('❌ خطأ في تحميل المنتجات:', error);
            products = [];
            showNotification('خطأ في تحميل المنتجات. يمكنك إدخال أسماء المنتجات يدوياً.', 'warning');
        });
}

// Add new sale item row
function addSaleItem() {
    try {
        itemCounter++;
        const container = document.getElementById('saleItemsContainer');

        // Ensure products are loaded
        if (!products || products.length === 0) {
            console.log('📦 تحميل المنتجات...');
            loadProducts();
        }

        const itemHtml = `
            <div class="sale-item border rounded p-3 mb-3" data-item-id="${itemCounter}">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">المنتج</label>
                        <select class="form-select product-select" onchange="selectProduct(${itemCounter}, this.value)">
                            <option value="">اختر منتج أو أدخل اسم مخصص</option>
                            ${products.map(p => `<option value="${p.id}" data-price="${p.price}" data-name="${p.name}">${p.name} - ${p.price} ريال</option>`).join('')}
                        </select>
                        <input type="text" class="form-control mt-2 product-name" placeholder="أو أدخل اسم المنتج" onchange="updateItemCalculation(${itemCounter})">
                    </div>
                <div class="col-md-2">
                    <label class="form-label">الكمية</label>
                    <input type="number" class="form-control quantity" value="1" min="0.01" step="0.01" onchange="updateItemCalculation(${itemCounter})">
                </div>
                <div class="col-md-2">
                    <label class="form-label">سعر الوحدة</label>
                    <input type="number" class="form-control unit-price" step="0.01" onchange="updateItemCalculation(${itemCounter})">
                </div>
                <div class="col-md-2">
                    <label class="form-label">الخصم</label>
                    <input type="number" class="form-control item-discount" value="0" step="0.01" onchange="updateItemCalculation(${itemCounter})">
                </div>
                <div class="col-md-1">
                    <label class="form-label">المجموع</label>
                    <input type="number" class="form-control item-total" readonly>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeSaleItem(${itemCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', itemHtml);

        // If this is the first item, calculate total
        if (itemCounter === 1) {
            calculateTotal();
        }

        console.log(`➕ تم إضافة عنصر جديد رقم ${itemCounter}`);

    } catch (error) {
        console.error('Error in addSaleItem:', error);
        showNotification('خطأ في إضافة عنصر جديد: ' + error.message, 'error');
    }
}

// Remove sale item
function removeSaleItem(itemId) {
    try {
        const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
        if (itemDiv) {
            itemDiv.remove();
            console.log(`🗑️ تم حذف العنصر رقم ${itemId}`);

            // Recalculate total after removing item
            calculateTotal();

            // Show notification if no items left
            const remainingItems = document.querySelectorAll('.sale-item');
            if (remainingItems.length === 0) {
                showNotification('تم حذف جميع العناصر. يرجى إضافة عنصر جديد.', 'info');
            }
        } else {
            console.error(`Item not found for removal: ${itemId}`);
        }
    } catch (error) {
        console.error('Error removing item:', error);
        showNotification('خطأ في حذف العنصر', 'error');
    }
}

// Select product from dropdown
function selectProduct(itemId, productId) {
    try {
        const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!itemDiv) {
            console.error(`Item div not found for ID: ${itemId}`);
            return;
        }

        const productSelect = itemDiv.querySelector('.product-select');
        const productNameInput = itemDiv.querySelector('.product-name');
        const unitPriceInput = itemDiv.querySelector('.unit-price');

        if (productId) {
            const selectedOption = productSelect.querySelector(`option[value="${productId}"]`);
            if (selectedOption) {
                const productName = selectedOption.getAttribute('data-name');
                const productPrice = selectedOption.getAttribute('data-price');

                productNameInput.value = productName || '';
                unitPriceInput.value = productPrice || '0';

                console.log(`🛍️ تم اختيار المنتج: ${productName} - السعر: ${productPrice}`);

                updateItemCalculation(itemId);
            } else {
                console.error(`Product option not found for ID: ${productId}`);
            }
        } else {
            // Clear fields when no product selected
            productNameInput.value = '';
            unitPriceInput.value = '';
            updateItemCalculation(itemId);
        }
    } catch (error) {
        console.error('Error in selectProduct:', error);
        showNotification('خطأ في اختيار المنتج', 'error');
    }
}

// Update item calculation
function updateItemCalculation(itemId) {
    try {
        const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!itemDiv) {
            console.error(`Item div not found for ID: ${itemId}`);
            return;
        }

        const quantity = Math.max(0, parseFloat(itemDiv.querySelector('.quantity').value) || 0);
        const unitPrice = Math.max(0, parseFloat(itemDiv.querySelector('.unit-price').value) || 0);
        const discount = Math.max(0, parseFloat(itemDiv.querySelector('.item-discount').value) || 0);

        // Calculate total ensuring it's not negative
        const subtotal = quantity * unitPrice;
        const validDiscount = Math.min(discount, subtotal);
        const total = Math.max(0, subtotal - validDiscount);

        // Update discount if it was adjusted
        if (validDiscount !== discount) {
            itemDiv.querySelector('.item-discount').value = validDiscount.toFixed(2);
        }

        itemDiv.querySelector('.item-total').value = total.toFixed(2);

        console.log(`🧮 حساب العنصر ${itemId}: الكمية=${quantity}, السعر=${unitPrice}, الخصم=${validDiscount}, الإجمالي=${total}`);

        calculateTotal();
    } catch (error) {
        console.error('Error in updateItemCalculation:', error);
        showNotification('خطأ في حساب العنصر', 'error');
    }
}

// Remove sale item
function removeSaleItem(itemId) {
    const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
    itemDiv.remove();
    calculateTotal();
}

// Comprehensive validation function
function validateSaleData(saleData, items) {
    // Check if total is negative
    if (parseFloat(saleData.total) < 0) {
        return {
            isValid: false,
            message: 'خطأ: الخصم لا يمكن أن يكون أكبر من المبلغ الفرعي'
        };
    }

    // Check if we have items or manual subtotal
    if (items.length === 0 && (!saleData.subtotal || parseFloat(saleData.subtotal) <= 0)) {
        return {
            isValid: false,
            message: 'يرجى إضافة عناصر للفاتورة أو إدخال مبلغ فرعي'
        };
    }

    // Validate subtotal
    const subtotal = parseFloat(saleData.subtotal) || 0;
    if (subtotal < 0) {
        return {
            isValid: false,
            message: 'المبلغ الفرعي لا يمكن أن يكون سالباً'
        };
    }

    // Validate discount
    const discount = parseFloat(saleData.discount) || 0;
    if (discount < 0) {
        return {
            isValid: false,
            message: 'الخصم لا يمكن أن يكون سالباً'
        };
    }

    if (discount > subtotal) {
        return {
            isValid: false,
            message: 'الخصم لا يمكن أن يكون أكبر من المبلغ الفرعي'
        };
    }

    // Validate tax rate
    const taxRate = parseFloat(saleData.tax_rate) || 0;
    if (taxRate < 0 || taxRate > 100) {
        return {
            isValid: false,
            message: 'معدل الضريبة يجب أن يكون بين 0% و 100%'
        };
    }

    // Validate date
    if (saleData.date) {
        const saleDate = new Date(saleData.date);
        const today = new Date();
        const oneYearAgo = new Date();
        oneYearAgo.setFullYear(today.getFullYear() - 1);

        if (saleDate > today) {
            return {
                isValid: false,
                message: 'تاريخ الفاتورة لا يمكن أن يكون في المستقبل'
            };
        }

        if (saleDate < oneYearAgo) {
            return {
                isValid: false,
                message: 'تاريخ الفاتورة لا يمكن أن يكون أقدم من سنة واحدة'
            };
        }
    }

    // Validate items if provided
    if (items.length > 0) {
        for (let i = 0; i < items.length; i++) {
            const item = items[i];

            // Check product name
            if (!item.product_name || item.product_name.trim() === '') {
                return {
                    isValid: false,
                    message: `اسم المنتج مطلوب في العنصر ${i + 1}`
                };
            }

            // Check quantity
            if (!item.quantity || parseFloat(item.quantity) <= 0) {
                return {
                    isValid: false,
                    message: `الكمية يجب أن تكون أكبر من صفر في العنصر ${i + 1}`
                };
            }

            if (parseFloat(item.quantity) > 10000) {
                return {
                    isValid: false,
                    message: `الكمية كبيرة جداً في العنصر ${i + 1} (الحد الأقصى: 10,000)`
                };
            }

            // Check unit price
            if (!item.unit_price || parseFloat(item.unit_price) < 0) {
                return {
                    isValid: false,
                    message: `سعر الوحدة لا يمكن أن يكون سالباً في العنصر ${i + 1}`
                };
            }

            if (parseFloat(item.unit_price) > 1000000) {
                return {
                    isValid: false,
                    message: `سعر الوحدة كبير جداً في العنصر ${i + 1} (الحد الأقصى: 1,000,000)`
                };
            }

            // Check item discount
            const itemDiscount = parseFloat(item.discount) || 0;
            const itemTotal = parseFloat(item.quantity) * parseFloat(item.unit_price);

            if (itemDiscount < 0) {
                return {
                    isValid: false,
                    message: `خصم العنصر لا يمكن أن يكون سالباً في العنصر ${i + 1}`
                };
            }

            if (itemDiscount > itemTotal) {
                return {
                    isValid: false,
                    message: `خصم العنصر لا يمكن أن يكون أكبر من إجمالي العنصر في العنصر ${i + 1}`
                };
            }
        }
    }

    // Check maximum total amount
    const total = parseFloat(saleData.total) || 0;
    if (total > 10000000) {
        return {
            isValid: false,
            message: 'إجمالي الفاتورة كبير جداً (الحد الأقصى: 10,000,000 ريال)'
        };
    }

    return { isValid: true };
}

// Real-time validation functions
function validateDiscount() {
    const discountInput = document.getElementById('saleDiscount');
    const subtotalInput = document.getElementById('saleSubtotal');
    const discount = parseFloat(discountInput.value) || 0;
    const subtotal = parseFloat(subtotalInput.value) || 0;

    if (discount < 0) {
        discountInput.setCustomValidity('الخصم لا يمكن أن يكون سالباً');
        discountInput.classList.add('is-invalid');
    } else if (discount > subtotal) {
        discountInput.setCustomValidity('الخصم لا يمكن أن يكون أكبر من المبلغ الفرعي');
        discountInput.classList.add('is-invalid');
    } else {
        discountInput.setCustomValidity('');
        discountInput.classList.remove('is-invalid');
        discountInput.classList.add('is-valid');
    }
}

function validateTaxRate() {
    const taxRateInput = document.getElementById('saleTaxRate');
    const taxRate = parseFloat(taxRateInput.value) || 0;

    if (taxRate < 0 || taxRate > 100) {
        taxRateInput.setCustomValidity('معدل الضريبة يجب أن يكون بين 0% و 100%');
        taxRateInput.classList.add('is-invalid');
    } else {
        taxRateInput.setCustomValidity('');
        taxRateInput.classList.remove('is-invalid');
        taxRateInput.classList.add('is-valid');
    }
}

function validateAndCalculate() {
    validateDiscount();
    validateTaxRate();
    calculateTotal();
}

// Calculate total with discount and tax
function calculateTotal() {
    try {
        // Calculate subtotal from all items
        let subtotal = 0;
        const itemTotals = document.querySelectorAll('.item-total');
        itemTotals.forEach(input => {
            const value = parseFloat(input.value) || 0;
            if (value >= 0) {
                subtotal += value;
            }
        });

        // If no items, use manual subtotal input
        if (itemTotals.length === 0) {
            subtotal = parseFloat(document.getElementById('saleSubtotal').value) || 0;
        } else {
            document.getElementById('saleSubtotal').value = subtotal.toFixed(2);
        }

        const discount = Math.max(0, parseFloat(document.getElementById('saleDiscount').value) || 0);
        const taxRate = Math.max(0, Math.min(100, parseFloat(document.getElementById('saleTaxRate').value) || 15));

        // Ensure discount doesn't exceed subtotal
        const validDiscount = Math.min(discount, subtotal);
        if (validDiscount !== discount) {
            document.getElementById('saleDiscount').value = validDiscount.toFixed(2);
        }

        // Calculate amounts step by step
        const afterDiscount = Math.max(0, subtotal - validDiscount);
        const taxAmount = (afterDiscount * taxRate) / 100;
        const total = afterDiscount + taxAmount;

        // Update form fields
        document.getElementById('saleAfterDiscount').value = afterDiscount.toFixed(2);
        document.getElementById('saleTaxAmount').value = taxAmount.toFixed(2);
        document.getElementById('saleTotal').value = total.toFixed(2);

        // Update summary if elements exist
        const summarySubtotal = document.getElementById('summarySubtotal');
        const summaryDiscount = document.getElementById('summaryDiscount');
        const summaryTotal = document.getElementById('summaryTotal');
        const discountPercentage = document.getElementById('discountPercentage');
        const summaryDiv = document.getElementById('discountSummary');

        if (summarySubtotal) {
            summarySubtotal.textContent = subtotal.toFixed(2);
            summaryDiscount.textContent = validDiscount.toFixed(2);
            summaryTotal.textContent = total.toFixed(2);

            // Calculate discount percentage
            const discountPercent = subtotal > 0 ? ((validDiscount / subtotal) * 100).toFixed(1) : 0;
            discountPercentage.textContent = discountPercent + '%';

            // Show/hide summary
            if (subtotal > 0) {
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        console.log(`💰 حساب الإجمالي: المبلغ الفرعي=${subtotal.toFixed(2)}, الخصم=${validDiscount.toFixed(2)}, الضريبة=${taxAmount.toFixed(2)}, الإجمالي=${total.toFixed(2)}`);

    } catch (error) {
        console.error('Error in calculateTotal:', error);
        showNotification('خطأ في حساب الإجمالي: ' + error.message, 'error');
    }
}

// Save new sale
function saveNewSale() {
    try {
        const form = document.getElementById('newSaleForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            showNotification('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'warning');
            return;
        }

        const formData = new FormData(form);
        const saleData = Object.fromEntries(formData.entries());

        console.log('📝 بيانات الفاتورة:', saleData);

    // Collect items data
    const items = [];
    const itemDivs = document.querySelectorAll('.sale-item');

    itemDivs.forEach((itemDiv, index) => {
        const productSelect = itemDiv.querySelector('.product-select');
        const productName = itemDiv.querySelector('.product-name');
        const quantity = itemDiv.querySelector('.quantity');
        const unitPrice = itemDiv.querySelector('.unit-price');
        const discount = itemDiv.querySelector('.item-discount');

        const quantityValue = parseFloat(quantity.value) || 0;
        const unitPriceValue = parseFloat(unitPrice.value) || 0;
        const discountValue = parseFloat(discount.value) || 0;

        // Get product name from select or input
        let finalProductName = '';
        if (productName.value && productName.value.trim()) {
            finalProductName = productName.value.trim();
        } else if (productSelect.selectedIndex > 0) {
            finalProductName = productSelect.options[productSelect.selectedIndex].text.split(' - ')[0];
        }

        if (finalProductName && quantityValue > 0 && unitPriceValue > 0) {
            const itemData = {
                product_id: productSelect.value || null,
                product_name: finalProductName,
                quantity: quantityValue,
                unit_price: unitPriceValue,
                discount: discountValue,
                total_price: quantityValue * unitPriceValue - discountValue
            };

            items.push(itemData);
            console.log(`✅ عنصر ${index + 1}: ${itemData.product_name} - الكمية: ${itemData.quantity} - السعر: ${itemData.unit_price}`);
        } else {
            console.warn(`⚠️ عنصر ${index + 1} غير صالح: الاسم="${finalProductName}", الكمية=${quantityValue}, السعر=${unitPriceValue}`);
        }
    });

        if (items.length === 0) {
            showNotification('يرجى إضافة عنصر واحد على الأقل مع اسم وكمية وسعر صحيحين', 'warning');
            return;
        }

        // Add items to sale data
        saleData.items = items;

        console.log(`📦 تم جمع ${items.length} عنصر صالح للفاتورة`);

    // Enhanced validation
    const validationResult = validateSaleData(saleData, items);
    if (!validationResult.isValid) {
        showNotification(validationResult.message, 'error');
        return;
    }

    // Show loading indicator
    const submitBtn = document.querySelector('#newSaleModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'جاري الحفظ...';
    submitBtn.disabled = true;

    fetch('/api/sales/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const invoiceNumber = data.invoice_number || 'جديدة';
            showNotification(`✅ تم إنشاء فاتورة المبيعات ${invoiceNumber} بنجاح!`, 'success');

            // إخفاء النموذج
            const modal = bootstrap.Modal.getInstance(document.getElementById('newSaleModal'));
            if (modal) modal.hide();

            // إعادة تعيين النموذج
            form.reset();
            document.getElementById('saleItemsContainer').innerHTML = '';
            itemCounter = 0;

            // إعادة تحميل الصفحة لإظهار الفاتورة الجديدة
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('❌ خطأ في إنشاء الفاتورة: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('❌ خطأ في إرسال الفاتورة:', error);
        showNotification('❌ حدث خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى.', 'error');
    })
    .finally(() => {
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });

    } catch (error) {
        console.error('Error in saveNewSale:', error);
        showNotification('خطأ في حفظ الفاتورة: ' + error.message, 'error');
    }
}

// Edit Sales Record
function EditSalesRecord() {
    console.log("Sales Edit button clicked");

    // البحث عن الفاتورة المحددة باستخدام radio button
    const selectedRadio = document.querySelector('input[name="selected_invoice"]:checked');
    if (!selectedRadio) {
        showNotification("يرجى تحديد فاتورة للتعديل أولاً بالنقر على الصف أو تحديد الدائرة", "warning");
        return;
    }

    const invoiceId = selectedRadio.value;
    if (invoiceId) {
        loadSaleForEdit(invoiceId);
    } else {
        showNotification("خطأ في تحديد الفاتورة", "error");
    }
}

// Load sale data for editing
function loadSaleForEdit(saleId) {
    fetch(`/api/sales/list`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const sale = data.sales.find(s => s.id == saleId);
                if (sale) {
                    populateEditForm(sale);
                    const modal = new bootstrap.Modal(document.getElementById('editSaleModal'));
                    modal.show();
                } else {
                    showNotification('لم يتم العثور على الفاتورة', 'error');
                }
            } else {
                showNotification('خطأ في تحميل بيانات الفاتورة', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('خطأ في الاتصال بالخادم', 'error');
        });
}

// Populate edit form with sale data
function populateEditForm(sale) {
    document.getElementById('editSaleId').value = sale.id;
    document.getElementById('editSaleCustomer').value = sale.customer?.id || '';
    document.getElementById('editSaleDate').value = sale.date ? sale.date.split('T')[0] : '';
    document.getElementById('editSaleNotes').value = sale.notes || '';
    document.getElementById('editSaleSubtotal').value = sale.subtotal || 0;
    document.getElementById('editSaleDiscount').value = sale.discount || 0;
    document.getElementById('editSaleTaxRate').value = sale.tax_rate || 15;
    document.getElementById('editSaleTotal').value = sale.total || 0;

    calculateEditTotal();
}

// Calculate total for edit form
function calculateEditTotal() {
    const subtotal = parseFloat(document.getElementById('editSaleSubtotal').value) || 0;
    const discount = parseFloat(document.getElementById('editSaleDiscount').value) || 0;
    const taxRate = parseFloat(document.getElementById('editSaleTaxRate').value) || 0;

    const afterDiscount = subtotal - discount;
    const taxAmount = (afterDiscount * taxRate) / 100;
    const total = afterDiscount + taxAmount;

    document.getElementById('editSaleTotal').value = total.toFixed(2);
}

// Update sale
function updateSale() {
    const form = document.getElementById('editSaleForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const saleData = Object.fromEntries(formData.entries());
    const saleId = saleData.sale_id;

    // Calculate tax amount
    const subtotal = parseFloat(saleData.subtotal) || 0;
    const discount = parseFloat(saleData.discount) || 0;
    const taxRate = parseFloat(saleData.tax_rate) || 0;
    const afterDiscount = subtotal - discount;
    saleData.tax_amount = ((afterDiscount * taxRate) / 100).toFixed(2);

    // Show loading indicator
    const submitBtn = document.querySelector('#editSaleModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'جاري الحفظ...';
    submitBtn.disabled = true;

    fetch(`/api/sales/update/${saleId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editSaleModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('خطأ: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    })
    .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Delete Sales Record
function DeleteSalesRecord() {
    console.log("🗑️ زر حذف المبيعات تم النقر عليه");

    // البحث عن الفاتورة المحددة باستخدام radio button
    const selectedRadio = document.querySelector('input[name="selected_invoice"]:checked');
    if (!selectedRadio) {
        showNotification("⚠️ يرجى تحديد فاتورة للحذف أولاً بالنقر على الصف", "warning");
        console.log("❌ لم يتم تحديد أي فاتورة");
        return;
    }

    const invoiceId = selectedRadio.value;
    const invoiceNumber = selectedRadio.dataset.invoiceNumber || `INV-${invoiceId}`;

    console.log(`🔍 تم تحديد الفاتورة: ID=${invoiceId}, Number=${invoiceNumber}`);

    // الحصول على معلومات إضافية عن الفاتورة من الصف
    const row = selectedRadio.closest('tr');
    const customerName = row.cells[3]?.textContent?.trim() || 'غير محدد';
    const amount = row.cells[7]?.textContent?.trim() || '0'; // العمود الصحيح للإجمالي

    if (!invoiceId || invoiceId === '') {
        showNotification("❌ خطأ في تحديد الفاتورة", "error");
        console.log("❌ معرف الفاتورة فارغ");
        return;
    }

    // تأكيد الحذف مع معلومات إضافية
    const confirmMessage = `🗑️ هل أنت متأكد من حذف الفاتورة ${invoiceNumber}؟\n\nتفاصيل الفاتورة:\n👤 العميل: ${customerName}\n💰 المبلغ: ${amount}\n\n⚠️ تحذير: لا يمكن التراجع عن هذا الإجراء!`;

    if (!confirm(confirmMessage)) {
        console.log("❌ تم إلغاء عملية الحذف من قبل المستخدم");
        return;
    }

    console.log(`🚀 بدء حذف الفاتورة: ${invoiceId}`);

    // حذف الفاتورة
    fetch(`/api/sales/delete/${invoiceId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log(`📡 استجابة الخادم: ${response.status} ${response.statusText}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('📨 بيانات الاستجابة:', data);

        if (data.success) {
            showNotification(`✅ تم حذف الفاتورة ${invoiceNumber} بنجاح!`, 'success');

            // إزالة الصف من الجدول فوراً لتحسين تجربة المستخدم
            const rowToRemove = selectedRadio.closest('tr');
            if (rowToRemove) {
                rowToRemove.style.transition = 'opacity 0.5s';
                rowToRemove.style.opacity = '0';
                setTimeout(() => {
                    rowToRemove.remove();
                    console.log('🗑️ تم إزالة الصف من الجدول');

                    // إعادة تحميل الصفحة لتحديث الإحصائيات
                    setTimeout(() => {
                        console.log('🔄 إعادة تحميل الصفحة...');
                        location.reload();
                    }, 500);
                }, 500);
            } else {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('❌ فشل حذف الفاتورة: ' + (data.message || 'خطأ غير معروف'), 'error');
            console.error('❌ خطأ من الخادم:', data.message);
        }
    })
    .catch(error => {
        console.error('❌ خطأ في حذف الفاتورة:', error);

        let errorMessage = 'حدث خطأ غير متوقع';

        if (error.message.includes('404')) {
            errorMessage = 'الفاتورة غير موجودة أو تم حذفها مسبقاً';
        } else if (error.message.includes('403')) {
            errorMessage = 'ليس لديك صلاحية لحذف هذه الفاتورة';
        } else if (error.message.includes('401')) {
            errorMessage = 'يرجى تسجيل الدخول أولاً';
        } else if (error.message.includes('500')) {
            errorMessage = 'خطأ في الخادم. يرجى المحاولة لاحقاً';
        } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            errorMessage = 'مشكلة في الاتصال بالخادم';
        } else {
            errorMessage = error.message;
        }

        showNotification(`❌ فشل حذف الفاتورة: ${errorMessage}`, 'error');
    });
}

// Preview Sales Record
function PreviewSalesRecord() {
    console.log("Sales Preview button clicked");

    const selectedRow = document.querySelector('.table tbody tr.table-active');
    if (!selectedRow) {
        showNotification("يرجى تحديد فاتورة للمعاينة", "warning");
        return;
    }

    const invoiceId = selectedRow.dataset.invoiceId || selectedRow.cells[0]?.textContent?.replace('#', '');
    if (invoiceId) {
        window.open(`/sales/preview/${invoiceId}`, '_blank');
    } else {
        showNotification("خطأ في تحديد الفاتورة", "error");
    }
}

// Register Payment
function RegisterPayment() {
    console.log("Sales Register Payment button clicked");

    const selectedRow = document.querySelector('.table tbody tr.table-active');
    if (!selectedRow) {
        showNotification("يرجى تحديد فاتورة لتسجيل الدفع", "warning");
        return;
    }

    const invoiceId = selectedRow.dataset.invoiceId || selectedRow.cells[0]?.textContent?.replace('#', '');
    const invoiceNumber = selectedRow.cells[1]?.textContent || `#${invoiceId}`;

    if (invoiceId) {
        // يمكن فتح modal أو توجيه لصفحة المدفوعات
        location.href = `/payments_dues?sale_id=${invoiceId}`;
    } else {
        showNotification("خطأ في تحديد الفاتورة", "error");
    }
}

// Print Sales Record
function PrintSalesRecord() {
    console.log("Sales Print button clicked");

    // البحث عن الفاتورة المحددة باستخدام radio button
    const selectedRadio = document.querySelector('input[name="selected_invoice"]:checked');
    if (!selectedRadio) {
        showNotification("يرجى تحديد فاتورة للطباعة أولاً بالنقر على الصف أو تحديد الدائرة", "warning");
        return;
    }

    const invoiceId = selectedRadio.value;
    if (invoiceId) {
        window.open(`/sales/print/${invoiceId}`, '_blank');
    } else {
        showNotification("خطأ في تحديد الفاتورة", "error");
    }
}

// Select Sales Invoice
function SelectSalesInvoice() {
    console.log("Sales Select Invoice button clicked");

    // This function can be used to open an invoice selection dialog
    // For now, we'll just show current selection info
    const invoiceId = getSelectedInvoiceId();
    const invoiceNumber = getSelectedInvoiceNumber();

    if (invoiceId) {
        alert(`الفاتورة المحددة: ${invoiceNumber} (ID: ${invoiceId})`);
    } else {
        alert("لم يتم تحديد أي فاتورة");
    }
}

// Register Sales Payment
function RegisterSalesPayment() {
    console.log("Sales Register Payment button clicked");

    const invoiceId = getSelectedInvoiceId();
    const invoiceNumber = getSelectedInvoiceNumber();

    if (!invoiceId) {
        alert("يرجى تحديد فاتورة لتسجيل الدفعة");
        return;
    }

    // Set invoice data in modal
    document.getElementById('paymentInvoiceId').value = invoiceId;
    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

    // Update modal title
    document.getElementById('paymentModalLabel').textContent = `تسجيل دفعة للفاتورة ${invoiceNumber}`;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

// Save Payment (called from modal)
function savePayment() {
    console.log("Save Payment button clicked");

    const form = document.getElementById('paymentForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    const paymentData = Object.fromEntries(formData.entries());

    // Show loading indicator
    const submitBtn = document.querySelector('#paymentModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'جاري الحفظ...';
    submitBtn.disabled = true;

    fetch('/api/sales/register_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(paymentData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showNotification('تم تسجيل الدفعة بنجاح', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
            // Reset form
            form.reset();
            // Reload page after short delay
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('خطأ: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('حدث خطأ أثناء تسجيل الدفعة', 'error');
    })
    .finally(() => {
        // Reset button
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// ============================================================================
// LEGACY FUNCTIONS (kept for compatibility with table buttons)
// ============================================================================

// Direct delete function for table buttons
function deleteInvoice(invoiceId) {
    console.log(`🗑️ حذف مباشر للفاتورة: ${invoiceId}`);

    if (!invoiceId) {
        showNotification("❌ خطأ: معرف الفاتورة غير صحيح", "error");
        return;
    }

    // البحث عن الصف المقابل للحصول على معلومات إضافية
    const rows = document.querySelectorAll('.table tbody tr');
    let targetRow = null;
    let invoiceNumber = `INV-${invoiceId}`;
    let customerName = 'غير محدد';
    let amount = '0';

    rows.forEach(row => {
        const radioButton = row.querySelector('input[name="selected_invoice"]');
        if (radioButton && radioButton.value == invoiceId) {
            targetRow = row;
            invoiceNumber = radioButton.dataset.invoiceNumber || `INV-${invoiceId}`;
            customerName = row.cells[3]?.textContent?.trim() || 'غير محدد';
            amount = row.cells[7]?.textContent?.trim() || '0';
        }
    });

    // تأكيد الحذف
    const confirmMessage = `🗑️ هل أنت متأكد من حذف الفاتورة ${invoiceNumber}؟\n\n👤 العميل: ${customerName}\n💰 المبلغ: ${amount}\n\n⚠️ تحذير: لا يمكن التراجع عن هذا الإجراء!`;

    if (!confirm(confirmMessage)) {
        console.log("❌ تم إلغاء عملية الحذف");
        return;
    }

    console.log(`🚀 بدء حذف الفاتورة: ${invoiceId}`);

    // حذف الفاتورة
    fetch(`/api/sales/delete/${invoiceId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log(`📡 استجابة الخادم: ${response.status} ${response.statusText}`);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(data => {
        console.log('📨 بيانات الاستجابة:', data);

        if (data.success) {
            showNotification(`✅ تم حذف الفاتورة ${invoiceNumber} بنجاح!`, 'success');

            // إزالة الصف من الجدول فوراً
            if (targetRow) {
                targetRow.style.transition = 'opacity 0.5s';
                targetRow.style.opacity = '0';
                setTimeout(() => {
                    targetRow.remove();
                    console.log('🗑️ تم إزالة الصف من الجدول');

                    // إعادة تحميل الصفحة لتحديث الإحصائيات
                    setTimeout(() => {
                        console.log('🔄 إعادة تحميل الصفحة...');
                        location.reload();
                    }, 500);
                }, 500);
            } else {
                setTimeout(() => location.reload(), 1000);
            }
        } else {
            showNotification('❌ فشل حذف الفاتورة: ' + (data.message || 'خطأ غير معروف'), 'error');
            console.error('❌ خطأ من الخادم:', data.message);
        }
    })
    .catch(error => {
        console.error('❌ خطأ في حذف الفاتورة:', error);

        let errorMessage = 'حدث خطأ غير متوقع';

        if (error.message.includes('404')) {
            errorMessage = 'الفاتورة غير موجودة أو تم حذفها مسبقاً';
        } else if (error.message.includes('403')) {
            errorMessage = 'ليس لديك صلاحية لحذف هذه الفاتورة';
        } else if (error.message.includes('401')) {
            errorMessage = 'يرجى تسجيل الدخول أولاً';
        } else if (error.message.includes('500')) {
            errorMessage = 'خطأ في الخادم. يرجى المحاولة لاحقاً';
        } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            errorMessage = 'مشكلة في الاتصال بالخادم';
        } else {
            errorMessage = error.message;
        }

        showNotification(`❌ فشل حذف الفاتورة: ${errorMessage}`, 'error');
    });
}

// Unified print function - use PrintSalesRecord instead
function printInvoice(invoiceId) {
    // Select the row first
    const rows = document.querySelectorAll('.table tbody tr');
    rows.forEach(row => {
        const firstCell = row.cells[0];
        if (firstCell && firstCell.textContent.includes(invoiceId)) {
            row.classList.add('table-active');
            row.dataset.invoiceId = invoiceId;
        }
    });

    // Call the main print function
    PrintSalesRecord();
}

// ============================================================================
// EVENT LISTENERS AND INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Sales Screen - Initializing button system...');

    // Add event listeners for radio button selection
    document.addEventListener('change', function(e) {
        if (e.target.name === 'selected_invoice') {
            selectedInvoiceId = parseInt(e.target.value);
            updateButtonStates();

            // إزالة التحديد من جميع الصفوف
            document.querySelectorAll('.table tbody tr').forEach(r => r.classList.remove('table-active'));

            // إضافة التحديد للصف المحدد
            const selectedRow = e.target.closest('tr');
            if (selectedRow) {
                selectedRow.classList.add('table-active');
            }

            console.log(`Selected invoice: ${selectedInvoiceId}`);

            // إظهار رسالة تأكيد مع معلومات الفاتورة
            const row = e.target.closest('tr');
            const customerName = row.cells[3]?.textContent?.trim() || 'غير محدد';
            const amount = row.cells[6]?.textContent?.trim() || '0';

            showNotification(`✅ تم تحديد الفاتورة ${e.target.dataset.invoiceNumber || '#' + selectedInvoiceId}\nالعميل: ${customerName} | المبلغ: ${amount}`, 'info');
        }
    });

    // Initial button state update
    updateButtonStates();

    console.log('✅ Sales Screen - Button system initialized successfully!');
    console.log('🔧 Available functions:');
    console.log('   - SaveSalesRecord()');
    console.log('   - EditSalesRecord()');
    console.log('   - DeleteSalesRecord()');
    console.log('   - PreviewSalesRecord()');
    console.log('   - PrintSalesRecord()');
    console.log('   - SelectSalesInvoice()');
    console.log('   - RegisterSalesPayment()');

    // إضافة وظيفة تحديد الصفوف
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('click', function(e) {
            // تجاهل النقر على الأزرار
            if (e.target.closest('button') || e.target.closest('a')) {
                return;
            }

            // إزالة التحديد من جميع الصفوف
            tableRows.forEach(r => r.classList.remove('table-active'));

            // إضافة التحديد للصف المحدد
            this.classList.add('table-active');

            // تحديد radio button المقابل
            const radioButton = this.querySelector('input[name="selected_invoice"]');
            if (radioButton) {
                radioButton.checked = true;

                // تحديث متغير الفاتورة المحددة
                selectedInvoiceId = parseInt(radioButton.value);
                updateButtonStates();

                console.log(`Selected invoice: ${selectedInvoiceId}`);

                // إظهار رسالة تأكيد مع معلومات الفاتورة
                const customerName = this.cells[3]?.textContent?.trim() || 'غير محدد';
                const amount = this.cells[6]?.textContent?.trim() || '0';

                showNotification(`✅ تم تحديد الفاتورة ${radioButton.dataset.invoiceNumber || '#' + selectedInvoiceId} | العميل: ${customerName}`, 'info');
            }
        });
    });

    // تهيئة حالة الأزرار
    updateButtonStates();

    console.log('Sales page loaded successfully');
});

// دوال المبيعات البسيطة التي تعمل
console.log('🔧 تعريف دوال المبيعات البسيطة...');

function addSale() {
    console.log('➕ إضافة فاتورة مبيعات');
    window.location.href = '/sales/new';
}

function editSale() {
    console.log('✏️ تعديل فاتورة مبيعات');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('✅ زر تعديل المبيعات يعمل! الفاتورة: ' + selected.value);
        window.location.href = '/sales/edit/' + selected.value;
    } else {
        alert('⚠️ يرجى تحديد فاتورة للتعديل أولاً');
    }
}

function deleteSale() {
    console.log('🗑️ حذف فاتورة مبيعات');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
            alert('✅ زر حذف المبيعات يعمل! الفاتورة: ' + selected.value);
            // يمكن إضافة كود الحذف الفعلي هنا
        }
    } else {
        alert('⚠️ يرجى تحديد فاتورة للحذف أولاً');
    }
}

function printSale() {
    console.log('🖨️ طباعة فاتورة مبيعات');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('✅ زر طباعة المبيعات يعمل! الفاتورة: ' + selected.value);
        window.open('/sales/print/' + selected.value, '_blank');
    } else {
        alert('⚠️ يرجى تحديد فاتورة للطباعة أولاً');
    }
}

function previewSale() {
    console.log('👁️ معاينة فاتورة مبيعات');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('✅ زر معاينة المبيعات يعمل! الفاتورة: ' + selected.value);
        window.open('/sales/preview/' + selected.value, '_blank');
    } else {
        alert('⚠️ يرجى تحديد فاتورة للمعاينة أولاً');
    }
}

function exportSales() {
    console.log('📥 تصدير المبيعات');
    alert('✅ زر تصدير المبيعات يعمل!');
    window.open('/api/sales/export', '_blank');
}

function registerPayment() {
    console.log('💰 تسجيل دفعة');
    const selected = document.querySelector('input[name="selected_sale"]:checked');
    if (selected) {
        alert('✅ زر تسجيل الدفع يعمل! الفاتورة: ' + selected.value);
        window.location.href = '/payments/new?invoice=' + selected.value;
    } else {
        alert('⚠️ يرجى تحديد فاتورة لتسجيل الدفع أولاً');
    }
}

// ربط الأزرار عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔗 ربط أزرار المبيعات...');

    const addBtn = document.getElementById('btnSalesSave');
    const editBtn = document.getElementById('btnSalesEdit');
    const deleteBtn = document.getElementById('btnSalesDelete');
    const printBtn = document.getElementById('btnSalesPrint');
    const previewBtn = document.getElementById('btnSalesPreview');
    const exportBtn = document.getElementById('btnSalesExport');
    const paymentBtn = document.getElementById('btnSalesPayment');

    if (addBtn) {
        addBtn.addEventListener('click', addSale);
        console.log('✅ تم ربط زر الإضافة');
    }

    if (editBtn) {
        editBtn.addEventListener('click', editSale);
        console.log('✅ تم ربط زر التعديل');
    }

    if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteSale);
        console.log('✅ تم ربط زر الحذف');
    }

    if (printBtn) {
        printBtn.addEventListener('click', printSale);
        console.log('✅ تم ربط زر الطباعة');
    }

    if (previewBtn) {
        previewBtn.addEventListener('click', previewSale);
        console.log('✅ تم ربط زر المعاينة');
    }

    if (exportBtn) {
        exportBtn.addEventListener('click', exportSales);
        console.log('✅ تم ربط زر التصدير');
    }

    if (paymentBtn) {
        paymentBtn.addEventListener('click', registerPayment);
        console.log('✅ تم ربط زر تسجيل الدفع');
    }

    console.log('✅ تم ربط جميع أزرار المبيعات');
    if (document.getElementById('salesButtonResults')) {
        document.getElementById('salesButtonResults').innerHTML = '<div class="badge bg-success">✅ تم ربط أزرار المبيعات</div>';
    }
});

</script>
{% endblock %}
