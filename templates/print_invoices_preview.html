<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± - {{ month }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .print-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .invoice-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .status-paid { background-color: #d4edda; color: #155724; }
        .status-partial { background-color: #fff3cd; color: #856404; }
        .status-pending { background-color: #f8d7da; color: #721c24; }
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-print {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        @media print {
            .btn-print, .no-print { display: none !important; }
            body { background: white !important; }
            .invoice-card { box-shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="print-header text-center">
            <h2><i class="fas fa-file-invoice me-2"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
            <div class="row mt-3">
                <div class="col-md-3">
                    <strong>Ø§Ù„Ù†ÙˆØ¹:</strong>
                    {% if invoice_type == 'sales' %}ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    {% elif invoice_type == 'purchases' %}ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                    {% elif invoice_type == 'expenses' %}ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>Ø§Ù„Ø´Ù‡Ø±:</strong> {{ month_num }}/{{ year }}
                </div>
                <div class="col-md-3">
                    <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
                    {% if status == 'all' %}Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª
                    {% elif status == 'paid' %}Ù…Ø¯ÙÙˆØ¹
                    {% elif status == 'partial' %}Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹
                    {% elif status == 'pending' %}ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ current_date }}
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="summary-card">
            <h5><i class="fas fa-chart-bar me-2"></i>Ù…Ù„Ø®Øµ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h5>
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary">{{ invoices|length }}</h4>
                        <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success">
                            {% set total_amount = invoices|sum(attribute='final_amount' if invoice_type != 'expenses' else 'amount') %}
                            {{ "%.2f"|format(total_amount) }}
                        </h4>
                        <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">
                            {% set paid_invoices = invoices|selectattr('payment_status', 'equalto', 'paid')|list %}
                            {{ paid_invoices|length }}
                        </h4>
                        <small class="text-muted">ÙÙˆØ§ØªÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning">
                            {% set pending_invoices = invoices|selectattr('payment_status', 'equalto', 'pending')|list %}
                            {{ pending_invoices|length }}
                        </h4>
                        <small class="text-muted">ÙÙˆØ§ØªÙŠØ± Ù…Ø¹Ù„Ù‚Ø©</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoices List -->
        <div class="row">
            {% for invoice in invoices %}
            <div class="col-md-6 col-lg-4">
                <div class="invoice-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            {% if invoice_type == 'sales' %}{{ invoice.invoice_number }}
                            {% elif invoice_type == 'purchases' %}{{ invoice.invoice_number }}
                            {% elif invoice_type == 'expenses' %}{{ invoice.expense_number }}
                            {% endif %}
                        </h6>
                        <span class="status-badge status-{{ invoice.payment_status }}">
                            {% if invoice.payment_status == 'paid' %}Ù…Ø¯ÙÙˆØ¹
                            {% elif invoice.payment_status == 'partial' %}Ø¬Ø²Ø¦ÙŠ
                            {% else %}Ù…Ø¹Ù„Ù‚
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="row small">
                        <div class="col-6">
                            <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong><br>
                            {% if invoice_type == 'expenses' %}
                                {{ invoice.expense_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                {{ invoice.invoice_date.strftime('%Y-%m-%d') }}
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong><br>
                            {% if invoice_type == 'expenses' %}
                                {{ "%.2f"|format(invoice.amount) }} Ø±ÙŠØ§Ù„
                            {% else %}
                                {{ "%.2f"|format(invoice.final_amount) }} Ø±ÙŠØ§Ù„
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row small mt-2">
                        <div class="col-6">
                            <strong>
                                {% if invoice_type == 'sales' %}Ø§Ù„Ø¹Ù…ÙŠÙ„:
                                {% elif invoice_type == 'purchases' %}Ø§Ù„Ù…ÙˆØ±Ø¯:
                                {% elif invoice_type == 'expenses' %}Ø§Ù„Ù†ÙˆØ¹:
                                {% endif %}
                            </strong><br>
                            {% if invoice_type == 'sales' %}
                                {{ invoice.customer_name or 'Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ' }}
                            {% elif invoice_type == 'purchases' %}
                                {{ invoice.supplier_name or 'Ù…ÙˆØ±Ø¯' }}
                            {% elif invoice_type == 'expenses' %}
                                {{ invoice.expense_type }}
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong><br>
                            {% if invoice_type == 'expenses' %}
                                {{ invoice.payment_method }}
                            {% else %}
                                {{ invoice.payment_method or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if include_details and invoice.payment_status != 'pending' %}
                    <hr class="my-2">
                    <div class="small">
                        <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹:</strong><br>
                        <div class="text-success">
                            Ù…Ø¯ÙÙˆØ¹: {{ "%.2f"|format(invoice.get_total_paid()) }} Ø±ÙŠØ§Ù„
                        </div>
                        {% if invoice.get_remaining_amount() > 0 %}
                        <div class="text-danger">
                            Ù…ØªØ¨Ù‚ÙŠ: {{ "%.2f"|format(invoice.get_remaining_amount()) }} Ø±ÙŠØ§Ù„
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            
            {% if not invoices %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</h5>
                    <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙÙˆØ§ØªÙŠØ± ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="text-center mt-4 small text-muted no-print">
            <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ {{ current_datetime }}</p>
            <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
        </div>
    </div>

    <!-- Print Buttons -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
        <div class="btn-group-vertical">
            <button class="btn btn-success btn-lg" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Ø·Ø¨Ø§Ø¹Ø©
            </button>
            <button class="btn btn-primary btn-lg mt-2" onclick="downloadPDF()">
                <i class="fas fa-file-pdf me-2"></i>ØªØ­Ù…ÙŠÙ„ PDF
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© jsPDF Ù„Ø¥Ù†ØªØ§Ø¬ Ù…Ù„ÙØ§Øª PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Auto-focus for better UX
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
            console.log('Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:', {{ invoices|length }});
        });
        
        // Print function
        function printReport() {
            window.print();
        }
        
        // Keyboard shortcut for print
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });

        // ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ PDF
        async function downloadPDF() {
            try {
                console.log('ğŸ“„ Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF...');

                // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
                const printButtons = document.querySelector('.position-fixed');
                if (printButtons) printButtons.style.display = 'none';

                // Ø¥Ù†Ø´Ø§Ø¡ PDF Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… html2canvas Ùˆ jsPDF
                const element = document.body;
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF.jsPDF('p', 'mm', 'a4');

                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
                const invoiceType = '{{ invoice_type }}';
                const month = '{{ month }}';
                const status = '{{ status }}';

                const typeNames = {
                    'sales': 'Ù…Ø¨ÙŠØ¹Ø§Øª',
                    'purchases': 'Ù…Ø´ØªØ±ÙŠØ§Øª',
                    'expenses': 'Ù…ØµØ±ÙˆÙØ§Øª',
                    'payroll': 'Ø±ÙˆØ§ØªØ¨'
                };

                const fileName = `ØªÙ‚Ø±ÙŠØ±_${typeNames[invoiceType] || invoiceType}_${month}_${status}.pdf`;

                // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
                pdf.save(fileName);

                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF Ø¨Ù†Ø¬Ø§Ø­:', fileName);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                if (printButtons) printButtons.style.display = 'block';

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF: ' + error.message);

                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                const printButtons = document.querySelector('.position-fixed');
                if (printButtons) printButtons.style.display = 'block';
            }
        }
    </script>
</body>
</html>
