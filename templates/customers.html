{% extends "base_unified.html" %}

{% block title %}
    {% if session.get('language', 'ar') == 'ar' %}
        إدارة العملاء - نظام المحاسبة
    {% else %}
        Customers Management - Accounting System
    {% endif %}
{% endblock %}

{% block page_icon %}<i class="fas fa-users"></i>{% endblock %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}
    إدارة العملاء
{% else %}
    Customers Management
{% endif %}
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
        <i class="fas fa-plus me-1"></i>
        {% if session.get('language', 'ar') == 'ar' %}إضافة عميل{% else %}Add Customer{% endif %}
    </button>
    <button type="button" class="btn btn-success" onclick="exportCustomers()">
        <i class="fas fa-download me-1"></i>
        {% if session.get('language', 'ar') == 'ar' %}تصدير{% else %}Export{% endif %}
    </button>
</div>
{% endblock %}

{% block content %}

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">156</h5>
                <p class="card-text">
                    {% if session.get('language', 'ar') == 'ar' %}إجمالي العملاء{% else %}Total Customers{% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">89</h5>
                <p class="card-text">
                    {% if session.get('language', 'ar') == 'ar' %}عملاء نشطين{% else %}Active Customers{% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">23</h5>
                <p class="card-text">
                    {% if session.get('language', 'ar') == 'ar' %}عملاء جدد هذا الشهر{% else %}New This Month{% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">12,450</h5>
                <p class="card-text">
                    {% if session.get('language', 'ar') == 'ar' %}متوسط قيمة الطلبية{% else %}Avg Order Value{% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="input-group">
            <input type="text" class="form-control" id="searchCustomers" placeholder="{% if session.get('language', 'ar') == 'ar' %}البحث في العملاء...{% else %}Search customers...{% endif %}">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="filterType">
            <option value="">{% if session.get('language', 'ar') == 'ar' %}جميع الأنواع{% else %}All Types{% endif %}</option>
            <option value="individual">{% if session.get('language', 'ar') == 'ar' %}فردي{% else %}Individual{% endif %}</option>
            <option value="corporate">{% if session.get('language', 'ar') == 'ar' %}شركة{% else %}Corporate{% endif %}</option>
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="filterStatus">
            <option value="">{% if session.get('language', 'ar') == 'ar' %}جميع الحالات{% else %}All Status{% endif %}</option>
            <option value="active">{% if session.get('language', 'ar') == 'ar' %}نشط{% else %}Active{% endif %}</option>
            <option value="inactive">{% if session.get('language', 'ar') == 'ar' %}غير نشط{% else %}Inactive{% endif %}</option>
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="sortBy">
            <option value="name">{% if session.get('language', 'ar') == 'ar' %}ترتيب بالاسم{% else %}Sort by Name{% endif %}</option>
            <option value="date">{% if session.get('language', 'ar') == 'ar' %}ترتيب بالتاريخ{% else %}Sort by Date{% endif %}</option>
            <option value="orders">{% if session.get('language', 'ar') == 'ar' %}ترتيب بالطلبيات{% else %}Sort by Orders{% endif %}</option>
        </select>
    </div>
    <div class="col-md-2">
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="toggleView('table')" id="tableViewBtn">
                <i class="fas fa-table"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary active" onclick="toggleView('cards')" id="cardsViewBtn">
                <i class="fas fa-th"></i>
            </button>
        </div>
    </div>
</div>

<!-- Customers Table View -->
<div class="card d-none" id="tableView">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>{% if session.get('language', 'ar') == 'ar' %}الاسم{% else %}Name{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}النوع{% else %}Type{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}الهاتف{% else %}Phone{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}البريد الإلكتروني{% else %}Email{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}عدد الطلبيات{% else %}Orders{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}إجمالي المشتريات{% else %}Total Purchases{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}الحالة{% else %}Status{% endif %}</th>
                        <th>{% if session.get('language', 'ar') == 'ar' %}إجراءات{% else %}Actions{% endif %}</th>
                    </tr>
                </thead>
                <tbody id="customersTableBody">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Customers Cards View -->
<div class="row" id="cardsView">
    <!-- Sample Customer Cards -->
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card customer-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">أحمد محمد السعيد</h6>
                <span class="badge bg-success">نشط</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}النوع:{% else %}Type:{% endif %}
                        </small>
                        <span class="badge bg-primary">فردي</span>
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الهاتف:{% else %}Phone:{% endif %}
                        </small>
                        <br>+966 50 123 4567
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}البريد الإلكتروني:{% else %}Email:{% endif %}
                        </small>
                        <br>ahmed@example.com
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الطلبيات:{% else %}Orders:{% endif %}
                        </small>
                        <br><strong>15</strong>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الإجمالي:{% else %}Total:{% endif %}
                        </small>
                        <br><strong>2,450 ريال</strong>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewCustomer(1)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="editCustomer(1)">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="newOrder(1)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="viewOrders(1)">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card customer-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">شركة الأطعمة المتميزة</h6>
                <span class="badge bg-success">نشط</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}النوع:{% else %}Type:{% endif %}
                        </small>
                        <span class="badge bg-warning">شركة</span>
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الهاتف:{% else %}Phone:{% endif %}
                        </small>
                        <br>+966 11 456 7890
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}البريد الإلكتروني:{% else %}Email:{% endif %}
                        </small>
                        <br>info@foods.com
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الطلبيات:{% else %}Orders:{% endif %}
                        </small>
                        <br><strong>45</strong>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الإجمالي:{% else %}Total:{% endif %}
                        </small>
                        <br><strong>15,750 ريال</strong>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewCustomer(2)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="editCustomer(2)">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="newOrder(2)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="viewOrders(2)">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card customer-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">فاطمة علي الزهراني</h6>
                <span class="badge bg-warning">غير نشط</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}النوع:{% else %}Type:{% endif %}
                        </small>
                        <span class="badge bg-primary">فردي</span>
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الهاتف:{% else %}Phone:{% endif %}
                        </small>
                        <br>+966 55 987 6543
                    </div>
                    <div class="col-12 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}البريد الإلكتروني:{% else %}Email:{% endif %}
                        </small>
                        <br>fatima@example.com
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الطلبيات:{% else %}Orders:{% endif %}
                        </small>
                        <br><strong>8</strong>
                    </div>
                    <div class="col-6 mb-2">
                        <small class="text-muted">
                            {% if session.get('language', 'ar') == 'ar' %}الإجمالي:{% else %}Total:{% endif %}
                        </small>
                        <br><strong>1,200 ريال</strong>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewCustomer(3)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="editCustomer(3)">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="newOrder(3)">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="viewOrders(3)">
                        <i class="fas fa-history"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if session.get('language', 'ar') == 'ar' %}إضافة عميل جديد{% else %}Add New Customer{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}اسم العميل{% else %}Customer Name{% endif %}
                            </label>
                            <input type="text" class="form-control" name="customer_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}نوع العميل{% else %}Customer Type{% endif %}
                            </label>
                            <select class="form-select" name="customer_type" required>
                                <option value="">{% if session.get('language', 'ar') == 'ar' %}اختر النوع{% else %}Select Type{% endif %}</option>
                                <option value="individual">{% if session.get('language', 'ar') == 'ar' %}فردي{% else %}Individual{% endif %}</option>
                                <option value="corporate">{% if session.get('language', 'ar') == 'ar' %}شركة{% else %}Corporate{% endif %}</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}رقم الهاتف{% else %}Phone Number{% endif %}
                            </label>
                            <input type="tel" class="form-control" name="phone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}البريد الإلكتروني{% else %}Email{% endif %}
                            </label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}العنوان{% else %}Address{% endif %}
                            </label>
                            <textarea class="form-control" name="address" rows="3"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}تاريخ الميلاد{% else %}Date of Birth{% endif %}
                            </label>
                            <input type="date" class="form-control" name="birth_date">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}الجنس{% else %}Gender{% endif %}
                            </label>
                            <select class="form-select" name="gender">
                                <option value="">{% if session.get('language', 'ar') == 'ar' %}اختر الجنس{% else %}Select Gender{% endif %}</option>
                                <option value="male">{% if session.get('language', 'ar') == 'ar' %}ذكر{% else %}Male{% endif %}</option>
                                <option value="female">{% if session.get('language', 'ar') == 'ar' %}أنثى{% else %}Female{% endif %}</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}حد الائتمان{% else %}Credit Limit{% endif %}
                            </label>
                            <input type="number" class="form-control" name="credit_limit" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                {% if session.get('language', 'ar') == 'ar' %}نسبة الخصم{% else %}Discount Rate{% endif %}
                            </label>
                            <input type="number" class="form-control" name="discount_rate" step="0.1" min="0" max="100">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% if session.get('language', 'ar') == 'ar' %}إلغاء{% else %}Cancel{% endif %}
                </button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">
                    {% if session.get('language', 'ar') == 'ar' %}حفظ{% else %}Save{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleView(viewType) {
    const tableView = document.getElementById('tableView');
    const cardsView = document.getElementById('cardsView');
    const tableBtn = document.getElementById('tableViewBtn');
    const cardsBtn = document.getElementById('cardsViewBtn');
    
    if (viewType === 'table') {
        tableView.classList.remove('d-none');
        cardsView.classList.add('d-none');
        tableBtn.classList.add('active');
        cardsBtn.classList.remove('active');
    } else {
        tableView.classList.add('d-none');
        cardsView.classList.remove('d-none');
        tableBtn.classList.remove('active');
        cardsBtn.classList.add('active');
    }
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeSearch('searchCustomers', 'customersTable', [1, 2, 3]); // Search in name, phone, email columns
    loadCustomers();
});

function loadCustomers() {
    // This would normally load from server
    console.log('Loading customers...');
}

function viewCustomer(id) {
    showToast(isRTL ? `عرض تفاصيل العميل رقم: ${id}` : `Viewing customer: ${id}`, 'info');
    // This would show customer details in a modal or navigate to details page
}

function editCustomer(id) {
    // This would fetch customer data and populate the modal
    const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
    modal.show();
    showToast(isRTL ? `تعديل العميل رقم: ${id}` : `Editing customer: ${id}`, 'info');
}

function deleteCustomer(id) {
    const message = isRTL ? 'هل أنت متأكد من حذف هذا العميل؟' : 'Are you sure you want to delete this customer?';

    confirmAction(message, function() {
        const deleteBtn = event.target.closest('button');
        showLoading(deleteBtn);

        // Simulate API call
        setTimeout(() => {
            hideLoading(deleteBtn);
            showToast(isRTL ? 'تم حذف العميل بنجاح' : 'Customer deleted successfully', 'success');
            // Remove row from table
            deleteBtn.closest('tr').remove();
        }, 1000);
    });
}

function newOrder(id) {
    // Redirect to new sale page with customer pre-selected
    window.location.href = `/new_sale?customer_id=${id}`;
}

function viewOrders(id) {
    // Redirect to sales page filtered by customer
    window.location.href = `/sales?customer_id=${id}`;
}

function saveCustomer() {
    const form = document.getElementById('customerForm');

    if (!validateForm(form)) {
        showToast(isRTL ? 'يرجى ملء جميع الحقول المطلوبة' : 'Please fill all required fields', 'warning');
        return;
    }

    const saveBtn = document.querySelector('#addCustomerModal .btn-primary');
    showLoading(saveBtn);

    // Simulate API call
    setTimeout(() => {
        hideLoading(saveBtn);
        showToast(isRTL ? 'تم حفظ العميل بنجاح' : 'Customer saved successfully', 'success');

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
        modal.hide();

        // Reload customers
        loadCustomers();
    }, 1000);
}

function exportCustomers() {
    showToast(isRTL ? 'جاري تصدير العملاء...' : 'Exporting customers...', 'info');
    exportToExcel([], 'customers');
}

// Reset modal when closed
document.getElementById('addCustomerModal')?.addEventListener('hidden.bs.modal', function () {
    const form = document.getElementById('customerForm');
    form.reset();
    clearFormValidation(form);
});
</script>
{% endblock %}
