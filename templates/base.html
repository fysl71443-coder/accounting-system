<!DOCTYPE html>
<html lang="{{ session.get('language', 'ar') }}" dir="{{ 'rtl' if session.get('language', 'ar') == 'ar' else 'ltr' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}نظام المحاسبة المتكامل{% endblock %}</title>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Unified Design System -->
    <link href="{{ url_for('static', filename='css/unified-design.css') }}" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- تم نقل جميع الأنماط إلى ملف CSS موحد -->




    
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if session.get('user_id') or request.endpoint in ['dashboard', 'products', 'sales'] %}
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-calculator nav-icon"></i>
                {% if session.get('language', 'ar') == 'ar' %}
                    نظام المحاسبة المتكامل
                {% else %}
                    Integrated Accounting System
                {% endif %}
            </div>
            <div class="sidebar-subtitle">
                {% if session.get('language', 'ar') == 'ar' %}
                    مرحباً {{ session.get('full_name', 'المستخدم') }}
                {% else %}
                    Welcome {{ session.get('full_name', 'User') }}
                {% endif %}
            </div>
        </div>

                <div class="sidebar-nav">
            <!-- لوحة التحكم الرئيسية -->
            <div class="nav-section">
                <a class="nav-link {{ 'active' if request.endpoint == 'dashboard' else '' }}" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-tachometer-alt nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}لوحة التحكم{% else %}Dashboard{% endif %}
                </a>
            </div>

            <!-- الشاشات المتقدمة والمميزة -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}الشاشات المتقدمة{% else %}Advanced Screens{% endif %}
                </div>
                <a class="nav-link featured {{ 'active' if request.endpoint == 'products' else '' }}" href="{{ url_for('products') }}">
                    <i class="fas fa-cogs nav-icon"></i>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600;">
                            {% if session.get('language', 'ar') == 'ar' %}🌟 إدارة المنتجات والتكاليف{% else %}🌟 Products & Costing{% endif %}
                        </div>
                        <small style="opacity: 0.8;">
                            {% if session.get('language', 'ar') == 'ar' %}شاشة موحدة متكاملة{% else %}Integrated unified screen{% endif %}
                        </small>
                    </div>
                    <span class="badge badge-new">
                        {% if session.get('language', 'ar') == 'ar' %}جديد{% else %}NEW{% endif %}
                    </span>
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'cost_calculation' else '' }}" href="{{ url_for('cost_calculation') }}">
                    <i class="fas fa-calculator nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}حساب التكاليف{% else %}Cost Calculation{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'meal_cost_calculator' else '' }}" href="{{ url_for('meal_cost_calculator') }}">
                    <i class="fas fa-utensils nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}حاسبة تكلفة الوجبات{% else %}Meal Cost Calculator{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'advanced_reports' else '' }}" href="{{ url_for('advanced_reports') }}">
                    <i class="fas fa-chart-pie nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}التقارير المتقدمة{% else %}Advanced Reports{% endif %}
                </a>
            </div>

            <!-- المبيعات والفواتير -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}المبيعات والفواتير{% else %}Sales & Invoices{% endif %}
                </div>
                <!-- تم حذف رابط فاتورة جديدة - يمكن إنشاء الفواتير من شاشة المبيعات -->
                <a class="nav-link {{ 'active' if request.endpoint == 'sales' else '' }}" href="{{ url_for('sales') }}">
                    <i class="fas fa-shopping-cart nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المبيعات{% else %}Sales{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'orders' else '' }}" href="{{ url_for('orders') }}">
                    <i class="fas fa-clipboard-list nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}الطلبات{% else %}Orders{% endif %}
                </a>
            </div>

            <!-- إدارة المخزون والمنتجات -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}المخزون والمنتجات{% else %}Inventory & Products{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'products' else '' }}" href="{{ url_for('products') }}">
                    <i class="fas fa-box nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المنتجات{% else %}Products{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'raw_materials' else '' }}" href="{{ url_for('raw_materials') }}">
                    <i class="fas fa-cubes nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المواد الخام{% else %}Raw Materials{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'inventory' else '' }}" href="{{ url_for('inventory') }}">
                    <i class="fas fa-warehouse nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}إدارة المخزون{% else %}Inventory Management{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'product_transfer' else '' }}" href="{{ url_for('product_transfer') }}">
                    <i class="fas fa-exchange-alt nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}نقل المنتجات{% else %}Product Transfer{% endif %}
                </a>
            </div>

            <!-- المشتريات والموردين -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}المشتريات والموردين{% else %}Purchases & Suppliers{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'purchases' else '' }}" href="{{ url_for('purchases') }}">
                    <i class="fas fa-shopping-bag nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المشتريات{% else %}Purchases{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'suppliers' else '' }}" href="{{ url_for('suppliers') }}">
                    <i class="fas fa-truck nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}الموردين{% else %}Suppliers{% endif %}
                </a>
            </div>

            <!-- العملاء والعلاقات -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}العملاء والعلاقات{% else %}Customers & Relations{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'customers' else '' }}" href="{{ url_for('customers') }}">
                    <i class="fas fa-users nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}العملاء{% else %}Customers{% endif %}
                </a>
            </div>

            <!-- المالية والمحاسبة -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}المالية والمحاسبة{% else %}Finance & Accounting{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'expenses' else '' }}" href="{{ url_for('expenses') }}">
                    <i class="fas fa-money-bill-wave nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المصروفات{% else %}Expenses{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'advanced_expenses' else '' }}" href="{{ url_for('advanced_expenses') }}">
                    <i class="fas fa-receipt nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المصروفات المتقدمة{% else %}Advanced Expenses{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'payments_dues' else '' }}" href="{{ url_for('payments_dues') }}">
                    <i class="fas fa-credit-card nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}المدفوعات والمستحقات{% else %}Payments & Dues{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'financial_statements' else '' }}" href="{{ url_for('financial_statements') }}">
                    <i class="fas fa-file-invoice-dollar nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}القوائم المالية{% else %}Financial Statements{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'tax_management' else '' }}" href="{{ url_for('tax_management') }}">
                    <i class="fas fa-percentage nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}إدارة الضرائب{% else %}Tax Management{% endif %}
                </a>
            </div>

            <!-- الموارد البشرية -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}الموارد البشرية{% else %}Human Resources{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'employees' else '' }}" href="{{ url_for('employees') }}">
                    <i class="fas fa-user-tie nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}الموظفين{% else %}Employees{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'payroll' else '' }}" href="{{ url_for('payroll') }}">
                    <i class="fas fa-money-check-alt nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}رواتب الموظفين{% else %}Employee Payroll{% endif %}
                </a>
            </div>

            <!-- التقارير والتحليلات -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}التقارير والتحليلات{% else %}Reports & Analytics{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'reports' else '' }}" href="{{ url_for('reports') }}">
                    <i class="fas fa-chart-bar nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}التقارير{% else %}Reports{% endif %}
                </a>
            </div>

            <!-- الإدارة والإعدادات -->
            <div class="nav-section">
                <div class="nav-section-title">
                    {% if session.get('language', 'ar') == 'ar' %}الإدارة والإعدادات{% else %}Administration & Settings{% endif %}
                </div>
                <a class="nav-link {{ 'active' if request.endpoint == 'user_management' else '' }}" href="{{ url_for('user_management') }}">
                    <i class="fas fa-users-cog nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}إدارة المستخدمين{% else %}User Management{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'role_management' else '' }}" href="{{ url_for('role_management') }}">
                    <i class="fas fa-user-shield nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}إدارة الأدوار{% else %}Role Management{% endif %}
                </a>
                <a class="nav-link {{ 'active' if request.endpoint == 'settings' else '' }}" href="{{ url_for('settings') }}">
                    <i class="fas fa-cog nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}الإعدادات{% else %}Settings{% endif %}
                </a>
            </div>

            <!-- تسجيل الخروج -->
            <div class="nav-section">
                <a class="nav-link" href="{{ url_for('logout') }}" style="color: var(--gray-600);">
                    <i class="fas fa-sign-out-alt nav-icon"></i>
                    {% if session.get('language', 'ar') == 'ar' %}تسجيل الخروج{% else %}Logout{% endif %}
                </a>
            </div>
        </div>
    </div>
    </nav>
    {% endif %}

    <!-- المحتوى الرئيسي -->
    <main class="main-content">
        {% if session.get('user_id') or request.endpoint in ['dashboard', 'products', 'sales'] %}
        <!-- رأس الصفحة -->
        <div class="page-header">
            <h1 class="page-title">
                {% block page_title %}{% if session.get('language', 'ar') == 'ar' %}لوحة التحكم{% else %}Dashboard{% endif %}{% endblock %}
            </h1>
            <p class="page-subtitle">
                {% block page_subtitle %}{% if session.get('language', 'ar') == 'ar' %}إدارة شاملة لنظام المحاسبة{% else %}Comprehensive accounting system management{% endif %}{% endblock %}
            </p>
        </div>

        <!-- محتوى الصفحة -->
        <div class="page-content">
        {% endif %}
            <!-- رسائل التنبيه -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'error' if category == 'error' else category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}

        {% if session.get('user_id') or request.endpoint in ['dashboard', 'products', 'sales'] %}
        </div>
        {% endif %}
    </main>

    <!-- Language Switcher -->
    <div style="position: fixed; top: 20px; left: 20px; z-index: 1050;">
        <div style="display: flex; gap: 8px;">
            <a href="?lang=ar" class="btn btn-sm {{ 'btn-primary' if session.get('language', 'ar') == 'ar' else 'btn-outline' }}">
                العربية
            </a>
            <a href="?lang=en" class="btn btn-sm {{ 'btn-primary' if session.get('language', 'ar') == 'en' else 'btn-outline' }}">
                English
            </a>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // تحسين تجربة المستخدم
        document.addEventListener('DOMContentLoaded', function() {
            // إخفاء التنبيهات تلقائياً
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 3000);

            // تحسين النقر على الروابط
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });
    </script>
    
    {% block extra_js %}{% endblock %}

    <script>
        // إجبار ظهور القائمة الجانبية
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔧 تشغيل إصلاح القائمة الجانبية...');
            
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                // إجبار ظهور القائمة الجانبية
                sidebar.style.display = 'block';
                sidebar.style.visibility = 'visible';
                sidebar.style.opacity = '1';
                
                console.log('✅ تم إجبار ظهور القائمة الجانبية');
                
                // إضافة معالج للنقر على الروابط
                const navLinks = sidebar.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        // إزالة active من جميع الروابط
                        navLinks.forEach(l => l.classList.remove('active'));
                        // إضافة active للرابط المنقور
                        this.classList.add('active');
                    });
                });
                
                // إضافة تأثير hover محسن
                navLinks.forEach(link => {
                    link.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateX(5px)';
                    });
                    
                    link.addEventListener('mouseleave', function() {
                        if (!this.classList.contains('active')) {
                            this.style.transform = 'translateX(0)';
                        }
                    });
                });
            } else {
                console.warn('⚠️ لم يتم العثور على القائمة الجانبية');
            }
            
            // إضافة زر toggle للشاشات الصغيرة
            const toggleButton = document.createElement('button');
            toggleButton.className = 'btn btn-primary d-md-none position-fixed';
            toggleButton.style.cssText = 'top: 10px; right: 10px; z-index: 1050;';
            toggleButton.innerHTML = '<i class="fas fa-bars"></i>';
            toggleButton.onclick = function() {
                if (sidebar) {
                    sidebar.classList.toggle('show');
                }
            };
            document.body.appendChild(toggleButton);
        });
        
        // إصلاح مشاكل التحميل
        window.addEventListener('load', function() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.style.display = 'block';
                console.log('✅ تأكيد ظهور القائمة الجانبية بعد التحميل');
            }
        });
    </script>
    
</body>
</html>
