{% extends "base_unified.html" %}

{% block title %}
{% if session.get('language', 'ar') == 'ar' %}
المصروفات - نظام المحاسبة
{% else %}
Expenses - Accounting System
{% endif %}
{% endblock %}

{% block page_title %}
{% if session.get('language', 'ar') == 'ar' %}
    إدارة المصروفات
{% else %}
    Expenses Management
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .table-responsive {
        border-radius: 0.375rem;
    }
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin: 0 1px;
    }

    /* تحسين مظهر الصف المحدد */
    .table tbody tr.table-active {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }

    .table tbody tr:hover {
        background-color: #f5f5f5;
        cursor: pointer;
    }

    .table tbody tr.table-active:hover {
        background-color: #e3f2fd !important;
    }

    /* تحسين مظهر radio button */
    .table tbody tr input[type="radio"] {
        transform: scale(1.2);
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}

<!-- الإحصائيات -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-primary">{{ summary_data.expenses_count }}</h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}إجمالي المصروفات{% else %}Total Expenses{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-success">{{ "%.2f"|format(summary_data.total_expenses) }} ريال</h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}إجمالي المبلغ{% else %}Total Amount{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning">{{ "%.2f"|format(summary_data.pending_expenses) }} ريال</h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}غير مدفوع{% else %}Unpaid{% endif %}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card text-center">
            <div class="card-body">
                <h5 class="card-title text-info">{{ "%.2f"|format(summary_data.avg_expense) }} ريال</h5>
                <p class="card-text">{% if session.get('language', 'ar') == 'ar' %}متوسط المصروف{% else %}Average Expense{% endif %}</p>
            </div>
        </div>
    </div>
</div>

<!-- جدول المصروفات -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            {% if session.get('language', 'ar') == 'ar' %}
                قائمة المصروفات
            {% else %}
                Expenses List
            {% endif %}
        </h5>
        <!-- أزرار الإجراءات مثل شاشة المبيعات -->
        <div class="btn-group" role="group" aria-label="Expense Actions">
            <button type="button"
                    id="btnExpenseSave"
                    class="btn btn-success btn-sm"
                    title="إضافة مصروف جديد">
                <i class="fas fa-plus me-1"></i>
                إضافة
            </button>

            <!-- الأزرار الرئيسية -->
            <div class="btn-group me-2" role="group">
                <button type="button"
                        id="btnExpensePrint"
                        class="btn btn-primary"
                        title="طباعة قائمة المصروفات">
                    <i class="fas fa-print me-1"></i>
                    طباعة
                </button>
                <button type="button"
                        id="btnExpenseExport"
                        class="btn btn-info"
                        title="تصدير المصروفات">
                    <i class="fas fa-download me-1"></i>
                    تصدير
                </button>
            </div>

            <div class="btn-group" role="group">
                <button type="button"
                        id="btnExpenseEdit"
                        class="btn btn-warning"
                        title="تعديل المصروف المحدد">
                    <i class="fas fa-edit me-1"></i>
                    تعديل
                </button>
                <button type="button"
                        id="btnExpenseDelete"
                        class="btn btn-danger"
                        title="حذف المصروف المحدد">
                    <i class="fas fa-trash me-1"></i>
                    حذف
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="buttonResults" class="mb-3"></div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>تحديد</th>
                                <th>رقم المصروف</th>
                                <th>التاريخ</th>
                                <th>الوصف</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                            <tr>
                                <td>
                                    <input type="radio" name="selected_expense" value="{{ expense.id }}" 
                                           data-expense-number="{{ expense.expense_number }}">
                                </td>
                                <td>{{ expense.expense_number }}</td>
                                <td>{{ expense.date.strftime('%Y-%m-%d') if expense.date else '-' }}</td>
                                <td>{{ expense.description }}</td>
                                <td class="text-end">{{ "%.2f"|format(expense.amount) }} ريال</td>
                                <td>
                                    {% if expense.payment_status == 'paid' %}
                                        <span class="badge bg-success">مدفوع</span>
                                    {% else %}
                                        <span class="badge bg-danger">غير مدفوع</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="payExpense({{ expense.id }})">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل مصروف -->
    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة مصروف جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenseNumber" class="form-label">رقم المصروف</label>
                                    <input type="text" class="form-control" id="expenseNumber" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenseDate" class="form-label">التاريخ</label>
                                    <input type="date" class="form-control" id="expenseDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="expenseDescription" class="form-label">وصف المصروف</label>
                            <input type="text" class="form-control" id="expenseDescription" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenseAmount" class="form-label">المبلغ (ريال)</label>
                                    <input type="number" class="form-control" id="expenseAmount" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expenseCategory" class="form-label">الفئة</label>
                                    <select class="form-control" id="expenseCategory">
                                        <option value="مرافق">مرافق</option>
                                        <option value="إيجار">إيجار</option>
                                        <option value="مكتبية">مكتبية</option>
                                        <option value="صيانة">صيانة</option>
                                        <option value="مواصلات">مواصلات</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="expenseVendor" class="form-label">المورد/الجهة</label>
                            <input type="text" class="form-control" id="expenseVendor">
                        </div>

                        <div class="mb-3">
                            <label for="expenseNotes" class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="expenseNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success" id="saveExpenseBtn">حفظ المصروف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        console.log('🚀 بدء تحميل صفحة المصروفات الجديدة...');
        
        // دوال بسيطة تعمل
        function addExpense() {
            console.log('➕ زر الإضافة');

            try {
                // البحث عن النموذج
                const modal = document.getElementById('expenseModal');
                if (!modal) {
                    alert('❌ نموذج المصروف غير موجود!');
                    return;
                }

                // مسح النموذج
                const form = document.getElementById('expenseForm');
                if (form) {
                    form.reset();
                }

                // تعيين التاريخ الحالي
                const dateInput = document.getElementById('expenseDate');
                if (dateInput) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }

                // تعيين رقم مصروف تلقائي
                const numberInput = document.getElementById('expenseNumber');
                if (numberInput) {
                    numberInput.value = 'سيتم إنشاؤه تلقائياً';
                }

                // فتح النموذج
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();

                console.log('✅ تم فتح نموذج إضافة مصروف');
                document.getElementById('buttonResults').innerHTML += '<div class="badge bg-success me-1">✅ فتح النموذج</div>';

            } catch (error) {
                console.error('❌ خطأ في فتح النموذج:', error);
                alert('خطأ في فتح نموذج المصروف: ' + error.message);
            }
        }
        
        function editExpense() {
            console.log('✏️ زر التعديل');
            
            const selected = document.querySelector('input[name="selected_expense"]:checked');
            if (selected) {
                alert('✅ زر التعديل يعمل! المصروف المحدد: ' + selected.value);
                document.getElementById('buttonResults').innerHTML += '<div class="badge bg-warning me-1">✅ تعديل</div>';
                
                // يمكن إضافة كود التعديل هنا
                window.location.href = '/expenses/edit/' + selected.value;
            } else {
                alert('⚠️ يرجى تحديد مصروف للتعديل أولاً');
            }
        }
        
        function deleteExpense() {
            console.log('🗑️ زر الحذف');

            const selected = document.querySelector('input[name="selected_expense"]:checked');
            if (selected) {
                const expenseId = selected.value;
                const expenseNumber = selected.dataset.expenseNumber || expenseId;

                if (confirm(`هل أنت متأكد من حذف المصروف ${expenseNumber}؟\n\nلا يمكن التراجع عن هذا الإجراء!`)) {
                    console.log('🚀 بدء حذف المصروف:', expenseId);
                    document.getElementById('buttonResults').innerHTML += '<div class="badge bg-warning me-1">⏳ جاري الحذف...</div>';

                    // إرسال طلب الحذف الفعلي
                    fetch(`/api/expenses/delete/${expenseId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        console.log('📡 استجابة الخادم:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('📨 بيانات الاستجابة:', data);
                        if (data.success) {
                            alert(`✅ تم حذف المصروف ${expenseNumber} بنجاح!`);
                            document.getElementById('buttonResults').innerHTML += '<div class="badge bg-success me-1">✅ تم الحذف</div>';

                            // إعادة تحميل الصفحة لتحديث البيانات
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            alert('❌ فشل حذف المصروف: ' + (data.message || 'خطأ غير معروف'));
                            document.getElementById('buttonResults').innerHTML += '<div class="badge bg-danger me-1">❌ فشل الحذف</div>';
                        }
                    })
                    .catch(error => {
                        console.error('❌ خطأ في حذف المصروف:', error);
                        alert('❌ خطأ في حذف المصروف: ' + error.message);
                        document.getElementById('buttonResults').innerHTML += '<div class="badge bg-danger me-1">❌ خطأ</div>';
                    });
                }
            } else {
                alert('⚠️ يرجى تحديد مصروف للحذف أولاً');
            }
        }
        
        function exportExpenses() {
            console.log('📥 زر التصدير');
            alert('✅ زر التصدير يعمل!');
            document.getElementById('buttonResults').innerHTML += '<div class="badge bg-info me-1">✅ تصدير</div>';
            
            // يمكن إضافة كود التصدير هنا
            window.open('/api/expenses/export', '_blank');
        }
        
        function printExpenses() {
            console.log('🖨️ زر الطباعة');
            alert('✅ زر الطباعة يعمل!');
            document.getElementById('buttonResults').innerHTML += '<div class="badge bg-secondary me-1">✅ طباعة</div>';
            
            // يمكن إضافة كود الطباعة هنا
            window.print();
        }
        
        function payExpense(expenseId) {
            console.log('💰 دفع المصروف:', expenseId);
            alert('سيتم فتح صفحة دفع المصروف رقم: ' + expenseId);
            window.location.href = '/payments/new?expense=' + expenseId;
        }

        // دالة حفظ المصروف
        function saveExpense() {
            console.log('💾 حفظ المصروف');

            const form = document.getElementById('expenseForm');
            const formData = new FormData();

            // جمع بيانات النموذج
            formData.append('description', document.getElementById('expenseDescription').value);
            formData.append('amount', document.getElementById('expenseAmount').value);
            formData.append('date', document.getElementById('expenseDate').value);
            formData.append('category', document.getElementById('expenseCategory').value);
            formData.append('vendor', document.getElementById('expenseVendor').value);
            formData.append('notes', document.getElementById('expenseNotes').value);

            // إرسال البيانات
            fetch('/api/expenses/create', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ تم حفظ المصروف بنجاح!');

                    // إغلاق النموذج
                    const modal = bootstrap.Modal.getInstance(document.getElementById('expenseModal'));
                    modal.hide();

                    // إعادة تحميل الصفحة
                    location.reload();
                } else {
                    alert('❌ فشل حفظ المصروف: ' + data.message);
                }
            })
            .catch(error => {
                console.error('❌ خطأ في حفظ المصروف:', error);
                alert('❌ خطأ في حفظ المصروف');
            });
        }
        
        // ربط الأزرار عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔗 ربط الأزرار الجديدة...');

            // ربط الأزرار بالأسماء الجديدة
            const addBtn = document.getElementById('btnExpenseSave');
            const editBtn = document.getElementById('btnExpenseEdit');
            const deleteBtn = document.getElementById('btnExpenseDelete');
            const exportBtn = document.getElementById('btnExpenseExport');
            const printBtn = document.getElementById('btnExpensePrint');
            const saveBtn = document.getElementById('saveExpenseBtn');

            if (addBtn) {
                addBtn.addEventListener('click', addExpense);
                console.log('✅ تم ربط زر الإضافة');
            }

            if (editBtn) {
                editBtn.addEventListener('click', editExpense);
                console.log('✅ تم ربط زر التعديل');
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', deleteExpense);
                console.log('✅ تم ربط زر الحذف');
            }

            if (exportBtn) {
                exportBtn.addEventListener('click', exportExpenses);
                console.log('✅ تم ربط زر التصدير');
            }

            if (printBtn) {
                printBtn.addEventListener('click', printExpenses);
                console.log('✅ تم ربط زر الطباعة');
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveExpense);
                console.log('✅ تم ربط زر الحفظ');
            }

            console.log('✅ تم ربط جميع الأزرار');
            document.getElementById('buttonResults').innerHTML = '<div class="badge bg-success">✅ تم ربط الأزرار</div>';
        });
    </script>
{% endblock %}

{% block scripts %}
<script>
// إضافة أي سكريبت إضافي هنا إذا لزم الأمر
console.log('📋 شاشة المصروفات جاهزة');
</script>
{% endblock %}
