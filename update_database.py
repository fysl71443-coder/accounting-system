#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø³ÙƒØ±ÙŠØ¨Øª ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
Database Update Script
"""

import sqlite3
import os
from datetime import datetime

def backup_database():
    """Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    if os.path.exists('accounting.db'):
        backup_name = f'accounting_backup_{datetime.now().strftime("%Y%m%d_%H%M%S")}.db'
        import shutil
        shutil.copy2('accounting.db', backup_name)
        print(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_name}")
        return backup_name
    return None

def update_database_schema():
    """ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    conn = sqlite3.connect('accounting.db')
    cursor = conn.cursor()
    
    try:
        print("ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
        
        # 1. Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS suppliers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name VARCHAR(200) NOT NULL,
                phone VARCHAR(20),
                email VARCHAR(100),
                address TEXT,
                tax_number VARCHAR(50),
                contact_person VARCHAR(100),
                credit_limit FLOAT DEFAULT 0.0,
                is_active BOOLEAN DEFAULT 1,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø¬Ø§Ù‡Ø²")
        
        # 2. Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS purchase_items (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                purchase_id INTEGER NOT NULL,
                product_id INTEGER,
                product_name VARCHAR(200) NOT NULL,
                quantity FLOAT NOT NULL,
                unit_price FLOAT NOT NULL,
                total_price FLOAT NOT NULL,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (purchase_id) REFERENCES purchases (id),
                FOREIGN KEY (product_id) REFERENCES products (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø§Ù‡Ø²")
        
        # 3. ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        cursor.execute("PRAGMA table_info(purchases)")
        columns = [column[1] for column in cursor.fetchall()]
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        if 'supplier_id' not in columns:
            cursor.execute('ALTER TABLE purchases ADD COLUMN supplier_id INTEGER')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ supplier_id")
            
        if 'subtotal' not in columns:
            cursor.execute('ALTER TABLE purchases ADD COLUMN subtotal FLOAT DEFAULT 0.0')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ subtotal")
            
        if 'discount_amount' not in columns:
            cursor.execute('ALTER TABLE purchases ADD COLUMN discount_amount FLOAT DEFAULT 0.0')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ discount_amount")
            
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if 'total_amount' in columns:
            # Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† total_amount Ø¥Ù„Ù‰ subtotal Ø¥Ø°Ø§ ÙƒØ§Ù† subtotal ÙØ§Ø±ØºØ§Ù‹
            cursor.execute('''
                UPDATE purchases 
                SET subtotal = total_amount 
                WHERE subtotal IS NULL OR subtotal = 0
            ''')
            print("âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† total_amount Ø¥Ù„Ù‰ subtotal")
        
        # 4. ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        cursor.execute("PRAGMA table_info(sales)")
        sales_columns = [column[1] for column in cursor.fetchall()]
        
        if 'subtotal' not in sales_columns:
            cursor.execute('ALTER TABLE sales ADD COLUMN subtotal FLOAT DEFAULT 0.0')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ subtotal Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª")
            
        if 'discount_amount' not in sales_columns:
            cursor.execute('ALTER TABLE sales ADD COLUMN discount_amount FLOAT DEFAULT 0.0')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ discount_amount Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª")
        
        # 5. Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS sale_items (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                sale_id INTEGER NOT NULL,
                product_id INTEGER,
                product_name VARCHAR(200) NOT NULL,
                quantity FLOAT NOT NULL,
                unit_price FLOAT NOT NULL,
                total_price FLOAT NOT NULL,
                tax_rate FLOAT DEFAULT 15.0,
                tax_amount FLOAT DEFAULT 0.0,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (sale_id) REFERENCES sales (id),
                FOREIGN KEY (product_id) REFERENCES products (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¬Ø§Ù‡Ø²")
        
        # 6. Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS payments (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                payment_number VARCHAR(50) UNIQUE NOT NULL,
                payment_date DATE NOT NULL,
                amount FLOAT NOT NULL,
                payment_method VARCHAR(20),
                reference_number VARCHAR(100),
                notes TEXT,
                created_by INTEGER,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (created_by) REFERENCES users (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¬Ø§Ù‡Ø²")
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS payment_sales (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                payment_id INTEGER NOT NULL,
                sale_id INTEGER NOT NULL,
                applied_amount FLOAT NOT NULL,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (payment_id) REFERENCES payments (id),
                FOREIGN KEY (sale_id) REFERENCES sales (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø±Ø¨Ø· Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø¬Ø§Ù‡Ø²")
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS payment_purchases (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                payment_id INTEGER NOT NULL,
                purchase_id INTEGER NOT NULL,
                applied_amount FLOAT NOT NULL,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (payment_id) REFERENCES payments (id),
                FOREIGN KEY (purchase_id) REFERENCES purchases (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø±Ø¨Ø· Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¬Ø§Ù‡Ø²")
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS payment_expenses (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                payment_id INTEGER NOT NULL,
                expense_id INTEGER NOT NULL,
                applied_amount FLOAT NOT NULL,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (payment_id) REFERENCES payments (id),
                FOREIGN KEY (expense_id) REFERENCES expenses (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø±Ø¨Ø· Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¬Ø§Ù‡Ø²")
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS payment_payrolls (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                payment_id INTEGER NOT NULL,
                payroll_id INTEGER NOT NULL,
                applied_amount FLOAT NOT NULL,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (payment_id) REFERENCES payments (id),
                FOREIGN KEY (payroll_id) REFERENCES employee_payrolls (id)
            )
        ''')
        print("âœ… Ø¬Ø¯ÙˆÙ„ Ø±Ø¨Ø· Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¬Ø§Ù‡Ø²")
        
        # 7. Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        # Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        cursor.execute("SELECT COUNT(*) FROM branches")
        if cursor.fetchone()[0] == 0:
            cursor.execute('''
                INSERT INTO branches (branch_code, branch_name, branch_name_en, is_active)
                VALUES ('MAIN', 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Main Branch', 1)
            ''')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ")
        
        # Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
        cursor.execute("SELECT COUNT(*) FROM suppliers")
        if cursor.fetchone()[0] == 0:
            cursor.execute('''
                INSERT INTO suppliers (name, phone, email, is_active)
                VALUES ('Ù…ÙˆØ±Ø¯ Ø¹Ø§Ù…', '0500000000', 'supplier@example.com', 1)
            ''')
            print("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ")
        
        conn.commit()
        print("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
        
    except Exception as e:
        conn.rollback()
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        raise
    finally:
        conn.close()

def main():
    """Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    print("=" * 60)
    print("ğŸ—ƒï¸ Ø£Ø¯Ø§Ø© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Database Update Tool")
    print("=" * 60)
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    backup_file = backup_database()
    
    try:
        # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        update_database_schema()
        
        print("\n" + "=" * 60)
        print("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
        print("âœ… Database updated successfully!")
        if backup_file:
            print(f"ğŸ“ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_file}")
            print(f"ğŸ“ Backup file: {backup_file}")
        print("=" * 60)
        
    except Exception as e:
        print(f"\nâŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        print(f"âŒ Failed to update database: {e}")
        if backup_file:
            print(f"ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {backup_file}")
            print(f"ğŸ’¡ You can restore from backup: {backup_file}")

if __name__ == "__main__":
    main()
